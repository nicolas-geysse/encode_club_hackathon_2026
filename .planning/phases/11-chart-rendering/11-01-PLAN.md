---
phase: 11-chart-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/src/components/chat/OnboardingChat.tsx
  - packages/frontend/src/routes/api/chat.ts
autonomous: true

must_haves:
  truths:
    - "Clicking Budget quick link shows Monthly Budget Breakdown bar chart"
    - "Clicking Goals quick link shows Goal Projection chart"
    - "Clicking Energy quick link shows Energy Timeline line chart (or 'no data' message)"
    - "4th quick link 'Savings' is visible and shows Savings Progress line chart"
    - "All chart responses include uiResource with type 'chart'"
  artifacts:
    - path: "packages/frontend/src/components/chat/OnboardingChat.tsx"
      provides: "QUICK_LINKS array with 4 entries and chartActionMap in handleUIAction"
      contains: "savings"
    - path: "packages/frontend/src/routes/api/chat.ts"
      provides: "Direct action parsing for __action: prefix"
      contains: "__action:"
  key_links:
    - from: "OnboardingChat.tsx handleUIAction show_chart"
      to: "chat.ts POST handler"
      via: "fetch /api/chat with __action: prefix message"
      pattern: "__action:show_.*_chart"
    - from: "chat.ts __action: parser"
      to: "handleConversationMode with synthetic intent"
      via: "providedIntent parameter bypasses detectIntent()"
      pattern: "message.startsWith\\('__action:'\\)"
---

<objective>
Fix quick links to render actual chart visualizations instead of text-only responses, and add the missing 4th Savings quick link.

Purpose: Quick links are the primary way users access their financial charts after onboarding. Currently broken - shows only text responses instead of interactive charts.

Output: Working chart visualizations for all 4 quick links (Budget, Goals, Energy, Savings)
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files for this fix:
@packages/frontend/src/components/chat/OnboardingChat.tsx (QUICK_LINKS array, handleUIAction)
@packages/frontend/src/routes/api/chat.ts (handleConversationMode, chart action handlers)
@packages/frontend/src/lib/chatChartBuilder.ts (chart building functions - reference only)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 4th Savings quick link and fix chartType-to-action mapping</name>
  <files>packages/frontend/src/components/chat/OnboardingChat.tsx</files>
  <action>
1. Update the QUICK_LINKS array (around line 42) to add the 4th "Savings" entry:
   ```typescript
   const QUICK_LINKS = [
     { label: 'Budget', chartType: 'budget_breakdown', icon: 'wallet' },
     { label: 'Goals', chartType: 'projection', icon: 'target' },
     { label: 'Energy', chartType: 'energy', icon: 'zap' },
     { label: 'Savings', chartType: 'progress', icon: 'piggy-bank' },
   ] as const;
   ```
   Note: Changed 'Goals' chartType from 'progress' to 'projection' to show Goal Projection chart (more relevant for goal tracking).

2. Add PiggyBank icon to the quickLinkIcons map (around line 48):
   - Import `Banknote` or `PiggyBank` from lucide-solid (use Banknote if PiggyBank not available)
   - Add to quickLinkIcons: `'piggy-bank': Banknote` (or appropriate icon)

3. Update handleUIAction case 'show_chart' (around line 707) to use direct chart action mapping instead of text messages:
   ```typescript
   case 'show_chart': {
     const chartData = data as { chartType?: string };
     const chartType = chartData?.chartType;
     if (chartType) {
       logger.info('Chart button clicked', { chartType });

       // Map chartType directly to chat API action
       const chartActionMap: Record<string, string> = {
         budget_breakdown: 'show_budget_chart',
         progress: 'show_progress_chart',
         projection: 'show_projection_chart',
         energy: 'show_energy_chart',
         comparison: 'show_comparison_chart',
       };

       const action = chartActionMap[chartType] || 'show_chart_gallery';

       // Add user message showing what was requested
       setMessages((prev) => [
         ...prev,
         {
           id: `user-chart-${Date.now()}`,
           role: 'user',
           content: `Show me my ${chartType.replace('_', ' ')} chart`,
           source: 'fallback',
         },
       ]);

       // Call API with explicit action to bypass intent detection
       setLoading(true);
       fetch('/api/chat', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({
           message: `__action:${action}`, // Special prefix for direct action
           step: step(),
           mode: 'conversation',
           context: profile(),
           threadId: threadId(),
           profileId: profileId(),
         }),
       })
       // ... rest unchanged
     }
     break;
   }
   ```

The key fix: Instead of sending a text message that needs intent detection, send a message with `__action:` prefix that chat.ts can parse directly to the correct action.
  </action>
  <verify>
Run `pnpm typecheck` to ensure no TypeScript errors.
Check that QUICK_LINKS has 4 entries and handleUIAction has the chartActionMap.
  </verify>
  <done>
QUICK_LINKS has 4 entries (Budget, Goals, Energy, Savings) with correct chartType values.
handleUIAction sends direct actions via `__action:` prefix instead of relying on intent detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add direct action parsing in chat.ts</name>
  <files>packages/frontend/src/routes/api/chat.ts</files>
  <action>
Add direct action parsing at the beginning of the POST handler (around line 450, after slash command check):

```typescript
// Check for direct action prefix (from quick links)
if (message.startsWith('__action:')) {
  const directAction = message.slice('__action:'.length);
  logger.info('Direct action received', { action: directAction });

  // Create a synthetic intent for the action
  const syntheticIntent: DetectedIntent = {
    mode: 'conversation',
    action: directAction,
    _matchedPattern: 'direct_action',
  };

  // Route to conversation mode handler with the direct action
  const directResult = await handleConversationMode(
    message,
    'conversation',
    context,
    threadId,
    profileId,
    timeContext,
    syntheticIntent // Pass intent directly to skip detection
  );

  return new Response(JSON.stringify(directResult), {
    status: 200,
    headers: { 'Content-Type': 'application/json' },
  });
}
```

Then update handleConversationMode signature to accept an optional intent parameter:

```typescript
async function handleConversationMode(
  message: string,
  mode: ChatMode,
  context: Record<string, unknown>,
  threadId?: string,
  profileId?: string,
  timeContext?: {...},
  providedIntent?: DetectedIntent  // NEW: optional intent to skip detection
): Promise<ChatResponse> {
  // ... existing setup code ...

  // Use provided intent or detect from message
  const intent = providedIntent || await detectIntent(message, context, {
    groqClient: getGroqClient() || undefined,
    mode: mode,
    currentStep: 'conversation',
  });

  // ... rest unchanged
}
```

This allows quick links to bypass intent detection entirely and directly trigger the chart action.
  </action>
  <verify>
Run `pnpm typecheck` to ensure type safety.
Grep for `__action:` to confirm the pattern is handled.
  </verify>
  <done>
chat.ts parses `__action:` prefix and routes directly to handleConversationMode with synthetic intent.
handleConversationMode accepts optional providedIntent parameter.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify MCPUIRenderer handles chart type correctly</name>
  <files>packages/frontend/src/components/chat/MCPUIRenderer.tsx</files>
  <action>
Verify that MCPUIRenderer has proper handling for chart UIResource type. Based on code review, it already has:

1. ChartResource component that handles bar, line, and comparison chart types
2. ChartPlaceholder alias that delegates to ChartResource
3. Match clause for type === 'chart' in ResourceRenderer

No changes needed if the above is in place. If any issues found:
- Ensure ChartResource handles all chart types from chatChartBuilder.ts
- Ensure data structure matches Chart.js expectations
- Verify backgroundColor/borderColor arrays are properly formatted

Run a quick verification:
```bash
grep -n "type === 'chart'" packages/frontend/src/components/chat/MCPUIRenderer.tsx
grep -n "ChartResource" packages/frontend/src/components/chat/MCPUIRenderer.tsx
```

Expected: Line 110 has `Match when={props.resource.type === 'chart'}` and ChartResource/ChartPlaceholder components exist.
  </action>
  <verify>
Run the grep commands to confirm chart handling exists.
Verify ChartResource handles 'bar', 'line', 'comparison' types.
  </verify>
  <done>
MCPUIRenderer correctly handles chart UIResource type with ChartResource component.
No changes needed (verification only).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `pnpm typecheck` passes
2. Lint passes: `pnpm lint` (warnings acceptable)
3. Manual test: Start dev server, complete onboarding, click each quick link:
   - Budget -> Shows bar chart with Income/Expenses/Savings
   - Goals -> Shows projection chart (or comparison chart)
   - Energy -> Shows line chart with energy timeline (or "no data" message)
   - Savings -> Shows line chart with savings progression
4. Each chart response includes visible Chart.js visualization, not just text
</verification>

<success_criteria>
- [ ] QUICK_LINKS has exactly 4 entries
- [ ] All 4 quick links render chart visualizations when clicked
- [ ] Charts are interactive (Chart.js rendered, not static)
- [ ] No TypeScript errors
- [ ] No console errors during chart display
</success_criteria>

<output>
After completion, create `.planning/phases/11-chart-rendering/11-01-SUMMARY.md`
</output>
