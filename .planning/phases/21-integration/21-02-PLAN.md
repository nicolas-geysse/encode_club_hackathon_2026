---
phase: 21-integration
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - packages/frontend/src/components/tabs/GoalsTab.tsx
autonomous: true

must_haves:
  truths:
    - "GoalsTab uses useGoalData hook for data orchestration"
    - "GoalsTab is reduced by 200+ lines (data logic moved to hook)"
    - "weeklyEarnings computed from hook earnings() not from followupData directly"
    - "WeeklyProgressCards and EarningsChart receive data via props from hook"
  artifacts:
    - path: "packages/frontend/src/components/tabs/GoalsTab.tsx"
      provides: "Simplified GoalsTab using useGoalData hook"
      min_lines: -200
  key_links:
    - from: "packages/frontend/src/components/tabs/GoalsTab.tsx"
      to: "packages/frontend/src/hooks/useGoalData.ts"
      via: "import and call useGoalData"
      pattern: "useGoalData\\("
---

<objective>
Simplify GoalsTab by using the useGoalData hook for all goal data orchestration.

Purpose: Reduce GoalsTab from ~2000 lines by extracting data logic to the hook, making the component focused on UI layout only.

Output: GoalsTab.tsx that uses useGoalData for data and passes props down to child components.
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-integration/21-01-SUMMARY.md
@packages/frontend/src/hooks/useGoalData.ts
@packages/frontend/src/components/tabs/GoalsTab.tsx
@packages/frontend/src/components/WeeklyProgressCards.tsx
@packages/frontend/src/components/EarningsChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate useGoalData hook into GoalsTab</name>
  <files>packages/frontend/src/components/tabs/GoalsTab.tsx</files>
  <action>
Refactor GoalsTab.tsx to use the useGoalData hook as the single source of truth for goal data.

**Step 1: Add hook import and initialization**

At the top of the component (after existing imports):
```typescript
import { useGoalData } from '~/hooks/useGoalData';
```

Inside the component, after `const context = useProfile();`:
```typescript
// Get the active goal as an accessor
const activeGoal = createMemo(() => goals().find((g) => g.status === 'active'));

// Use centralized hook for goal data
const goalData = useGoalData(
  activeGoal,
  profile,
  { includeSimulation: false }
);
```

**Step 2: Remove duplicated data fetching**

DELETE or comment out these sections (they're now handled by the hook):

1. Lines ~177-190: The `weeklyEarnings` createMemo that transforms missions
   - BEFORE: transforms followupData.missions to weeklyEarnings manually
   - AFTER: use goalData.earnings() transformed to the format needed

2. Lines ~193-216: The `budgetData` createResource and `oneTimeGains` function
   - KEEP if used elsewhere in the component for non-goal purposes
   - If only used for goal progress, the hook now handles this

3. Lines ~918-985: The inline createEffect that fetches retroplan for feasibility
   - The hook now fetches retroplan; extract feasibilityScore from goalData.retroplan()

**Step 3: Replace data sources with hook data**

For `WeeklyProgressCards` props (around line 1255-1267):
```typescript
<WeeklyProgressCards
  goal={goals().find((g) => g.id === goalId)!}
  currency={currency()}
  hourlyRate={profile()?.minHourlyRate}
  weeklyEarnings={transformEarningsToWeekly(goalData.earnings())}  // NEW
  simulatedDate={props.simulatedDate}
  incomeDay={profile()?.incomeDay}
  monthlyMargin={monthlyMargin()}
  savingsAdjustments={followupData()?.savingsAdjustments}
  onAdjustSavings={handleOpenSavingsAdjust}
  userId={profileId() || undefined}
/>
```

Add a helper function to transform EarningEvent[] to the format WeeklyProgressCards expects:
```typescript
// Helper to transform EarningEvent[] to weekly format for cards
const transformEarningsToWeekly = (events: EarningEvent[]): Array<{ week: number; earned: number }> => {
  const weekMap = new Map<number, number>();
  for (const event of events) {
    const current = weekMap.get(event.weekNumber) || 0;
    weekMap.set(event.weekNumber, current + event.amount);
  }
  return Array.from(weekMap.entries())
    .map(([week, earned]) => ({ week, earned }))
    .sort((a, b) => a.week - b.week);
};
```

For `EarningsChart` props (around line 1279-1285):
```typescript
<EarningsChart
  goal={goals().find((g) => g.id === goalId)!}
  currency={currency()}
  weeklyEarnings={transformEarningsToChartFormat(goalData.earnings())}  // NEW
  adjustedWeeklyTarget={goalData.stats().weeklyTarget}  // From hook stats
  currentSaved={goalData.stats().totalEarned}  // From hook stats
/>
```

**Step 4: Update feasibility display**

Replace the inline feasibility fetch (lines ~918-985) with hook data:
```typescript
// Replace signal declarations
const feasibility = () => goalData.retroplan()?.feasibilityScore ?? null;
const riskFactors = () => goalData.retroplan()?.riskFactors ?? [];
const maxEarnings = createMemo(() => {
  const milestones = goalData.retroplan()?.milestones;
  if (!milestones) return null;
  return Math.round(milestones.reduce((sum, m) => sum + (m.capacity?.maxEarningPotential || 0), 0));
});
const avgAdjustedTarget = createMemo(() => {
  const milestones = goalData.retroplan()?.milestones;
  if (!milestones) return null;
  const targets = milestones.map(m => m.adjustedTarget).filter(t => t > 0);
  if (targets.length === 0) return null;
  return Math.round(targets.reduce((a, b) => a + b, 0) / targets.length);
});
```

**Step 5: Cleanup**

- Remove any unused imports that were only needed for the deleted code
- Keep all form logic, edit handlers, delete handlers, etc. (those aren't data orchestration)
- Keep the UI rendering logic intact

**Expected line reduction:**
- ~13 lines from weeklyEarnings memo removal
- ~24 lines from budgetData resource and oneTimeGains removal (if not used elsewhere)
- ~68 lines from inline feasibility fetch removal
- ~100+ lines from simplified data passing
- **Total: ~200+ lines reduced**
  </action>
  <verify>
1. TypeScript compiles: `cd packages/frontend && pnpm typecheck`
2. Count line reduction: `wc -l packages/frontend/src/components/tabs/GoalsTab.tsx` (should be ~1800 or less, down from ~2000)
  </verify>
  <done>
GoalsTab.tsx uses useGoalData hook, is reduced by 200+ lines, and passes hook data to child components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update weeklyEarnings transformation for correct week attribution</name>
  <files>packages/frontend/src/components/tabs/GoalsTab.tsx</files>
  <action>
The transformEarningsToWeekly function must correctly attribute earnings to their proper weeks.

Ensure the transformation:
1. Groups earnings by weekNumber (already provided by EarningEvent from hook)
2. Sums amounts for each week
3. Returns format expected by WeeklyProgressCards: `Array<{ week: number; earned: number }>`

The key improvement over the old code:
- OLD: All mission earnings attributed to "currentWeek" (line 186-188)
- NEW: Each earning attributed to its actual weekNumber from EarningEvent

Also create transformEarningsToChartFormat for EarningsChart:
```typescript
const transformEarningsToChartFormat = (events: EarningEvent[]): WeeklyEarning[] => {
  const weekMap = new Map<number, number>();
  let cumulative = 0;

  for (const event of events) {
    const current = weekMap.get(event.weekNumber) || 0;
    weekMap.set(event.weekNumber, current + event.amount);
  }

  // Convert to sorted array with cumulative
  const weeks = Array.from(weekMap.keys()).sort((a, b) => a - b);
  return weeks.map(week => {
    const earned = weekMap.get(week) || 0;
    cumulative += earned;
    return {
      week,
      weekLabel: `W${week}`,
      earned,
      cumulative,
    };
  });
};
```

This ensures:
- EARN-01: Chart displays monthly savings at correct weeks (via hook earnings)
- EARN-02: Chart displays completed trades at their completion date (via hook earnings)
- EARN-03: Missions attributed to correct week (via completedAt/updatedAt in aggregator)
  </action>
  <verify>
`grep -n "transformEarningsToWeekly\|transformEarningsToChartFormat" packages/frontend/src/components/tabs/GoalsTab.tsx` shows both functions exist
  </verify>
  <done>
Earnings transformation functions correctly attribute earnings to their proper weeks based on actual dates.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/frontend && pnpm typecheck` passes
2. `cd packages/frontend && pnpm lint` passes
3. GoalsTab line count is ~200 less than before (~1800 vs ~2000)
4. Manual test: Load /plan?tab=goals with an active goal, verify:
   - Weekly Progress Cards display
   - Earnings Chart displays
   - No console errors
</verification>

<success_criteria>
1. GoalsTab imports and uses useGoalData hook
2. GoalsTab is reduced by 200+ lines
3. weeklyEarnings comes from hook earnings() with correct week attribution
4. WeeklyProgressCards receives weeklyEarnings prop from hook data
5. EarningsChart receives currentSaved from hook stats
6. Feasibility info comes from hook's retroplan
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-integration/21-02-SUMMARY.md`
</output>
