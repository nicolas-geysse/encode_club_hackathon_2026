---
phase: 21-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/src/lib/earningsAggregator.ts
  - packages/frontend/src/hooks/useGoalData.ts
autonomous: true

must_haves:
  truths:
    - "Hook fetches retroplan data via POST /api/retroplan"
    - "Hook aggregates earnings from missions, savings, and trades"
    - "Missions use completedAt with updatedAt fallback for week attribution"
    - "Monthly savings are placed at incomeDay of each month"
    - "Trade sales use updated_at for week attribution"
  artifacts:
    - path: "packages/frontend/src/lib/earningsAggregator.ts"
      provides: "Aggregation of all earning sources into EarningEvent[]"
      exports: ["aggregateAllEarnings"]
    - path: "packages/frontend/src/hooks/useGoalData.ts"
      provides: "Centralized data orchestration hook"
      exports: ["useGoalData", "UseGoalDataResult"]
  key_links:
    - from: "packages/frontend/src/hooks/useGoalData.ts"
      to: "/api/retroplan"
      via: "fetch in createResource"
      pattern: "fetch.*api/retroplan"
    - from: "packages/frontend/src/hooks/useGoalData.ts"
      to: "packages/frontend/src/lib/earningsAggregator.ts"
      via: "import and call"
      pattern: "aggregateAllEarnings"
---

<objective>
Complete the useGoalData hook with real data fetching and create the earningsAggregator utility.

Purpose: Provide a single source of truth for all goal-related data, enabling consistent display across GoalsTab, WeeklyProgressCards, and EarningsChart.

Output: Working useGoalData hook that fetches retroplan and aggregates all earnings sources with correct date attribution.
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/frontend/src/hooks/useGoalData.ts
@packages/frontend/src/types/earnings.ts
@packages/frontend/src/lib/savingsHelper.ts
@docs/bugs-dev/goals-fix.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create earningsAggregator.ts</name>
  <files>packages/frontend/src/lib/earningsAggregator.ts</files>
  <action>
Create `earningsAggregator.ts` that combines earnings from all sources into EarningEvent[].

**Inputs to aggregate:**
1. **Missions** (from followupData.missions where status='completed')
   - Use `completedAt` for date attribution (fallback to `updatedAt`, then current date)
   - Amount from `earningsCollected`
   - Label from mission `title`

2. **Monthly Savings** (from monthlyMargin and incomeDay)
   - Reuse logic from `savingsHelper.ts` calculateSavingsWeeks
   - Place at incomeDay of each month within goal period
   - Apply adjustments from savingsAdjustments if present

3. **Trade Sales** (from budget API trades where type='sell' AND status='completed')
   - Use `updated_at` for date attribution
   - Amount from `expectedPrice`

4. **Trade Borrow Savings** (from trades where type='borrow')
   - Use `created_at` for date attribution
   - Amount from `retailPrice` (money saved by borrowing vs buying)

**Implementation:**
```typescript
import type { EarningEvent, EarningSource } from '../types/earnings';
import { getWeekNumber } from '../types/earnings';
import { calculateSavingsWeeks, applySavingsAdjustments } from './savingsHelper';
import type { Mission } from '../components/suivi/MissionCard';

interface Trade {
  id: string;
  type: 'sell' | 'borrow' | 'lend';
  status: 'pending' | 'active' | 'completed';
  expectedPrice?: number;
  retailPrice?: number;
  created_at: string;
  updated_at: string;
  itemName: string;
}

interface SavingsAdjustment {
  amount: number;
  note?: string;
  adjustedAt: string;
}

interface AggregateEarningsParams {
  missions: Mission[];
  monthlyMargin: number;
  incomeDay: number;
  trades: Trade[];
  goalStartDate: Date;
  goalDeadline: Date;
  savingsAdjustments?: Record<number, SavingsAdjustment>;
}

export function aggregateAllEarnings(params: AggregateEarningsParams): EarningEvent[] {
  const events: EarningEvent[] = [];
  const { goalStartDate, goalDeadline } = params;

  // 1. Process missions
  // 2. Process savings
  // 3. Process trade sales
  // 4. Process trade borrow savings

  // Sort by date
  return events.sort((a, b) => a.date.getTime() - b.date.getTime());
}
```

Do NOT import from `@solidjs/router` or any SolidJS reactive primitives. This is a pure utility file.
  </action>
  <verify>
TypeScript compiles: `cd packages/frontend && npx tsc --noEmit src/lib/earningsAggregator.ts`
  </verify>
  <done>
earningsAggregator.ts exports aggregateAllEarnings function that combines all earning sources with correct date attribution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete useGoalData hook implementation</name>
  <files>packages/frontend/src/hooks/useGoalData.ts</files>
  <action>
Replace the stub implementations in useGoalData.ts with real data fetching and aggregation.

**Changes to make:**

1. **Add imports:**
```typescript
import { aggregateAllEarnings } from '../lib/earningsAggregator';
import { createResource } from 'solid-js';
```

2. **Add retroplan fetching:**
Replace the stub retroplan memo with a createResource that calls POST /api/retroplan.
The resource should depend on:
- goal()?.id
- goal()?.amount
- goal()?.deadline
- profile()?.id
- profile()?.minHourlyRate
- options.simulatedDate (if provided)

3. **Add budget/trades fetching:**
Create a separate resource for budget data via GET /api/budget?profileId={id}. Extract trades from the response.

4. **Implement earnings aggregation:**
Replace the stub earnings memo with a call to aggregateAllEarnings using:
- profile().followupData?.missions
- monthlyMargin (calculate from income/lifestyle or get from budget)
- profile().incomeDay
- trades from budget resource
- goal().createdAt as goalStartDate
- goal().deadline as goalDeadline
- profile().followupData?.savingsAdjustments

5. **Compute weeksRemaining:**
Calculate from goal deadline and current date (or simulatedDate if provided).

6. **Implement refetch:**
Call the resource refetch methods.

**Important patterns to preserve:**
- Keep all existing type definitions
- Maintain the skeleton's memo structure (retroplan, earnings, milestones, stats)
- The stats computation can remain simplified (Phase 22 will add capacity-aware calculations)

**Do NOT:**
- Change the hook signature or return type
- Remove any existing type exports
- Add new props to the hook (options already has includeSimulation)
  </action>
  <verify>
TypeScript compiles: `cd packages/frontend && npx tsc --noEmit src/hooks/useGoalData.ts`
  </verify>
  <done>
useGoalData hook fetches real retroplan and budget data, aggregates all earnings sources, and computes stats.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Mission completedAt handling</name>
  <files>packages/frontend/src/components/suivi/MissionCard.tsx</files>
  <action>
Check the Mission interface in MissionCard.tsx. If `completedAt` field is missing, add it as optional:

```typescript
export interface Mission {
  // ... existing fields
  completedAt?: string;  // ISO date string when mission was completed
}
```

Then update the mission completion logic to set completedAt when status changes to 'completed'.

Look for the status update handler (likely onStatusChange or similar) and ensure it sets:
```typescript
completedAt: new Date().toISOString()
```

If Mission interface is defined elsewhere, update that location instead.

**Do NOT** make breaking changes - completedAt should be optional to maintain backward compatibility with existing missions that don't have this field.
  </action>
  <verify>
Grep for Mission interface and verify completedAt is present: `grep -n "completedAt" packages/frontend/src/components/suivi/MissionCard.tsx`
  </verify>
  <done>
Mission interface has optional completedAt field for date attribution in earnings aggregation.
  </done>
</task>

</tasks>

<verification>
1. `cd packages/frontend && pnpm typecheck` passes
2. `cd packages/frontend && pnpm lint` passes (or only has pre-existing warnings)
3. Manual verification: Open browser devtools, load /plan?tab=goals, check Network tab for:
   - POST /api/retroplan being called
   - GET /api/budget being called
</verification>

<success_criteria>
1. earningsAggregator.ts exists and exports aggregateAllEarnings
2. useGoalData hook fetches retroplan via POST /api/retroplan
3. useGoalData hook fetches budget via GET /api/budget
4. Hook aggregates missions, savings, and trades into earnings()
5. Mission interface has completedAt field (optional)
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-integration/21-01-SUMMARY.md`
</output>
