---
phase: 16-privacy-consent
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - packages/frontend/src/components/chat/OnboardingChat.tsx
  - packages/frontend/src/routes/api/profiles.ts
  - packages/mcp-server/src/services/opik.ts
autonomous: true

must_haves:
  truths:
    - "User sees consent screen before browser requests location permission"
    - "User can enter city manually without GPS access"
    - "DuckDB stores fuzzy coordinates only (2 decimal places)"
    - "Opik traces have no raw latitude/longitude values"
  artifacts:
    - path: "packages/frontend/src/components/chat/OnboardingChat.tsx"
      provides: "Integrated consent flow in onboarding"
      contains: "LocationConsent"
    - path: "packages/frontend/src/routes/api/profiles.ts"
      provides: "Fuzzy coordinate enforcement on save"
      contains: "fuzzyCoordinates"
    - path: "packages/mcp-server/src/services/opik.ts"
      provides: "PII sanitization for traces"
      contains: "sanitizeLocationPII"
  key_links:
    - from: "OnboardingChat.tsx"
      to: "LocationConsent.tsx"
      via: "conditional render"
      pattern: "<LocationConsent"
    - from: "profiles.ts"
      to: "locationPrivacy.ts"
      via: "import fuzzyCoordinates"
      pattern: "fuzzyCoordinates\\("
---

<objective>
Integrate consent flow into onboarding and enforce privacy across the stack.

Purpose: Wire up the consent component, enforce fuzzy coordinates in the database layer, and sanitize Opik traces to ensure no raw GPS data leaks anywhere.

Output: Modified OnboardingChat with consent step, profiles API with coordinate fuzzing, and Opik service with PII sanitization.
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# From Plan 01
@packages/frontend/src/lib/locationPrivacy.ts
@packages/frontend/src/components/onboarding/LocationConsent.tsx

# Files to modify
@packages/frontend/src/components/chat/OnboardingChat.tsx
@packages/frontend/src/routes/api/profiles.ts
@packages/mcp-server/src/services/opik.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate consent flow in OnboardingChat</name>
  <files>packages/frontend/src/components/chat/OnboardingChat.tsx</files>
  <action>
Modify OnboardingChat.tsx to show consent before requesting location:

1. **Add imports:**
```typescript
import { LocationConsent } from './onboarding/LocationConsent';
import { fuzzyCoordinates } from '~/lib/locationPrivacy';
```
Note: The LocationConsent path is relative to the chat folder since it's in components/onboarding.
Adjust import path: `import { LocationConsent } from '../onboarding/LocationConsent';`

2. **Add new state:**
```typescript
const [showLocationConsent, setShowLocationConsent] = createSignal(false);
const [locationConsentGiven, setLocationConsentGiven] = createSignal<'allowed' | 'declined' | null>(null);
```

3. **Modify greeting step flow:**
- When onboarding starts (greeting step), show LocationConsent component BEFORE showing the chat message
- Only after user makes a choice (allow or decline), proceed with the greeting message

4. **Handle consent callbacks:**
```typescript
const handleLocationAllow = async () => {
  setLocationConsentGiven('allowed');
  setShowLocationConsent(false);
  // Try to get location - if successful, store fuzzy coords
  try {
    const result = await getCurrentLocation();
    const fuzzy = fuzzyCoordinates(result.coordinates.latitude, result.coordinates.longitude);
    // Update profile with fuzzy coordinates and city
    updateProfileData({
      city: result.city,
      latitude: fuzzy.latitude,
      longitude: fuzzy.longitude,
      currency: result.currency,
    });
  } catch (error) {
    // GPS failed - fall through to manual city entry
    console.warn('[Onboarding] Location access failed, falling back to manual entry');
  }
  // Proceed with greeting
};

const handleLocationDecline = () => {
  setLocationConsentGiven('declined');
  setShowLocationConsent(false);
  // Proceed with greeting - user will enter city manually
};
```

5. **Render consent screen conditionally:**
```jsx
<Show when={showLocationConsent()}>
  <LocationConsent
    onAllow={handleLocationAllow}
    onDecline={handleLocationDecline}
  />
</Show>
```

6. **Trigger consent on mount for new users:**
In the onMount or appropriate initialization point, if user doesn't have location data yet and onboarding hasn't been completed:
```typescript
if (currentStep() === 'greeting' && !locationConsentGiven()) {
  setShowLocationConsent(true);
}
```

7. **Ensure fuzzy coordinates in forwardGeocode results too:**
When user enters city manually and we call forwardGeocode, apply fuzzyCoordinates to the result before storing.

IMPORTANT: Keep the existing greeting flow working - the consent screen is shown BEFORE the chat starts, then the normal flow continues.
  </action>
  <verify>
TypeScript compiles:
```bash
cd packages/frontend && pnpm typecheck
```
App starts without errors:
```bash
cd packages/frontend && timeout 10 pnpm dev || true
```
  </verify>
  <done>
- LocationConsent is rendered for new users at start of onboarding
- Clicking "Allow" triggers browser location permission
- Clicking "Enter my city" proceeds without GPS request
- Fuzzy coordinates are used when storing location data
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce fuzzy coordinates in profiles API</name>
  <files>packages/frontend/src/routes/api/profiles.ts</files>
  <action>
Modify profiles.ts to ensure only fuzzy coordinates are stored:

1. **Add import at top of file:**
```typescript
import { fuzzyCoordinates, isRawCoordinate } from '../../lib/locationPrivacy';
```

2. **In the POST handler (create profile):**
Before saving, if latitude/longitude are provided, apply fuzzyCoordinates:
```typescript
if (body.latitude !== undefined && body.longitude !== undefined) {
  const fuzzy = fuzzyCoordinates(body.latitude, body.longitude);
  body.latitude = fuzzy.latitude;
  body.longitude = fuzzy.longitude;
}
```

3. **In the PUT/PATCH handler (update profile):**
Same treatment - apply fuzzyCoordinates before UPDATE SQL:
```typescript
if (body.latitude !== undefined && body.longitude !== undefined) {
  const fuzzy = fuzzyCoordinates(body.latitude, body.longitude);
  body.latitude = fuzzy.latitude;
  body.longitude = fuzzy.longitude;
}
```

4. **Add a comment explaining the privacy requirement:**
```typescript
// PRIVACY: Always store fuzzy coordinates (2 decimal places = ~1km precision)
// This ensures FERPA/GDPR compliance - no precise GPS data persisted
```

This acts as a defense-in-depth layer - even if the frontend sends raw coordinates, the API ensures only fuzzy values are stored.
  </action>
  <verify>
TypeScript compiles:
```bash
cd packages/frontend && pnpm typecheck
```
Lint passes:
```bash
cd packages/frontend && pnpm lint
```
  </verify>
  <done>
- profiles.ts imports fuzzyCoordinates from locationPrivacy
- Both POST and PUT handlers apply coordinate fuzzing
- Comment documents the privacy rationale
  </done>
</task>

<task type="auto">
  <name>Task 3: Add PII sanitization to Opik traces</name>
  <files>packages/mcp-server/src/services/opik.ts</files>
  <action>
Modify opik.ts to sanitize location PII in trace data:

1. **Add import for sanitization utility:**
Since opik.ts is in mcp-server, and locationPrivacy.ts is in frontend, we need to either:
- Option A: Copy the sanitization function to mcp-server (DRY violation but simpler)
- Option B: Create a shared package (overkill for hackathon)

Choose Option A for hackathon speed. Add this at the top of opik.ts:

```typescript
// PRIVACY: Location PII sanitization for FERPA/GDPR compliance
const PRIVACY_PLACEHOLDER = '[LOCATION_REDACTED]';
const LOCATION_KEYS = ['latitude', 'longitude', 'lat', 'lon', 'coords', 'coordinates'];

function sanitizeLocationPII(data: Record<string, unknown>): Record<string, unknown> {
  if (!data || typeof data !== 'object') return data;

  const result = { ...data };
  for (const key of Object.keys(result)) {
    const lowerKey = key.toLowerCase();
    if (LOCATION_KEYS.some(k => lowerKey.includes(k))) {
      result[key] = PRIVACY_PLACEHOLDER;
    } else if (typeof result[key] === 'object' && result[key] !== null) {
      result[key] = sanitizeLocationPII(result[key] as Record<string, unknown>);
    }
  }
  return result;
}
```

2. **Sanitize trace inputs:**
In the `trace()` function, when setting input via traceConfig:
```typescript
if (options?.input) {
  traceConfig.input = sanitizeLocationPII(options.input);
}
```

3. **Sanitize trace outputs:**
In the `finalizeTrace()` function, before setting output:
```typescript
if (outputData) {
  updateData.output = sanitizeLocationPII(outputData);
}
```

4. **Sanitize span inputs/outputs:**
In `createSpanInternal()`, apply the same sanitization:
```typescript
if (options?.input) {
  spanConfig.input = sanitizeLocationPII(options.input);
}
// And in finalize:
if (outputData) {
  updateData.output = sanitizeLocationPII(outputData);
}
```

5. **Add JSDoc comment:**
```typescript
/**
 * PRIVACY COMPLIANCE:
 * All trace inputs/outputs are sanitized to remove raw GPS coordinates.
 * Location data is replaced with placeholder to prevent PII leakage.
 * Required for FERPA (student data) and GDPR compliance.
 */
```

This ensures NO raw coordinates appear in Opik traces, even if they're accidentally passed.
  </action>
  <verify>
TypeScript compiles:
```bash
cd packages/mcp-server && pnpm typecheck
```
Lint passes:
```bash
cd packages/mcp-server && pnpm lint
```
  </verify>
  <done>
- opik.ts has sanitizeLocationPII function
- Trace inputs are sanitized before logging
- Trace outputs are sanitized before logging
- Span inputs/outputs are also sanitized
- Privacy comment documents the rationale
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes in both packages
2. Lint passes in both packages
3. No raw coordinates in trace code paths
</verification>

<success_criteria>
- OnboardingChat shows consent screen before greeting for new users
- Consent allows GPS or manual city entry
- profiles.ts enforces fuzzy coordinates on all writes
- opik.ts sanitizes all inputs/outputs for location PII
- All code compiles and lints cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/16-privacy-consent/16-02-SUMMARY.md`
</output>
