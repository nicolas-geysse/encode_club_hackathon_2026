---
phase: 16-privacy-consent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/src/lib/locationPrivacy.ts
  - packages/frontend/src/components/onboarding/LocationConsent.tsx
autonomous: true

must_haves:
  truths:
    - "Fuzzy coordinate function rounds to 2 decimal places (~1km precision)"
    - "LocationConsent component renders two clear options"
    - "PII sanitizer replaces raw coordinates with placeholder"
  artifacts:
    - path: "packages/frontend/src/lib/locationPrivacy.ts"
      provides: "Fuzzy coordinate helpers and PII sanitization"
      exports: ["fuzzyCoordinates", "sanitizeLocationPII", "PRIVACY_PLACEHOLDER"]
    - path: "packages/frontend/src/components/onboarding/LocationConsent.tsx"
      provides: "Consent screen UI component"
      exports: ["LocationConsent"]
  key_links:
    - from: "locationPrivacy.ts"
      to: "geolocation.ts"
      via: "fuzzyCoordinates wraps raw coordinates"
      pattern: "Math\\.round.*100"
---

<objective>
Create location privacy utilities and consent UI component.

Purpose: Establish the foundation for FERPA/GDPR-compliant location handling before any user data is collected. This includes the fuzzy coordinate helpers and the consent screen component.

Output: Two new files - locationPrivacy.ts with coordinate fuzzing and PII sanitization utilities, and LocationConsent.tsx with the consent screen UI.

**Privacy Requirement Clarification (PRIV-04):**
The requirement states "city name or radius-from-point". Fuzzy coordinates (2 decimal places = ~1.1km) satisfy the "radius-from-point" option. User explicitly stated: "radius around user's initial location for demo" which IS implemented via 2-decimal fuzzy coords. City name is the alternative when user declines GPS.
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/frontend/src/lib/geolocation.ts
@packages/frontend/src/lib/profileService.ts
@packages/frontend/src/components/chat/OnboardingChat.tsx (first 200 lines for context)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create locationPrivacy.ts utilities</name>
  <files>packages/frontend/src/lib/locationPrivacy.ts</files>
  <action>
Create a new file with privacy-focused location utilities:

1. **fuzzyCoordinates(lat: number, lon: number)** function:
   - Round to 2 decimal places: `Math.round(coord * 100) / 100`
   - This gives ~1.1km precision (enough for city-level, not street-level)
   - Return `{ latitude: number, longitude: number }`

2. **PRIVACY_PLACEHOLDER** constant:
   - Value: `"[LOCATION_REDACTED]"` for logs/traces

3. **sanitizeLocationPII(data: Record<string, unknown>)** function:
   - Deep clone the input object
   - Find any keys matching: latitude, longitude, lat, lon, coords, coordinates
   - Replace their values with PRIVACY_PLACEHOLDER
   - Return sanitized object
   - Use recursion for nested objects

4. **isRawCoordinate(value: number)** helper:
   - Returns true if number has more than 2 decimal places
   - Used to detect unsanitized coordinates

Add JSDoc comments explaining the FERPA/GDPR rationale.
Export all functions.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd packages/frontend && pnpm typecheck
```
  </verify>
  <done>
- fuzzyCoordinates(48.8566, 2.3522) returns { latitude: 48.86, longitude: 2.35 }
- sanitizeLocationPII({ latitude: 48.8566 }) returns { latitude: "[LOCATION_REDACTED]" }
- All exports available from locationPrivacy.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LocationConsent component</name>
  <files>packages/frontend/src/components/onboarding/LocationConsent.tsx</files>
  <action>
Create a SolidJS component for the consent screen:

1. **Props interface:**
```typescript
interface LocationConsentProps {
  onAllow: () => void;      // User clicked "Allow location access"
  onDecline: () => void;    // User clicked "Enter my city instead"
}
```

2. **Component structure:**
- Use existing GlassButton component from ~/components/ui/GlassButton
- Match the existing onboarding visual style (dark theme, glass morphism)
- Brief explanation text (per user's vision):
  ```
  "We use your location to show you part-time jobs near you.
   You can refuse and just enter your city instead."
  ```
- Small privacy note: "Your precise location is never stored - only your city or a fuzzy area (~1km radius)."

3. **Two buttons:**
- Primary: "Allow location access" (calls onAllow)
- Secondary: "Enter my city instead" (calls onDecline)

4. **Styling:**
- Use Tailwind classes consistent with OnboardingChat
- Center content with appropriate padding
- Accessible: proper button labels, focus states

Do NOT use MapPin or other lucide icons that aren't already imported in the project.
Use existing project patterns (check OnboardingChat.tsx for style reference).
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd packages/frontend && pnpm typecheck
```
Component exports correctly:
```bash
grep -l "LocationConsent" packages/frontend/src/components/onboarding/LocationConsent.tsx
```
  </verify>
  <done>
- LocationConsent.tsx exports the LocationConsent component
- Component accepts onAllow and onDecline props
- Both buttons are rendered with appropriate labels
- Privacy disclosure text is present in the component
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `cd packages/frontend && pnpm typecheck`
2. Both files exist and export expected symbols
3. No lint errors: `cd packages/frontend && pnpm lint`
</verification>

<success_criteria>
- locationPrivacy.ts exports fuzzyCoordinates, sanitizeLocationPII, PRIVACY_PLACEHOLDER
- LocationConsent.tsx exports LocationConsent component with proper props
- All code follows existing project patterns and Tailwind styling
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-privacy-consent/16-01-SUMMARY.md`
</output>
