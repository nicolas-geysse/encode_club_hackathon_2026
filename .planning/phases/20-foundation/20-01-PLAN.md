---
phase: 20-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/src/types/earnings.ts
  - packages/frontend/src/hooks/useGoalData.ts
autonomous: true

must_haves:
  truths:
    - "EarningEvent type provides IDE autocompletion for all source values"
    - "useGoalData hook compiles without TypeScript errors"
    - "Hook signature accepts goal, profile, and simulation options"
    - "getWeekNumber helper correctly calculates week offset from goal start"
  artifacts:
    - path: "packages/frontend/src/types/earnings.ts"
      provides: "EarningEvent type and EarningSource union"
      exports: ["EarningSource", "EarningEvent", "GoalStatus", "getWeekNumber"]
      contains: "mission.*savings.*trade_sale.*trade_borrow"
    - path: "packages/frontend/src/hooks/useGoalData.ts"
      provides: "Centralized goal data orchestration hook"
      exports: ["useGoalData", "UseGoalDataResult", "UseGoalDataOptions"]
      min_lines: 60
  key_links:
    - from: "packages/frontend/src/hooks/useGoalData.ts"
      to: "packages/frontend/src/types/earnings.ts"
      via: "import type { EarningEvent, GoalStatus }"
      pattern: "import.*from.*types/earnings"
---

<objective>
Create the typed data structures and hook skeleton that will centralize all goal data orchestration.

Purpose: This is the foundation for the v4.0 Goals Tab Fix. The EarningEvent type enables strict date attribution for all earning sources, and the useGoalData hook skeleton establishes the API contract that GoalsTab, WeeklyProgressCards, and EarningsChart will consume.

Output:
- `packages/frontend/src/types/earnings.ts` - Type definitions
- `packages/frontend/src/hooks/useGoalData.ts` - Hook skeleton with stub implementations
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docs/bugs-dev/goals-fix.md

# Existing patterns to follow
@packages/frontend/src/types/entities.ts
@packages/frontend/src/hooks/createCrudTab.ts
@packages/frontend/src/lib/goalService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EarningEvent type definitions</name>
  <files>packages/frontend/src/types/earnings.ts</files>
  <action>
Create the earnings type file following the pattern in `src/types/entities.ts`.

Include these types:

1. **EarningSource** - Union type for all earning sources:
   - `'mission'` - Completed missions from followup_data
   - `'savings'` - Monthly savings from income margin
   - `'trade_sale'` - Completed trade sales
   - `'trade_borrow'` - Borrow savings (avoiding purchase)
   - `'manual_adjustment'` - Future-proofing for manual entries

2. **EarningEvent** - Main event type with fields:
   - `id: string` - Unique identifier
   - `date: Date` - Effective date of the earning
   - `amount: number` - Amount earned
   - `source: EarningSource` - Type discriminator
   - `label: string` - Human-readable description
   - `weekNumber: number` - Week relative to goal start (1-indexed)
   - `metadata?: { missionId?: string; tradeId?: string }` - Optional references

3. **GoalStatus** - Status type:
   - `'ahead' | 'on-track' | 'behind' | 'critical'`

4. **getWeekNumber** helper function:
   - Signature: `(eventDate: Date, goalStartDate: Date) => number`
   - Returns week number (1-indexed, minimum 1)
   - Calculation: `Math.max(1, Math.floor(diffMs / (7 * 24 * 60 * 60 * 1000)) + 1)`

Add JSDoc comments explaining each type and its usage context.
  </action>
  <verify>
Run `pnpm --filter @stride/frontend typecheck` - should pass with no errors in earnings.ts
  </verify>
  <done>
- EarningSource union type exists with 5 source values
- EarningEvent interface exists with all required fields
- GoalStatus type exists with 4 status values
- getWeekNumber helper is exported and correctly typed
- File follows existing entities.ts patterns (JSDoc, exports)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useGoalData hook skeleton</name>
  <files>packages/frontend/src/hooks/useGoalData.ts</files>
  <action>
Create the hook skeleton following SolidJS patterns from `createCrudTab.ts`.

**Hook Options Interface:**
```typescript
export interface UseGoalDataOptions {
  includeSimulation?: boolean; // For "What If" scenarios
}
```

**Hook Result Interface:**
```typescript
export interface UseGoalDataResult {
  // Data accessors (stub implementations for now)
  retroplan: Accessor<Retroplan | undefined>;
  earnings: Accessor<EarningEvent[]>;
  milestones: Accessor<Array<{ week: number; adjustedTarget: number }>>;

  // Computed stats (unified - stub for now)
  stats: Accessor<{
    totalEarned: number;
    weeklyTarget: number;        // Capacity-aware for current week
    linearWeeklyNeed: number;    // For comparison
    status: GoalStatus;
    weeksRemaining: number;
    percentComplete: number;
    onPace: boolean;
  }>;

  // Loading states
  loading: Accessor<boolean>;
  error: Accessor<Error | undefined>;

  // Actions
  refetch: () => void;
}
```

**Hook Implementation:**
- Use `createSignal` for loading/error states
- Use `createMemo` returning stub values for data accessors
- Import Goal type from `../lib/goalService`
- Import Profile type - check where it's defined (likely in profileService or a types file)
- Stub `refetch` as no-op function

**Important notes:**
- This is a SKELETON - do not implement actual data fetching yet (Phase 21)
- Return sensible stub values (empty arrays, zeros, 'on-track')
- Add TODO comments marking where real implementation goes
- Follow SolidJS best practices (no destructuring props in component scope)

**Type imports needed:**
- `Accessor` from 'solid-js'
- `EarningEvent`, `GoalStatus` from '../types/earnings'
- `Goal` from '../lib/goalService'
- Find Profile type (search codebase if needed)
  </action>
  <verify>
Run `pnpm --filter @stride/frontend typecheck` - should pass with no errors in useGoalData.ts

Verify hook can be imported:
```typescript
// In a test file or console
import { useGoalData } from './hooks/useGoalData';
```
  </verify>
  <done>
- useGoalData function is exported with correct signature
- Hook accepts goal, profile accessors, and optional options
- All return values are properly typed Accessors
- Hook compiles without TypeScript errors
- TODO comments mark where Phase 21 will add real implementation
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `pnpm --filter @stride/frontend typecheck` passes
2. Both files exist and are properly exported
3. IDE provides autocompletion for EarningSource values
4. IDE provides autocompletion for useGoalData return values
</verification>

<success_criteria>
Phase 20 success criteria met when:
- [x] EarningEvent type exists with date, amount, source, weekNumber, label fields
- [x] useGoalData hook exists and compiles (returning stubs)
- [x] Type definitions enable IDE autocompletion for all earnings sources
- [x] Hook signature accepts goal, profile, and optional simulation parameters
</success_criteria>

<output>
After completion, create `.planning/phases/20-foundation/20-01-SUMMARY.md`
</output>
