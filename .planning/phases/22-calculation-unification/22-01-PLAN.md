---
phase: 22-calculation-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/src/lib/goalStatus.ts
  - packages/frontend/src/hooks/useGoalData.ts
  - packages/frontend/src/components/EarningsChart.tsx
autonomous: true

must_haves:
  truths:
    - "Weekly Need value is identical in EarningsChart panel and WeeklyProgressCards"
    - "Status (ahead/on-track/behind/critical) is identical in panel and cards"
    - "Changing thresholds in GOAL_STATUS_THRESHOLDS affects both components"
    - "Existing retroplan data continues to work without breaking"
  artifacts:
    - path: "packages/frontend/src/lib/goalStatus.ts"
      provides: "Configurable status thresholds and unified calculation"
      exports: ["GOAL_STATUS_THRESHOLDS", "calculateGoalStatus"]
      contains: "AHEAD: 1.05"
    - path: "packages/frontend/src/hooks/useGoalData.ts"
      provides: "Stats computation using unified goalStatus"
      contains: "calculateGoalStatus"
    - path: "packages/frontend/src/components/EarningsChart.tsx"
      provides: "Panel stats derived from hook instead of internal computation"
      contains: "props.stats"
  key_links:
    - from: "packages/frontend/src/hooks/useGoalData.ts"
      to: "packages/frontend/src/lib/goalStatus.ts"
      via: "import calculateGoalStatus"
      pattern: "import.*calculateGoalStatus.*from.*goalStatus"
    - from: "packages/frontend/src/components/EarningsChart.tsx"
      to: "props.stats"
      via: "props for unified stats"
      pattern: "props\\.stats"
---

<objective>
Unify status and Weekly Need calculations across all goal display components.

Purpose: Eliminate the dual calculation systems (linear in EarningsChart, capacity-aware in WeeklyProgressCards) that create user confusion when different parts of the UI show conflicting status or weekly targets.

Output: Single source of truth for goal status via configurable thresholds, with EarningsChart consuming stats from useGoalData hook instead of computing independently.
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/bugs-dev/goals-fix.md

# Key source files
@packages/frontend/src/hooks/useGoalData.ts
@packages/frontend/src/components/EarningsChart.tsx
@packages/frontend/src/components/WeeklyProgressCards.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create goalStatus.ts with configurable thresholds</name>
  <files>packages/frontend/src/lib/goalStatus.ts</files>
  <action>
Create a new file `packages/frontend/src/lib/goalStatus.ts` with:

1. **GOAL_STATUS_THRESHOLDS constant** (exported):
```typescript
export const GOAL_STATUS_THRESHOLDS = {
  AHEAD: 1.05,      // >= 105% of cumulative target = ahead
  ON_TRACK: 0.90,   // >= 90% = on-track
  BEHIND: 0.40,     // >= 40% = behind
  // < 40% = critical
} as const;
```

2. **GoalStatus type** (export from types/earnings.ts if not already there, or define locally):
```typescript
export type GoalStatus = 'ahead' | 'on-track' | 'behind' | 'critical';
```

3. **calculateGoalStatus function** (exported):
```typescript
export function calculateGoalStatus(
  cumulativeEarned: number,
  cumulativeTarget: number,
  thresholds = GOAL_STATUS_THRESHOLDS
): GoalStatus {
  // Handle edge case: no target yet
  if (cumulativeTarget <= 0) {
    return cumulativeEarned > 0 ? 'ahead' : 'on-track';
  }

  const ratio = cumulativeEarned / cumulativeTarget;

  if (ratio >= thresholds.AHEAD) return 'ahead';
  if (ratio >= thresholds.ON_TRACK) return 'on-track';
  if (ratio >= thresholds.BEHIND) return 'behind';
  return 'critical';
}
```

4. **calculateOnPace helper** (exported):
```typescript
export function calculateOnPace(
  cumulativeEarned: number,
  cumulativeTarget: number,
  thresholds = GOAL_STATUS_THRESHOLDS
): boolean {
  if (cumulativeTarget <= 0) return true;
  const ratio = cumulativeEarned / cumulativeTarget;
  return ratio >= thresholds.ON_TRACK;
}
```

**Important:** The thresholds MUST match what WeeklyProgressCards uses (lines 203-219):
- ahead: >= 1.05 (105%)
- on-track: >= 0.90 (90%)
- behind: >= 0.40 (40%)
- critical: < 0.40 (40%)
  </action>
  <verify>
Run `pnpm typecheck` - no errors for the new file.
Verify file exists and exports the expected symbols:
```bash
grep -E "export (const|function|type)" packages/frontend/src/lib/goalStatus.ts
```
Expected: GOAL_STATUS_THRESHOLDS, GoalStatus, calculateGoalStatus, calculateOnPace
  </verify>
  <done>
`goalStatus.ts` exists with GOAL_STATUS_THRESHOLDS constant and calculateGoalStatus function. Thresholds match WeeklyProgressCards (1.05, 0.90, 0.40).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useGoalData stats computation to use goalStatus</name>
  <files>packages/frontend/src/hooks/useGoalData.ts</files>
  <action>
Modify `useGoalData.ts` to use the new goalStatus helpers:

1. **Add import at top:**
```typescript
import { calculateGoalStatus, calculateOnPace, GOAL_STATUS_THRESHOLDS } from '../lib/goalStatus';
```

2. **Update the stats memo (lines ~406-468)** to use calculateGoalStatus:

Replace the current status calculation logic:
```typescript
// OLD (lines 445-457):
let status: GoalStatus = 'on-track';
if (percentComplete >= 100) {
  status = 'ahead';
} else if (!onPace && goalAmount > 0) {
  const behindPercentage = ((remaining - expectedRemaining) / goalAmount) * 100;
  if (behindPercentage > 20) {
    status = 'critical';
  } else if (behindPercentage > 10) {
    status = 'behind';
  }
}
```

With the unified calculation:
```typescript
// NEW - Calculate cumulative target for current week
let cumulativeTarget = 0;
if (plan && plan.milestones.length > 0) {
  const currentWeekNumber = plan.totalWeeks - weeksRemaining + 1;
  const currentMilestone = plan.milestones.find((m) => m.weekNumber === currentWeekNumber);
  if (currentMilestone) {
    cumulativeTarget = currentMilestone.cumulativeTarget;
  } else {
    // Fallback: use linear target
    cumulativeTarget = goalAmount * (currentWeekNumber / plan.totalWeeks);
  }
} else {
  // No retroplan - use linear estimate
  const elapsedWeeks = plan?.totalWeeks ? plan.totalWeeks - weeksRemaining : 1;
  cumulativeTarget = linearWeeklyNeed * elapsedWeeks;
}

// Use unified status calculation
const status = calculateGoalStatus(totalEarned, cumulativeTarget);
const onPace = calculateOnPace(totalEarned, cumulativeTarget);
```

3. **Add cumulativeTarget to GoalStats interface** (around line 90):
```typescript
export interface GoalStats {
  totalEarned: number;
  weeklyTarget: number;
  linearWeeklyNeed: number;
  cumulativeTarget: number;  // ADD THIS
  status: GoalStatus;
  weeksRemaining: number;
  percentComplete: number;
  onPace: boolean;
}
```

4. **Include cumulativeTarget in return** (around line 459):
```typescript
return {
  totalEarned,
  weeklyTarget,
  linearWeeklyNeed,
  cumulativeTarget,  // ADD THIS
  status,
  weeksRemaining,
  percentComplete,
  onPace,
};
```

5. **Remove the TODO comment** that says "Phase 22 will improve this" (around line 446).

**Critical:** The status calculation must now use cumulative earned vs cumulative target (same as WeeklyProgressCards), not the old percentage-based logic.
  </action>
  <verify>
Run `pnpm typecheck` - no errors.
Verify the import and usage:
```bash
grep "calculateGoalStatus" packages/frontend/src/hooks/useGoalData.ts
grep "cumulativeTarget" packages/frontend/src/hooks/useGoalData.ts
```
Expected: import statement and usage in stats computation.
  </verify>
  <done>
useGoalData hook uses calculateGoalStatus from goalStatus.ts. Stats include cumulativeTarget. Status calculation matches WeeklyProgressCards methodology.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update EarningsChart to use stats from props</name>
  <files>packages/frontend/src/components/EarningsChart.tsx</files>
  <action>
Modify `EarningsChart.tsx` to receive and use unified stats from the parent (via useGoalData hook) instead of computing independently:

1. **Update EarningsChartProps interface** (around line 56):
```typescript
interface EarningsChartProps {
  goal: Goal;
  weeklyEarnings?: WeeklyEarning[];
  currentSaved?: number;
  currency?: Currency;
  compact?: boolean;
  adjustedWeeklyTarget?: number;
  milestones?: ChartMilestone[];
  /** v4.0 Phase 22: Unified stats from useGoalData hook */
  stats?: {
    totalEarned: number;
    weeklyTarget: number;
    linearWeeklyNeed: number;
    cumulativeTarget: number;
    status: 'ahead' | 'on-track' | 'behind' | 'critical';
    weeksRemaining: number;
    percentComplete: number;
    onPace: boolean;
  };
}
```

2. **Modify the internal stats memo** (lines 340-359) to prefer props.stats when available:
```typescript
// Calculate summary stats - prefer unified stats from hook if provided
const stats = createMemo(() => {
  // Use unified stats from hook if available (Phase 22)
  if (props.stats) {
    const weeksToGoal = props.stats.onPace && props.stats.weeklyTarget > 0
      ? Math.ceil((props.goal.amount - props.stats.totalEarned) / props.stats.weeklyTarget)
      : null;

    return {
      currentSaved: props.stats.totalEarned,
      goalAmount: props.goal.amount,
      weeklyRequired: props.stats.weeklyTarget,  // Use capacity-aware, not linear
      currentWeeklyRate: props.stats.weeklyTarget,
      onPace: props.stats.onPace,
      percentComplete: props.stats.percentComplete,
      weeksToGoal,
      totalWeeks: props.stats.weeksRemaining,
    };
  }

  // Fallback to internal calculation (backward compatibility)
  const data = generateChartData();
  const onPace = data.currentWeeklyRate >= data.weeklyRequired * 0.9;
  const percentComplete = Math.round((data.currentSaved / data.goalAmount) * 100);
  const weeksToGoal =
    data.currentWeeklyRate > 0
      ? Math.ceil((data.goalAmount - data.currentSaved) / data.currentWeeklyRate)
      : null;

  return {
    currentSaved: data.currentSaved,
    goalAmount: data.goalAmount,
    weeklyRequired: data.weeklyRequired,
    currentWeeklyRate: data.currentWeeklyRate,
    onPace,
    percentComplete,
    weeksToGoal,
    totalWeeks: data.totalWeeks,
  };
});
```

3. **Update the status display** in the panel (around lines 403-413) to use the unified status:
```typescript
<div class="bg-muted/50 rounded-lg p-2">
  <p class="text-[10px] text-muted-foreground uppercase">Status</p>
  <p
    class={`text-sm font-bold ${
      props.stats?.status === 'ahead' || stats().onPace
        ? 'text-green-600 dark:text-green-400'
        : props.stats?.status === 'critical'
          ? 'text-red-600 dark:text-red-400'
          : props.stats?.status === 'behind'
            ? 'text-amber-600 dark:text-amber-400'
            : 'text-red-600 dark:text-red-400'
    }`}
  >
    {props.stats?.status === 'ahead'
      ? 'ðŸš€ Ahead'
      : props.stats?.status === 'on-track' || stats().onPace
        ? 'âœ“ On Track'
        : props.stats?.status === 'behind'
          ? 'âš  Behind'
          : 'ðŸ”´ Critical'}
  </p>
  <p class="text-[9px] text-muted-foreground mt-0.5">
    {stats().weeksToGoal ? `~${stats().weeksToGoal}w remaining` : ''}
  </p>
</div>
```

**Critical:** When props.stats is provided:
- weeklyRequired should use `props.stats.weeklyTarget` (capacity-aware)
- Status should use `props.stats.status` (unified calculation)
- onPace should use `props.stats.onPace` (from same calculation as status)

This ensures the panel displays the SAME values as WeeklyProgressCards.
  </action>
  <verify>
Run `pnpm typecheck` - no errors.
Verify the stats prop usage:
```bash
grep "props.stats" packages/frontend/src/components/EarningsChart.tsx | head -5
```
Expected: Multiple references to props.stats in the stats memo and JSX.
  </verify>
  <done>
EarningsChart accepts optional stats prop from useGoalData. When provided, uses unified stats for Weekly Need and Status display. Fallback to internal calculation for backward compatibility.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type check passes:**
   ```bash
   pnpm typecheck
   ```

2. **Build succeeds:**
   ```bash
   pnpm build:frontend
   ```

3. **No console errors on Goals tab:**
   - Start dev server: `pnpm dev`
   - Navigate to /plan and select Goals tab
   - Check browser console for errors

4. **Visual verification (manual):**
   - Weekly Need in EarningsChart panel should match current week's target in WeeklyProgressCards
   - Status (ahead/on-track/behind/critical) should be identical in both places
</verification>

<success_criteria>
- [ ] `goalStatus.ts` exists with GOAL_STATUS_THRESHOLDS and calculateGoalStatus
- [ ] useGoalData imports and uses calculateGoalStatus
- [ ] useGoalData.stats includes cumulativeTarget
- [ ] EarningsChart accepts optional stats prop
- [ ] EarningsChart uses props.stats when available
- [ ] pnpm typecheck passes
- [ ] pnpm build:frontend succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/22-calculation-unification/22-01-SUMMARY.md`
</output>
