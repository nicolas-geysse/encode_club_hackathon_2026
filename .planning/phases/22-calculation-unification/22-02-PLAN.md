---
phase: 22-calculation-unification
plan: 02
type: execute
wave: 1
depends_on: ["22-01"]
files_modified:
  - packages/frontend/src/components/WeeklyProgressCards.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Changing thresholds in GOAL_STATUS_THRESHOLDS affects both components"
    - "WeeklyProgressCards uses GOAL_STATUS_THRESHOLDS for status calculation"
  artifacts:
    - path: "packages/frontend/src/components/WeeklyProgressCards.tsx"
      provides: "Status calculation using shared thresholds"
      contains: "GOAL_STATUS_THRESHOLDS"
  key_links:
    - from: "packages/frontend/src/components/WeeklyProgressCards.tsx"
      to: "packages/frontend/src/lib/goalStatus.ts"
      via: "import GOAL_STATUS_THRESHOLDS"
      pattern: "import.*GOAL_STATUS_THRESHOLDS.*from.*goalStatus"
---

<objective>
Fix verification gap: WeeklyProgressCards uses hardcoded threshold values instead of importing from goalStatus.ts.

Purpose: Ensure single source of truth for status thresholds. Currently, changing GOAL_STATUS_THRESHOLDS in goalStatus.ts only affects EarningsChart (via useGoalData), leaving WeeklyProgressCards with stale hardcoded values (1.05, 0.9, 0.4).

Output: WeeklyProgressCards imports GOAL_STATUS_THRESHOLDS and uses them for status calculation, ensuring threshold changes propagate to both components.
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-calculation-unification/22-VERIFICATION.md

# Source files
@packages/frontend/src/lib/goalStatus.ts
@packages/frontend/src/components/WeeklyProgressCards.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import GOAL_STATUS_THRESHOLDS and replace hardcoded values</name>
  <files>packages/frontend/src/components/WeeklyProgressCards.tsx</files>
  <action>
Modify WeeklyProgressCards.tsx to use shared thresholds from goalStatus.ts:

1. **Add import at top** (after the existing imports, around line 18):
```typescript
import { GOAL_STATUS_THRESHOLDS } from '~/lib/goalStatus';
```

2. **Replace hardcoded threshold multipliers** (lines 211-218) with constants:

Current code:
```typescript
} else if (cumulative >= m.cumulativeTarget * 1.05) {
  status = 'ahead';
} else if (cumulative >= m.cumulativeTarget * 0.9) {
  status = 'on-track';
} else if (cumulative >= m.cumulativeTarget * 0.4) {
  status = 'behind';
} else {
  status = 'critical';
}
```

Replace with:
```typescript
} else if (cumulative >= m.cumulativeTarget * GOAL_STATUS_THRESHOLDS.AHEAD) {
  status = 'ahead';
} else if (cumulative >= m.cumulativeTarget * GOAL_STATUS_THRESHOLDS.ON_TRACK) {
  status = 'on-track';
} else if (cumulative >= m.cumulativeTarget * GOAL_STATUS_THRESHOLDS.BEHIND) {
  status = 'behind';
} else {
  status = 'critical';
}
```

**Important context:**
- The status determination logic is inside the `weeks` createMemo (lines 168-233)
- Line 204 declares `let status: WeekData['status'];`
- Lines 205-218 determine status with if/else chain
- Only lines 211, 213, 215 have hardcoded multipliers (1.05, 0.9, 0.4)
- The fallthrough to 'critical' on line 218 remains unchanged (no threshold needed)

**Do NOT change:**
- The stats() memo (lines 238-274) also has threshold-like logic but uses totalEarned/totalTarget which is different from per-week cumulative calculation. Leave it as-is since stats() is for overall summary display, not individual week status.
  </action>
  <verify>
1. Verify import statement exists:
```bash
grep "import.*GOAL_STATUS_THRESHOLDS.*from.*goalStatus" packages/frontend/src/components/WeeklyProgressCards.tsx
```
Expected: Import statement found.

2. Verify hardcoded values are replaced:
```bash
grep -n "1.05\|0.9\|0.4" packages/frontend/src/components/WeeklyProgressCards.tsx
```
Expected: Should NOT find 1.05, 0.9, or 0.4 in the status determination section (lines ~211-218). May still appear in savingsPercent calculation (around line 466-472) which is unrelated.

3. Verify GOAL_STATUS_THRESHOLDS is used:
```bash
grep -n "GOAL_STATUS_THRESHOLDS" packages/frontend/src/components/WeeklyProgressCards.tsx
```
Expected: Import line plus 3 usages (AHEAD, ON_TRACK, BEHIND).

4. Type check passes:
```bash
pnpm typecheck
```
  </verify>
  <done>
WeeklyProgressCards imports GOAL_STATUS_THRESHOLDS from goalStatus.ts and uses GOAL_STATUS_THRESHOLDS.AHEAD, .ON_TRACK, .BEHIND for status calculation. No hardcoded threshold multipliers remain in the status determination logic.
  </done>
</task>

</tasks>

<verification>
After task completion:

1. **Type check passes:**
   ```bash
   pnpm typecheck
   ```

2. **Build succeeds:**
   ```bash
   pnpm build:frontend
   ```

3. **Verify single source of truth:**
   - If GOAL_STATUS_THRESHOLDS.AHEAD is changed from 1.05 to 1.10 in goalStatus.ts, both EarningsChart (via useGoalData) and WeeklyProgressCards would reflect the change.
   - This is the truth that failed verification: "Changing thresholds in GOAL_STATUS_THRESHOLDS affects both components"

4. **No hardcoded thresholds in status logic:**
   ```bash
   # Should not find 1.05, 0.9, 0.4 in the weeks createMemo status determination
   grep -A20 "let status: WeekData" packages/frontend/src/components/WeeklyProgressCards.tsx | grep -E "\* (1\.05|0\.9|0\.4)"
   ```
   Expected: No matches (hardcoded values removed)
</verification>

<success_criteria>
- [ ] WeeklyProgressCards imports GOAL_STATUS_THRESHOLDS from goalStatus.ts
- [ ] Lines 211, 213, 215 use GOAL_STATUS_THRESHOLDS.AHEAD, .ON_TRACK, .BEHIND instead of 1.05, 0.9, 0.4
- [ ] pnpm typecheck passes
- [ ] pnpm build:frontend succeeds
- [ ] Verification gap closed: changing GOAL_STATUS_THRESHOLDS now affects both components
</success_criteria>

<output>
After completion, create `.planning/phases/22-calculation-unification/22-02-SUMMARY.md`
</output>
