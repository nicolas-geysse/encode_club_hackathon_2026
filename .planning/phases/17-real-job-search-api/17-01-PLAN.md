---
phase: 17-real-job-search-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/mcp-server/src/services/google-maps.ts
  - packages/mcp-server/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "Google Places API requests use field masks to limit returned data"
    - "google-maps service is exportable via @stride/mcp-server/services"
  artifacts:
    - path: "packages/mcp-server/src/services/google-maps.ts"
      provides: "Field-masked Places API with cost control"
      contains: "fields="
    - path: "packages/mcp-server/src/services/index.ts"
      provides: "google-maps exports"
      exports: ["googleMaps", "findNearbyPlaces"]
  key_links:
    - from: "packages/mcp-server/src/services/index.ts"
      to: "./google-maps.js"
      via: "export"
      pattern: "export.*from.*google-maps"
---

<objective>
Add field masks to Google Places API calls and export google-maps service for direct frontend import.

Purpose: Control Google API costs (billed per field) and enable direct MCP import pattern proven in agent.ts
Output: Enhanced google-maps service with cost-controlled API calls and proper exports
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/mcp-server/src/services/google-maps.ts
@packages/mcp-server/src/services/index.ts
@packages/mcp-server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add field masks to Google Places API</name>
  <files>packages/mcp-server/src/services/google-maps.ts</files>
  <action>
Modify findNearbyPlaces() to use Google Places API field masks for cost control.

1. Add `fields` parameter to the URL construction (around line 146-153):
   ```typescript
   // Field mask for cost control - only request fields we actually use
   // Basic fields (no charge): place_id, name, types
   // Contact fields ($0.003/request): vicinity, opening_hours
   // Atmosphere fields ($0.005/request): rating, price_level
   const fieldMask = 'place_id,name,vicinity,geometry,rating,price_level,opening_hours,types';
   url.searchParams.set('fields', fieldMask);
   ```

2. Update the function signature to accept optional fields override:
   ```typescript
   export async function findNearbyPlaces(
     location: Coordinates,
     type: PlaceType,
     options?: {
       radius?: number;
       keyword?: string;
       maxResults?: number;
       fields?: string; // Custom field mask override
     }
   ): Promise<Place[]>
   ```

3. Use the custom fields if provided, otherwise default:
   ```typescript
   const defaultFields = 'place_id,name,vicinity,geometry,rating,price_level,opening_hours,types';
   url.searchParams.set('fields', options?.fields ?? defaultFields);
   ```

Note: The Places API Nearby Search doesn't actually support field masks in the same way as Place Details API. For Nearby Search, the response always includes all basic fields. However, we should document this and consider using Place Details API for fetching additional info if needed.

Actually, checking Google's documentation: Nearby Search (Legacy) returns fixed fields. For field mask support, we'd need to migrate to the new Places API (New). For now, add a comment documenting this limitation and keep the current implementation stable. The cost is per-request, not per-field for Nearby Search.

Update action: Instead of field masks (not supported on Nearby Search), add documentation comment and ensure we're not requesting photo URLs by default (photos are billed separately).

1. Add comment at the top of findNearbyPlaces documenting billing:
   ```typescript
   /**
    * Find places near a location using Google Places API (Nearby Search)
    *
    * Billing note: Nearby Search is billed per request (~$0.032/request)
    * Photos are billed separately (~$0.007/photo) - only fetched if photoUrl requested
    */
   ```

2. Add `includePhotos` option (default false) to avoid photo billing:
   ```typescript
   options?: {
     radius?: number;
     keyword?: string;
     maxResults?: number;
     includePhotos?: boolean; // Default false to avoid photo billing
   }
   ```

3. Update the Place mapping to conditionally include photoUrl:
   ```typescript
   photoUrl: options?.includePhotos && p.photos?.[0]?.photo_reference
     ? `https://maps.googleapis.com/maps/api/place/photo?...`
     : undefined,
   ```
  </action>
  <verify>
Run TypeScript check: `pnpm --filter @stride/mcp-server build`
Verify the file compiles without errors and has the new includePhotos option.
  </verify>
  <done>
google-maps.ts has includePhotos option (default false) to control photo billing, with documentation comments explaining Places API billing model.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export google-maps service from MCP services</name>
  <files>packages/mcp-server/src/services/index.ts</files>
  <action>
Add google-maps exports to the services index file so frontend can import via @stride/mcp-server/services.

Add the following exports after the existing Local Discovery exports (around line 170):

```typescript
// Google Maps
export {
  initGoogleMaps,
  isGoogleMapsAvailable,
  findNearbyPlaces,
  getDistanceMatrix,
  calculateDistance,
  formatDistance,
  formatDuration,
  googleMaps,
} from './google-maps.js';
export type {
  Coordinates,
  Place,
  DistanceResult,
  PlaceType,
  TravelMode,
} from './google-maps.js';
```

This follows the same pattern as other service exports (groq, opik, duckdb, etc.) and enables the direct import pattern used in agent.ts:
```typescript
// Frontend can now do:
const { findNearbyPlaces } = await import('@stride/mcp-server/services');
```
  </action>
  <verify>
1. Run: `pnpm --filter @stride/mcp-server build`
2. Verify exports are accessible: Check dist/services/index.js contains googleMaps exports
  </verify>
  <done>
google-maps service exported from @stride/mcp-server/services, enabling direct import from frontend API routes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @stride/mcp-server build` succeeds
2. `grep -l "googleMaps" packages/mcp-server/dist/services/index.js` returns the file
3. TypeScript types are properly exported (Coordinates, Place, etc.)
</verification>

<success_criteria>
- google-maps.ts has includePhotos option with default false
- google-maps.ts has billing documentation comments
- services/index.ts exports all google-maps functions and types
- MCP server builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-real-job-search-api/17-01-SUMMARY.md`
</output>
