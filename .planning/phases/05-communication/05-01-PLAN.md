---
phase: 05-communication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/src/components/swipe/SwipeSession.tsx
  - packages/frontend/src/components/tabs/SwipeTab.tsx
  - packages/frontend/src/components/chat/OnboardingChat.tsx
autonomous: true

must_haves:
  truths:
    - "Swiping in embed mode sends postMessage to parent window"
    - "OnboardingChat receives swipe_completed messages"
    - "Chat displays contextual acknowledgment for each swipe"
  artifacts:
    - path: "packages/frontend/src/components/swipe/SwipeSession.tsx"
      provides: "postMessage call when embedMode is true"
      contains: "window.parent.postMessage"
    - path: "packages/frontend/src/components/chat/OnboardingChat.tsx"
      provides: "postMessage listener for swipe events"
      contains: "swipe_completed"
  key_links:
    - from: "SwipeSession.tsx"
      to: "OnboardingChat.tsx"
      via: "postMessage('swipe_completed')"
      pattern: "postMessage.*swipe_completed"
---

<objective>
Add postMessage communication between SwipeSession (in iframe) and OnboardingChat (parent).

Purpose: Complete the communication phase so swipe actions in the embed are acknowledged in chat.
Output: Modified SwipeSession, SwipeTab, and OnboardingChat with postMessage bridge.
</objective>

<execution_context>
@/home/nico/.claude/get-shit-done/workflows/execute-plan.md
@/home/nico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-communication/05-CONTEXT.md

Key facts:
- SwipeSession.tsx handles swipes in handleSwipe function (line 178)
- SwipeSession has 4 directions: right, left, up, down
- SwipeTab.tsx passes props to SwipeSession (lines 315-321)
- SwipeTab already has embedMode prop (line 47)
- OnboardingChat.tsx uses onMount/onCleanup pattern (line 8, 937)
- OnboardingChat uses setMessages to add chat messages (line 202)

@packages/frontend/src/components/swipe/SwipeSession.tsx
@packages/frontend/src/components/tabs/SwipeTab.tsx
@packages/frontend/src/components/chat/OnboardingChat.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add embedMode prop to SwipeSession and send postMessage</name>
  <files>packages/frontend/src/components/swipe/SwipeSession.tsx</files>
  <action>
1. **Add embedMode to SwipeSessionProps interface** (around line 32):
```tsx
interface SwipeSessionProps {
  scenarios: Scenario[];
  initialPreferences: UserPreferences;
  currency?: Currency;
  profileId?: string;
  embedMode?: boolean;  // ADD THIS
  onComplete: (
    accepted: Scenario[],
    rejected: Scenario[],
    preferences: UserPreferences,
    mehIds?: Set<string>
  ) => void;
}
```

2. **Add postMessage in handleSwipe function** (inside handleSwipe, after the Opik trace fetch block, around line 256):

After the `.catch((err) => { ... });` block and before the `// Save to history for undo` comment, add:

```tsx
    // Notify parent window if in embed mode (Phase 5: Communication)
    if (props.embedMode && typeof window !== 'undefined') {
      window.parent.postMessage(
        {
          type: 'swipe_completed',
          direction,
          scenarioTitle: scenario.title,
          scenarioId: scenario.id,
        },
        '*'
      );
    }
```
  </action>
  <verify>
1. Check that SwipeSessionProps includes embedMode
2. Check that handleSwipe has the postMessage call
3. Run `pnpm typecheck` - must pass
  </verify>
  <done>
- SwipeSession accepts embedMode prop
- postMessage sent on swipe when embedMode is true
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass embedMode from SwipeTab to SwipeSession</name>
  <files>packages/frontend/src/components/tabs/SwipeTab.tsx</files>
  <action>
1. **Add embedMode prop to SwipeSession call** (around line 315-321):

Change:
```tsx
        <SwipeSession
          scenarios={scenarios()}
          initialPreferences={preferences()}
          currency={currency()}
          profileId={props.profileId}
          onComplete={handleSwipeComplete}
        />
```

To:
```tsx
        <SwipeSession
          scenarios={scenarios()}
          initialPreferences={preferences()}
          currency={currency()}
          profileId={props.profileId}
          embedMode={props.embedMode}
          onComplete={handleSwipeComplete}
        />
```
  </action>
  <verify>
1. Check that SwipeSession receives embedMode prop
2. Run `pnpm typecheck` - must pass
  </verify>
  <done>
- SwipeTab passes embedMode to SwipeSession
  </done>
</task>

<task type="auto">
  <name>Task 3: Add postMessage listener to OnboardingChat</name>
  <files>packages/frontend/src/components/chat/OnboardingChat.tsx</files>
  <action>
1. **Add message listener inside onMount** (at the start of onMount, after line 937):

Add right after `onMount(async () => {`:

```tsx
    // Phase 5: Listen for swipe_completed messages from embed iframe
    const handleSwipeMessage = (event: MessageEvent) => {
      if (event.data?.type === 'swipe_completed') {
        const { direction, scenarioTitle } = event.data;

        // Generate acknowledgment based on direction
        let acknowledgment: string;
        switch (direction) {
          case 'right':
          case 'up':
            acknowledgment = `✓ Strategy accepted: ${scenarioTitle}`;
            break;
          case 'left':
            acknowledgment = `✗ Skipped: ${scenarioTitle}`;
            break;
          case 'down':
            acknowledgment = `○ Noted: ${scenarioTitle} isn't for you`;
            break;
          default:
            acknowledgment = `Swipe recorded: ${scenarioTitle}`;
        }

        // Add acknowledgment as assistant message
        const ackMsg: Message = {
          id: `swipe-ack-${Date.now()}`,
          role: 'assistant',
          content: acknowledgment,
        };
        setMessages((prev) => [...prev, ackMsg]);
      }
    };

    window.addEventListener('message', handleSwipeMessage);

    onCleanup(() => {
      window.removeEventListener('message', handleSwipeMessage);
    });
```

Note: The `onCleanup` import is already present at line 8.
  </action>
  <verify>
1. Check that handleSwipeMessage function exists
2. Check that addEventListener and removeEventListener are called
3. Run `pnpm typecheck` - must pass
  </verify>
  <done>
- OnboardingChat listens for swipe_completed messages
- Acknowledgment messages appear in chat
- Listener is cleaned up on unmount
  </done>
</task>

</tasks>

<verification>
After task completion:

1. **TypeScript:** `pnpm typecheck` passes
2. **Manual test - Desktop:**
   - Navigate to homepage (/)
   - Type "swipe" in chat to trigger swipe intent
   - Iframe should appear with SwipeTab
   - Swipe a card right → chat shows "✓ Strategy accepted: {title}"
   - Swipe a card left → chat shows "✗ Skipped: {title}"
   - Swipe a card up → chat shows "✓ Strategy accepted: {title}"
   - Swipe a card down → chat shows "○ Noted: {title} isn't for you"
3. **No console errors** related to postMessage
</verification>

<success_criteria>
- COMM-01: SwipeTab in embed mode sends postMessage ✓
- COMM-02: OnboardingChat listens for swipe_completed messages ✓
- COMM-03: Chat displays acknowledgment when swipe is completed ✓
</success_criteria>

<output>
After completion, create `.planning/phases/05-communication/05-01-SUMMARY.md`
</output>
