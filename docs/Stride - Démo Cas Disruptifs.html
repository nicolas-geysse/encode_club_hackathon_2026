<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stride - Demo Complete</title>
    <style>
        :root {
            --color-primary: #38bdf8;
            --color-primary-hover: #0284c7;
            --color-primary-dark: #0c4a6e;
            --color-bg-base: #0f172a;
            --color-bg-elevated: #020617;
            --color-bg-surface: #1e293b;
            --color-bg-muted: #334155;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            --color-success: #22c55e;
            --color-warning: #ef4444;
            --color-info: #3b82f6;
            --color-orange: #f59e0b;
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.2);
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%; height: 100%;
            background: var(--color-bg-base);
            color: var(--color-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        .container { display: flex; height: 100vh; width: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 300px;
            background: var(--color-bg-elevated);
            border-right: 1px solid var(--color-bg-surface);
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-bg-surface);
        }

        .nav-section { display: flex; flex-direction: column; gap: 6px; }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-muted);
            padding: 0 12px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-button {
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            text-align: left;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .nav-button:hover { background: var(--color-bg-surface); color: var(--color-text-primary); }
        .nav-button.active { background: var(--color-primary); color: var(--color-bg-base); }
        .nav-button.active .menu-badge { background: var(--color-bg-base); color: var(--color-primary); }

        .nav-emoji { font-size: 14px; min-width: 24px; text-align: center; }
        .nav-text { flex: 1; }

        /* Menu Badges */
        .menu-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        .menu-badge.info { background: var(--color-info); color: white; }
        .menu-badge.success { background: var(--color-success); color: white; }
        .menu-badge.warning { background: var(--color-warning); color: white; }
        .menu-badge.pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Profile Section */
        .profile-section {
            background: var(--color-bg-surface);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .profile-select {
            width: 100%;
            padding: 8px 12px;
            background: var(--color-bg-muted);
            border: 1px solid var(--color-bg-surface);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .profile-info {
            font-size: 11px;
            color: var(--color-text-muted);
            padding: 8px;
            background: var(--color-bg-base);
            border-radius: var(--radius-sm);
            display: none;
        }
        .profile-info.show { display: block; }

        /* Notifications Bell (Header) */
        .notif-bell {
            position: relative;
            width: 40px;
            height: 40px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }
        .notif-bell:hover { background: var(--color-bg-surface); }

        .notif-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--color-warning);
            color: white;
            font-size: 10px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .notif-count.hidden { display: none; }

        .notif-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            width: 300px;
            background: var(--color-bg-surface);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .notif-dropdown.show { display: block; }

        .notif-dropdown-header {
            padding: 12px 16px;
            background: var(--color-bg-muted);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notif-dropdown-clear {
            font-size: 11px;
            color: var(--color-primary);
            cursor: pointer;
        }

        .notification-list { max-height: 250px; overflow-y: auto; }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-bg-muted);
            display: flex;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .notification-item:hover { background: var(--color-bg-muted); }
        .notification-item.unread { background: rgba(56, 189, 248, 0.1); }
        .notification-item:last-child { border-bottom: none; }

        .notif-icon { font-size: 16px; }
        .notif-content { flex: 1; }
        .notif-text { font-size: 12px; color: var(--color-text-primary); }
        .notif-time { font-size: 10px; color: var(--color-text-muted); margin-top: 2px; }

        .notif-empty {
            padding: 24px;
            text-align: center;
            color: var(--color-text-muted);
            font-size: 13px;
        }

        /* MAIN CONTENT */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .header {
            background: var(--color-bg-surface);
            border-bottom: 1px solid var(--color-bg-muted);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title { font-size: 22px; font-weight: 700; }
        .header-subtitle { font-size: 13px; color: var(--color-text-secondary); margin-top: 2px; }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .reset-btn {
            padding: 8px 16px;
            background: var(--color-bg-muted);
            color: var(--color-text-primary);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        .reset-btn:hover { background: var(--color-bg-surface); }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Interaction Prompt */
        .interaction-prompt {
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-bg-surface) 100%);
            border: 1px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            display: none;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        .interaction-prompt.show { display: flex; }

        .prompt-icon { font-size: 28px; }
        .prompt-content { flex: 1; }
        .prompt-title { font-weight: 600; font-size: 14px; }
        .prompt-text { font-size: 13px; color: var(--color-text-secondary); margin-top: 4px; }
        .prompt-actions { display: flex; gap: 8px; }
        .prompt-actions button {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        .prompt-actions .primary { background: var(--color-primary); color: var(--color-bg-base); }
        .prompt-actions .secondary { background: var(--color-bg-muted); color: var(--color-text-primary); }

        /* Case containers */
        .case-container { display: none; flex-direction: column; gap: 20px; }
        .case-container.active { display: flex; }

        .case-header { border-bottom: 2px solid var(--color-primary); padding-bottom: 12px; }
        .case-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
        .case-description { font-size: 13px; color: var(--color-text-secondary); line-height: 1.5; }

        .card {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-md);
        }

        /* ONBOARDING CHAT */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.bot {
            background: var(--color-bg-muted);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-message.user {
            background: var(--color-primary);
            color: var(--color-bg-base);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-message.confirmation {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--color-success);
            align-self: flex-start;
        }

        .confirmation-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .confirmation-buttons button {
            padding: 6px 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        .confirm-yes { background: var(--color-success); color: white; }
        .confirm-no { background: var(--color-bg-muted); color: var(--color-text-primary); }

        .chat-input-zone {
            padding: 16px;
            background: var(--color-bg-muted);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input-zone input {
            flex: 1;
            padding: 12px 16px;
            background: var(--color-bg-surface);
            border: 1px solid var(--color-bg-surface);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 14px;
        }
        .chat-input-zone input:focus { outline: none; border-color: var(--color-primary); }

        .voice-btn, .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .voice-btn { background: var(--color-bg-surface); color: var(--color-text-primary); }
        .voice-btn:hover { background: var(--color-warning); color: white; }
        .voice-btn.recording { background: var(--color-warning); color: white; animation: pulse 1s infinite; }
        .send-btn { background: var(--color-primary); color: var(--color-bg-base); }
        .send-btn:hover { background: var(--color-primary-hover); }

        /* Onboarding Summary */
        .onboarding-summary {
            display: none;
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
        }
        .onboarding-summary.show { display: block; animation: fadeIn 0.3s ease; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        .summary-item {
            background: var(--color-bg-muted);
            padding: 12px;
            border-radius: var(--radius-sm);
        }
        .summary-label { font-size: 11px; color: var(--color-text-muted); text-transform: uppercase; }
        .summary-value { font-size: 14px; font-weight: 600; margin-top: 4px; }

        .next-steps { margin-top: 20px; }
        .next-steps h4 { font-size: 14px; margin-bottom: 12px; }
        .next-steps ol { padding-left: 20px; }
        .next-steps li { font-size: 13px; color: var(--color-text-secondary); margin-bottom: 8px; }

        .start-btn {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        .start-btn:hover { background: var(--color-primary-hover); }

        /* Existing case styles */
        .crunch-alert, .energy-warning {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-left: 4px solid #fca5a5;
            padding: 14px 18px;
            border-radius: var(--radius-md);
        }
        .crunch-alert-title, .warning-title { font-weight: 700; margin-bottom: 4px; }
        .crunch-alert-text, .warning-text { font-size: 13px; color: rgba(255,255,255,0.95); }

        .crunch-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0; }
        .stat-box { background: var(--color-bg-muted); padding: 14px; border-radius: var(--radius-md); text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--color-primary); }
        .stat-label { font-size: 11px; color: var(--color-text-muted); text-transform: uppercase; margin-top: 4px; }

        .comeback-plan { background: var(--color-bg-muted); border-left: 4px solid var(--color-success); padding: 14px; border-radius: var(--radius-md); }
        .comeback-plan-title { font-weight: 700; color: var(--color-success); margin-bottom: 8px; }

        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: var(--color-bg-base);
            padding: 10px 14px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 13px;
            margin-top: 12px;
        }

        .comparison-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .comparison-table th, .comparison-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--color-bg-muted); }
        .comparison-table th { background: var(--color-bg-muted); font-weight: 600; }

        /* Swipe */
        .swipe-container { display: flex; flex-direction: column; align-items: center; padding: 20px 0; }
        .swipe-card {
            width: 280px;
            background: var(--color-bg-surface);
            border: 2px solid var(--color-bg-muted);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
        }
        .swipe-emoji { font-size: 40px; margin-bottom: 12px; }
        .swipe-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
        .swipe-value { font-size: 20px; font-weight: 700; color: var(--color-primary); margin-bottom: 8px; }
        .swipe-description { font-size: 12px; color: var(--color-text-secondary); line-height: 1.5; }
        .swipe-controls { display: flex; gap: 16px; justify-content: center; margin-top: 16px; }
        .swipe-btn {
            width: 48px; height: 48px;
            border-radius: 50%;
            border: 2px solid;
            background: transparent;
            cursor: pointer;
            font-size: 20px;
        }
        .swipe-btn.no { border-color: var(--color-warning); color: var(--color-warning); }
        .swipe-btn.yes { border-color: var(--color-success); color: var(--color-success); }
        .swipe-counter { margin-top: 16px; font-size: 13px; color: var(--color-text-muted); }
        .swipe-selected { margin-top: 20px; padding: 16px; background: var(--color-bg-muted); border-radius: var(--radius-md); display: none; }
        .swipe-selected.show { display: block; }

        /* Roll the Dice */
        .roll-dice-container {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .roll-dice-box {
            background: linear-gradient(135deg, var(--color-bg-surface), var(--color-bg-muted));
            border: 2px solid var(--color-primary);
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            max-width: 400px;
        }
        .roll-dice-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .roll-dice-description {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }
        .roll-dice-summary {
            background: var(--color-bg-base);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
        }
        .summary-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-bg-muted);
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-icon { font-size: 18px; }
        .summary-label { flex: 1; text-align: left; font-size: 13px; color: var(--color-text-secondary); }
        .summary-value { font-weight: 600; color: var(--color-primary); font-size: 13px; }
        .roll-dice-btn {
            background: linear-gradient(135deg, var(--color-primary), #0284c7);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
        }
        .roll-dice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(56, 189, 248, 0.4);
        }
        .roll-dice-btn .dice-emoji {
            font-size: 24px;
            animation: diceShake 0.5s ease-in-out infinite;
        }
        @keyframes diceShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
        .roll-dice-warning {
            margin-top: 16px;
            font-size: 11px;
            color: var(--color-orange);
        }

        /* Swipe locked banner */
        .swipe-locked-banner {
            background: var(--color-orange);
            color: white;
            padding: 10px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-size: 13px;
            font-weight: 500;
        }
        .swipe-locked-banner button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        .swipe-locked-banner button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Frozen state overlay for tabs */
        .plan-tab.frozen {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }
        .plan-tab.frozen::after {
            content: 'ðŸ”’';
            position: absolute;
            right: 8px;
        }
        .nav-button.frozen {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Energy */
        .energy-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 16px 0; }
        .energy-item {
            background: var(--color-bg-muted);
            padding: 14px 8px;
            border-radius: var(--radius-md);
            text-align: center;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .energy-item:hover { border-color: var(--color-primary); }
        .energy-item.selected { background: var(--color-primary); border-color: var(--color-primary); color: var(--color-bg-base); }
        .energy-emoji { font-size: 24px; margin-bottom: 6px; }
        .energy-label { font-size: 10px; font-weight: 600; text-transform: uppercase; }

        .energy-week {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            margin-bottom: 6px;
        }
        .energy-week-label { font-size: 13px; font-weight: 600; min-width: 80px; }
        .energy-bar-container { flex: 1; height: 8px; background: var(--color-bg-surface); border-radius: 4px; margin: 0 12px; }
        .energy-bar { height: 100%; background: linear-gradient(90deg, #ef4444 0%, #eab308 50%, #22c55e 100%); border-radius: 4px; }
        .energy-week-value { font-size: 13px; font-weight: 700; color: var(--color-primary); min-width: 40px; text-align: right; }

        .action-plan { background: var(--color-bg-muted); padding: 14px; border-radius: var(--radius-md); border-left: 4px solid var(--color-success); }
        .action-title { font-weight: 700; color: var(--color-success); margin-bottom: 10px; }
        .action-item { display: flex; gap: 8px; font-size: 13px; margin-bottom: 6px; }
        .action-bullet { color: var(--color-success); font-weight: 700; min-width: 20px; }

        /* Why disruptive box */
        .disruptive-box {
            margin-top: 16px;
            padding: 14px;
            background: var(--color-bg-surface);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
        }
        .disruptive-box h4 { font-size: 13px; margin-bottom: 8px; }
        .disruptive-box p { font-size: 12px; color: var(--color-text-secondary); line-height: 1.6; }

        /* Opik Panel */
        .opik-panel {
            background: var(--color-bg-surface);
            border-radius: var(--radius-md);
            margin-top: auto;
            overflow: hidden;
        }
        .opik-header {
            padding: 10px 12px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }
        .opik-header a { color: white; text-decoration: none; font-size: 11px; }
        .opik-trace-list { padding: 8px; }
        .trace-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            font-size: 11px;
            background: var(--color-bg-muted);
            border-radius: 4px;
            margin-bottom: 4px;
        }
        .trace-name { font-family: monospace; color: var(--color-primary); }
        .trace-duration { color: var(--color-text-muted); }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }
        .toast.show { display: flex; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast.success { border-left: 4px solid var(--color-success); }
        .toast-icon { font-size: 16px; }
        .toast-message { font-size: 13px; }
        .toast-close { background: none; border: none; color: var(--color-text-muted); cursor: pointer; font-size: 16px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-bg-muted); border-radius: 3px; }

        /* ========== SKILL ARBITRAGE ENHANCEMENTS ========== */

        /* Card Header with Add Skill button */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .card-header-info strong { display: block; margin-bottom: 4px; }
        .card-header-info .formula { font-size: 12px; color: var(--color-text-muted); }

        .add-skill-btn {
            padding: 8px 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .add-skill-btn:hover { background: var(--color-primary-hover); }

        /* Action buttons in table */
        .action-cell {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }

        .explain-btn, .feedback-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--color-bg-muted);
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .explain-btn { color: var(--color-info); }
        .explain-btn:hover { background: var(--color-info); color: white; }
        .feedback-btn.thumbs-up { color: var(--color-success); }
        .feedback-btn.thumbs-up:hover { background: var(--color-success); color: white; }
        .feedback-btn.thumbs-down { color: var(--color-warning); }
        .feedback-btn.thumbs-down:hover { background: var(--color-warning); color: white; }

        .feedback-btn.validated { background: var(--color-success); color: white; opacity: 0.7; }
        .feedback-btn.contested { background: var(--color-warning); color: white; opacity: 0.7; }

        /* Explainability Panel */
        .explainability-panel {
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 16px;
            margin: 8px 0;
            display: none;
            animation: slideDown 0.2s ease;
        }
        .explainability-panel.show { display: block; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .explain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-bg-surface);
        }
        .explain-title { font-weight: 600; font-size: 13px; }
        .explain-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 18px;
        }

        .explain-row {
            display: grid;
            grid-template-columns: 1fr 60px 60px 60px;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--color-bg-surface);
            font-size: 12px;
        }
        .explain-criterion { color: var(--color-text-secondary); }
        .explain-raw { text-align: right; }
        .explain-weight { text-align: right; color: var(--color-text-muted); }
        .explain-contrib { text-align: right; color: var(--color-primary); font-weight: 600; }

        .explain-total {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            padding-top: 10px;
            font-size: 13px;
        }
        .explain-score { color: var(--color-primary); }

        .trace-link {
            font-size: 11px;
            color: var(--color-info);
            cursor: pointer;
            margin-top: 10px;
            display: block;
            text-decoration: underline;
        }

        /* Contest Chat */
        .contest-chat, .add-skill-chat {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: 12px;
            margin: 8px 0;
            display: none;
            animation: slideDown 0.2s ease;
        }
        .contest-chat.show, .add-skill-chat.show { display: block; }

        .contest-header, .add-skill-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-bg-muted);
            margin-bottom: 8px;
        }
        .contest-emoji, .add-skill-emoji { font-size: 16px; }
        .contest-title, .add-skill-title { font-weight: 600; font-size: 13px; flex: 1; }
        .contest-close, .add-skill-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 16px;
        }

        .contest-messages, .add-skill-messages {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 8px;
        }

        .contest-msg, .add-skill-msg {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            font-size: 13px;
            max-width: 85%;
        }
        .contest-msg.bot, .add-skill-msg.bot {
            background: var(--color-bg-muted);
        }
        .contest-msg.user, .add-skill-msg.user {
            background: var(--color-primary);
            color: var(--color-bg-base);
            margin-left: auto;
        }
        .contest-msg.result {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--color-success);
        }

        .contest-input-zone, .add-skill-input-zone {
            display: flex;
            gap: 8px;
        }
        .contest-input-zone input, .add-skill-input-zone input {
            flex: 1;
            padding: 8px 12px;
            background: var(--color-bg-muted);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 13px;
        }
        .contest-input-zone input:focus, .add-skill-input-zone input:focus {
            outline: none;
            box-shadow: 0 0 0 1px var(--color-primary);
        }
        .contest-input-zone button, .add-skill-input-zone button {
            padding: 8px 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
        }

        .contest-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .contest-actions button {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 12px;
            cursor: pointer;
        }
        .contest-actions .apply { background: var(--color-success); color: white; }
        .contest-actions .cancel { background: var(--color-bg-muted); color: var(--color-text-primary); }

        /* New jobs preview */
        .new-jobs-preview {
            background: var(--color-bg-muted);
            border-radius: var(--radius-sm);
            padding: 10px;
            margin: 8px 0;
        }
        .new-jobs-preview-title { font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--color-success); }
        .new-job-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--color-bg-surface);
        }
        .new-job-row:last-child { border-bottom: none; }

        /* ========== ENERGY CHECK POPUP ========== */
        .energy-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .energy-popup-overlay.show { display: flex; }

        .energy-popup {
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            width: 420px;
            max-width: 90%;
            text-align: center;
            animation: popIn 0.3s ease;
        }
        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .energy-popup-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
        }

        .energy-emoji-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .energy-emoji-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 2px solid var(--color-bg-muted);
            background: var(--color-bg-muted);
            cursor: pointer;
            font-size: 28px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .energy-emoji-btn:hover { border-color: var(--color-primary); transform: scale(1.1); }
        .energy-emoji-btn.selected { border-color: var(--color-primary); background: var(--color-primary); }

        .energy-percent-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            font-size: 11px;
            color: var(--color-text-muted);
            margin-bottom: 24px;
        }
        .energy-percent-row span { width: 56px; text-align: center; }

        .energy-factors-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--color-text-secondary);
        }

        .energy-factors-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .energy-factor-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .energy-factor-checkbox:hover { border-color: var(--color-bg-surface); }
        .energy-factor-checkbox.selected { border-color: var(--color-primary); background: rgba(56, 189, 248, 0.15); }
        .energy-factor-checkbox.positive.selected { border-color: var(--color-success); background: rgba(34, 197, 94, 0.15); }

        .energy-factor-icon { font-size: 14px; }

        .energy-popup-submit {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
        }
        .energy-popup-submit.enabled { opacity: 1; pointer-events: auto; }
        .energy-popup-submit.enabled:hover { background: var(--color-primary-hover); }

        /* ========== DAY SIMULATOR ========== */
        .day-simulator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-right: 8px;
        }

        .day-counter {
            display: flex;
            align-items: baseline;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 14px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-sm);
        }
        .day-label { color: var(--color-text-muted); font-size: 11px; margin-right: 4px; }
        .day-current { color: var(--color-primary); font-size: 18px; }
        .day-separator { color: var(--color-text-muted); }
        .day-total { color: var(--color-text-secondary); }

        .next-day-btn {
            padding: 8px 16px;
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .next-day-btn:hover { background: #16a34a; }
        .next-day-btn:disabled {
            background: var(--color-bg-muted);
            color: var(--color-text-muted);
            cursor: not-allowed;
        }
        .next-day-btn:disabled:hover { background: var(--color-bg-muted); }

        /* ========== PLAN TABS ========== */
        .plan-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--color-bg-muted);
            padding-bottom: 4px;
        }

        .plan-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .plan-tab:hover { background: var(--color-bg-muted); color: var(--color-text-primary); }
        .plan-tab.active { background: var(--color-primary); color: var(--color-bg-base); }

        .plan-tab-content { display: none; }
        .plan-tab-content.active { display: block; }

        /* ========== SETUP SCREEN ========== */
        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .setup-field {
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .setup-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .setup-label-icon { font-size: 18px; }

        .setup-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .setup-input {
            padding: 10px 14px;
            background: var(--color-bg-surface);
            border: 1px solid var(--color-bg-surface);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 14px;
            width: 120px;
        }
        .setup-input:focus { outline: none; border-color: var(--color-primary); }
        .setup-input.wide { width: 200px; }

        .setup-events-list {
            margin-top: 10px;
        }

        .setup-event-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--color-bg-surface);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            font-size: 13px;
        }
        .setup-event-item .event-icon { color: var(--color-warning); }

        .add-event-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px dashed var(--color-bg-surface);
            border-radius: var(--radius-sm);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 12px;
            width: 100%;
        }
        .add-event-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }

        .setup-submit {
            padding: 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .setup-submit:hover { background: var(--color-primary-hover); }

        /* ========== CITY SELECTOR ========== */
        .city-selector {
            margin-top: 8px;
        }
        .city-dropdown {
            padding: 12px 16px;
            background: var(--color-bg-surface);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }
        .city-dropdown:focus { border-color: var(--color-primary); outline: none; }

        /* ========== INVENTORY CHIPS (Onboarding) ========== */
        .inventory-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .inventory-chip {
            padding: 10px 16px;
            background: var(--color-bg-muted);
            border-radius: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .inventory-chip:hover { border-color: var(--color-primary); }
        .inventory-chip.selected {
            background: var(--color-primary);
            color: var(--color-bg-base);
            border-color: var(--color-primary);
        }

        /* ========== INVENTORY TAB ========== */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .inventory-item {
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .inventory-item:hover { border-color: var(--color-primary); }
        .inventory-item.posted { border-color: var(--color-warning); }
        .inventory-item.sold { opacity: 0.6; border-color: var(--color-success); }
        .inventory-icon { font-size: 32px; text-align: center; }
        .inventory-name { font-weight: 600; font-size: 14px; text-align: center; }
        .inventory-price { color: var(--color-success); font-weight: 700; font-size: 16px; text-align: center; }
        .inventory-platform { font-size: 11px; color: var(--color-text-muted); text-align: center; }
        .inventory-actions { display: flex; gap: 6px; margin-top: 8px; }
        .inventory-btn {
            flex: 1;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }
        .inventory-btn.post { background: var(--color-primary); color: var(--color-bg-base); }
        .inventory-btn.sold { background: var(--color-success); color: white; }
        .inventory-btn.remove { background: var(--color-bg-surface); color: var(--color-text-muted); }
        .inventory-total {
            background: linear-gradient(135deg, var(--color-success), #16a34a);
            padding: 16px;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            color: white;
        }
        .inventory-total-label { font-size: 14px; }
        .inventory-total-value { font-size: 20px; font-weight: 700; }
        .local-suggestions {
            margin-top: 16px;
            padding: 14px;
            background: rgba(56, 189, 248, 0.1);
            border-left: 3px solid var(--color-primary);
            border-radius: var(--radius-sm);
        }
        .local-suggestions-title { font-weight: 600; font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .local-suggestion-item { font-size: 12px; color: var(--color-text-secondary); padding: 4px 0; }

        /* ========== MISSION POPUP (3 Steps) ========== */
        .mission-popup {
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 500px;
            max-width: 95%;
            animation: popIn 0.3s ease;
        }
        .mission-step { display: none; }
        .mission-step.active { display: block; }
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-bg-muted);
            transition: all 0.2s;
        }
        .step-dot.active { background: var(--color-primary); transform: scale(1.2); }
        .step-dot.completed { background: var(--color-success); }

        /* Feedback Section (Step 2) */
        .feedback-section { margin: 16px 0; }
        .feedback-task {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }
        .feedback-task-icon { font-size: 24px; }
        .feedback-task-text { flex: 1; font-size: 14px; }
        .feedback-btns { display: flex; gap: 8px; }
        .feedback-btn {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .feedback-btn.success { background: var(--color-success); color: white; }
        .feedback-btn.pending { background: var(--color-bg-surface); color: var(--color-text-secondary); }
        .feedback-btn.success:hover { filter: brightness(1.1); }
        .feedback-btn.pending:hover { background: var(--color-bg-muted); }
        .sale-amount-input {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: var(--radius-sm);
            align-items: center;
            gap: 8px;
        }
        .sale-amount-input.show { display: flex; }
        .sale-amount-input input {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-success);
            background: var(--color-bg-surface);
            color: var(--color-text-primary);
            width: 80px;
            font-size: 14px;
        }
        .feedback-empty { color: var(--color-text-muted); font-size: 13px; text-align: center; padding: 20px; }

        /* Missions List (Step 3) */
        .missions-list { margin-top: 16px; }
        .mission-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            border-left: 4px solid var(--color-primary);
        }
        .mission-card.priority { border-left-color: var(--color-warning); }
        .mission-card.food { border-left-color: var(--color-success); }
        .mission-card.local { border-left-color: #a855f7; }
        .mission-icon { font-size: 24px; }
        .mission-info { flex: 1; }
        .mission-title { font-weight: 600; font-size: 14px; }
        .mission-desc { font-size: 12px; color: var(--color-text-muted); margin-top: 2px; }
        .mission-reward { font-size: 13px; font-weight: 700; color: var(--color-success); }

        /* ========== MISSIONS HISTORY (Track) ========== */
        .missions-history { margin-top: 24px; }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .history-header h4 { font-size: 14px; font-weight: 600; }
        .history-stats { display: flex; gap: 12px; }
        .history-stat {
            background: var(--color-bg-muted);
            padding: 10px 16px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        .history-stat-value { font-size: 18px; font-weight: 700; color: var(--color-success); }
        .history-stat-label { font-size: 10px; color: var(--color-text-muted); text-transform: uppercase; }
        .history-list { max-height: 200px; overflow-y: auto; }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--color-bg-surface);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            font-size: 12px;
            border-left: 3px solid transparent;
        }
        .history-item.completed { border-left-color: var(--color-success); }
        .history-item.pending { border-left-color: var(--color-warning); }
        .history-item-icon { font-size: 16px; }
        .history-item-text { flex: 1; }
        .history-item-result { font-weight: 600; }
        .history-item-result.earned { color: var(--color-success); }

        /* Mission action buttons */
        .history-item-actions {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        .mission-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .mission-btn.validate {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }
        .mission-btn.validate:hover {
            background: var(--color-success);
            color: white;
        }
        .mission-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-warning);
        }
        .mission-btn.delete:hover {
            background: var(--color-warning);
            color: white;
        }

        /* Swipe missions section */
        .swipe-missions-section {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(56, 189, 248, 0.05));
            border: 1px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
        }
        .swipe-missions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .swipe-missions-count {
            background: var(--color-primary);
            color: white;
            font-size: 12px;
            padding: 2px 10px;
            border-radius: 10px;
        }
        .swipe-missions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .swipe-mission-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--color-bg-surface);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--color-primary);
        }
        .swipe-mission-item.completed {
            border-left-color: var(--color-success);
            opacity: 0.7;
        }
        .swipe-mission-icon { font-size: 18px; }
        .swipe-mission-info { flex: 1; }
        .swipe-mission-title { font-weight: 500; font-size: 13px; }
        .swipe-mission-value { font-size: 12px; color: var(--color-primary); }

        /* ========== ACTION HUB ========== */
        .action-hub-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2100;
        }
        .action-hub-overlay.show { display: flex; }

        .action-hub {
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            width: 520px;
            max-width: 95%;
            animation: popIn 0.3s ease;
        }

        .action-hub-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .action-hub-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .action-hub-subtitle {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .action-hub-progress {
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 24px;
        }
        .action-hub-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .action-hub-progress-label {
            font-size: 14px;
            font-weight: 600;
        }
        .action-hub-progress-percent {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }
        .action-hub-progress-bar {
            height: 12px;
            background: var(--color-bg-surface);
            border-radius: 6px;
            overflow: hidden;
        }
        .action-hub-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-success));
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .action-hub-progress-text {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-top: 8px;
            text-align: center;
        }

        .action-hub-question {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
        }

        .action-hub-main-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        .action-hub-main-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .action-hub-main-btn .recommended-tag {
            background: rgba(0,0,0,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        .action-hub-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .action-hub-btn {
            padding: 14px;
            background: var(--color-bg-muted);
            color: var(--color-text-primary);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .action-hub-btn:hover {
            border-color: var(--color-primary);
            background: rgba(56, 189, 248, 0.1);
        }

        .action-hub-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        /* ========== PROGRESSION HEADER ========== */
        .progress-mini {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-sm);
            cursor: pointer;
            position: relative;
        }
        .progress-mini-icon { font-size: 14px; }
        .progress-mini-percent {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-primary);
        }
        .progress-mini-bar {
            width: 60px;
            height: 6px;
            background: var(--color-bg-surface);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-success));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-mini-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--color-bg-surface);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 14px;
            min-width: 200px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        .progress-mini:hover .progress-mini-tooltip { display: block; }
        .progress-tooltip-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .progress-tooltip-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 10px;
        }
        .progress-tooltip-detail {
            font-size: 11px;
            color: var(--color-text-muted);
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }

        /* ========== BADGES ACHIEVEMENTS ========== */
        .badges-section {
            margin-top: 24px;
            padding: 20px;
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
        }
        .badges-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        .badges-column h5 {
            font-size: 12px;
            color: var(--color-text-muted);
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        .badge-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .badge-item.unlocked {
            border-color: var(--color-success);
            background: rgba(34, 197, 94, 0.1);
        }
        .badge-item.locked { opacity: 0.5; }
        .badge-icon {
            font-size: 28px;
            min-width: 40px;
            text-align: center;
        }
        .badge-info { flex: 1; }
        .badge-name {
            font-size: 13px;
            font-weight: 600;
        }
        .badge-desc {
            font-size: 11px;
            color: var(--color-text-muted);
            margin-top: 2px;
        }
        .badge-check {
            color: var(--color-success);
            font-size: 18px;
        }

        /* ========== RECALCUL NOTIFICATION ========== */
        .recalcul-toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, var(--color-primary-dark), var(--color-bg-surface));
            border: 1px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            opacity: 0;
            transition: all 0.4s ease;
        }
        .recalcul-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .recalcul-icon { font-size: 24px; }
        .recalcul-content { flex: 1; }
        .recalcul-title { font-weight: 700; font-size: 14px; }
        .recalcul-details { font-size: 12px; color: var(--color-text-secondary); margin-top: 4px; }

        /* ========== BADGE UNLOCK ANIMATION ========== */
        .badge-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3500;
        }
        .badge-unlock-overlay.show { display: flex; }

        .badge-unlock-card {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
            animation: badgeUnlock 0.5s ease;
            color: var(--color-bg-base);
        }
        @keyframes badgeUnlock {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        .badge-unlock-icon { font-size: 64px; margin-bottom: 16px; }
        .badge-unlock-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .badge-unlock-message { font-size: 14px; opacity: 0.9; }
        .badge-unlock-close {
            margin-top: 20px;
            padding: 10px 24px;
            background: rgba(0,0,0,0.2);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== ADD ITEM CHAT (like add-skill-chat) ========== */
        .add-item-chat {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: 12px;
            margin: 8px 0;
            display: none;
            animation: slideDown 0.2s ease;
        }
        .add-item-chat.show { display: block; }

        .add-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-bg-muted);
            margin-bottom: 8px;
        }
        .add-item-emoji { font-size: 16px; }
        .add-item-title { font-weight: 600; font-size: 13px; flex: 1; }
        .add-item-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 16px;
        }

        .add-item-messages {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 8px;
        }

        .add-item-msg {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            font-size: 13px;
            max-width: 85%;
        }
        .add-item-msg.bot {
            background: var(--color-bg-muted);
        }
        .add-item-msg.user {
            background: var(--color-primary);
            color: var(--color-bg-base);
            margin-left: auto;
        }
        .add-item-msg.result {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--color-success);
        }

        .add-item-input-zone {
            display: flex;
            gap: 8px;
        }
        .add-item-input-zone input {
            flex: 1;
            padding: 8px 12px;
            background: var(--color-bg-muted);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 13px;
        }
        .add-item-input-zone input:focus {
            outline: none;
            box-shadow: 0 0 0 1px var(--color-primary);
        }
        .add-item-input-zone button {
            padding: 8px 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
        }

        .add-item-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .add-item-chip {
            padding: 6px 12px;
            background: var(--color-bg-muted);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-item-chip:hover {
            background: var(--color-primary);
            color: var(--color-bg-base);
        }

        /* ========== LIFESTYLE TAB ========== */
        .lifestyle-section {
            margin-bottom: 20px;
        }
        .lifestyle-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .lifestyle-card {
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 16px;
        }
        .lifestyle-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .lifestyle-option {
            padding: 8px 14px;
            background: var(--color-bg-surface);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .lifestyle-option:hover { border-color: var(--color-primary); }
        .lifestyle-option.selected {
            background: var(--color-primary);
            color: var(--color-bg-base);
            border-color: var(--color-primary);
        }
        .lifestyle-current {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }
        .lifestyle-tip {
            font-size: 12px;
            color: var(--color-success);
            padding: 10px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: var(--radius-sm);
            margin-top: 10px;
        }
        .lifestyle-summary {
            background: linear-gradient(135deg, var(--color-success), #16a34a);
            padding: 16px;
            border-radius: var(--radius-md);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .lifestyle-summary-label { font-size: 14px; }
        .lifestyle-summary-value { font-size: 20px; font-weight: 700; }

        /* Custom lifestyle items */
        .custom-lifestyle-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--color-bg-muted);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .custom-item-icon { font-size: 18px; }
        .custom-item-name { flex: 1; font-weight: 500; }
        .custom-item-amount { color: var(--color-text-muted); font-size: 13px; }
        .custom-item-savings {
            color: var(--color-success);
            font-weight: 600;
            font-size: 12px;
            background: rgba(34, 197, 94, 0.15);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .custom-item-fixed {
            color: var(--color-text-muted);
            font-size: 11px;
            background: var(--color-bg-surface);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .custom-item-remove {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 16px;
            cursor: pointer;
            padding: 0 4px;
        }
        .custom-item-remove:hover { color: var(--color-warning); }

        /* ========== TRADE TAB ========== */
        .trade-goal {
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
        }
        .trade-goal-title {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }
        .trade-goal-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }
        .trade-item {
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .trade-item-info { flex: 1; min-width: 200px; }
        .trade-item-name { font-weight: 600; font-size: 14px; }
        .trade-item-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-warning);
            margin-left: auto;
        }
        .trade-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            width: 100%;
        }
        .trade-option {
            padding: 8px 14px;
            background: var(--color-bg-surface);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .trade-option:hover { border-color: var(--color-primary); }
        .trade-option.selected {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
        }
        .trade-option.buy { border-color: var(--color-warning); }
        .trade-tip {
            font-size: 11px;
            color: var(--color-info);
            margin-top: 6px;
            width: 100%;
        }
        .trade-summary {
            background: linear-gradient(135deg, var(--color-info), #2563eb);
            padding: 16px;
            border-radius: var(--radius-md);
            color: white;
            margin-top: 20px;
        }
        .trade-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .trade-summary-row:last-child { margin-bottom: 0; }
        .trade-summary-total {
            font-size: 16px;
            font-weight: 700;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
            margin-top: 10px;
        }
        .trade-recalculate-btn {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }
        .trade-recalculate-btn:hover { background: var(--color-primary-hover); }

        /* Add Trade Chat */
        .add-trade-chat {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: 12px;
            margin: 8px 0;
            display: none;
            animation: slideDown 0.2s ease;
        }
        .add-trade-chat.show { display: block; }
        .add-trade-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-bg-muted);
            margin-bottom: 8px;
        }
        .add-trade-title { font-weight: 600; font-size: 13px; flex: 1; }
        .add-trade-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 16px;
        }
        .add-trade-messages { max-height: 120px; overflow-y: auto; margin-bottom: 8px; }
        .add-trade-msg {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            font-size: 13px;
            max-width: 85%;
        }
        .add-trade-msg.bot { background: var(--color-bg-muted); }
        .add-trade-msg.user {
            background: var(--color-primary);
            color: var(--color-bg-base);
            margin-left: auto;
        }
        .add-trade-input-zone {
            display: flex;
            gap: 8px;
        }
        .add-trade-input-zone input {
            flex: 1;
            padding: 8px 12px;
            background: var(--color-bg-muted);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-text-primary);
            font-size: 13px;
        }
        .add-trade-input-zone button {
            padding: 8px 14px;
            background: var(--color-primary);
            color: var(--color-bg-base);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
        }

        /* ========== SUIVI SCREEN SECTIONS ========== */
        .suivi-section {
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }
        .suivi-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ========== TIMELINE HERO ========== */
        .timeline-hero {
            background: linear-gradient(135deg, var(--color-bg-surface), var(--color-bg-muted));
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .timeline-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-success), var(--color-warning));
        }

        .timeline-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Timeline Row Layout */
        .timeline-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .timeline-row-label {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        .timeline-row-icon {
            font-size: 16px;
        }
        .timeline-row-value {
            min-width: 60px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .timeline-track-wrapper {
            flex: 1;
            position: relative;
            height: 40px;
        }

        .timeline-track {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 12px;
            background: var(--color-bg-base);
            border-radius: 6px;
            transform: translateY(-50%);
            overflow: hidden;
        }

        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            z-index: 2;
        }
        .timeline-progress.time {
            background: linear-gradient(90deg, var(--color-primary), #60a5fa);
        }
        .timeline-progress.capacity {
            background: rgba(255,255,255,0.15);
            border-right: 3px solid var(--color-primary);
        }

        /* Week markers */
        .timeline-week-markers {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            height: 20px;
            margin-top: 4px;
        }
        .week-marker {
            position: absolute;
            transform: translateX(-50%);
            font-size: 9px;
            color: var(--color-text-muted);
        }
        .week-marker.current {
            color: var(--color-primary);
            font-weight: 700;
        }
        .week-marker.goal {
            font-size: 12px;
        }

        /* Difficulty zones */
        .difficulty-zone {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .difficulty-zone.high {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.6), rgba(239, 68, 68, 0.4));
        }
        .difficulty-zone.medium {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.5), rgba(245, 158, 11, 0.3));
        }
        .difficulty-zone.low {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.4), rgba(34, 197, 94, 0.2));
        }
        .zone-label {
            font-size: 9px;
            color: rgba(255,255,255,0.9);
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Capacity indicator */
        .capacity-indicator {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        .capacity-indicator.high { background: var(--color-warning); color: white; }
        .capacity-indicator.medium { background: var(--color-orange); color: white; }
        .capacity-indicator.low { background: var(--color-success); color: white; }

        /* Legend dots for difficulty */
        .legend-dot.high { background: var(--color-warning); }
        .legend-dot.medium { background: var(--color-orange); }
        .legend-dot.low { background: var(--color-success); }

        .timeline-milestones {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 5%;
        }

        .timeline-milestone {
            position: relative;
            width: 24px;
            height: 24px;
            background: var(--color-bg-muted);
            border: 3px solid var(--color-bg-surface);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 2;
        }
        .timeline-milestone.reached {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        .timeline-milestone:hover .milestone-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .milestone-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: var(--color-bg-base);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.2s;
            pointer-events: none;
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }
        .milestone-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--color-bg-muted);
        }
        .milestone-tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--color-text-primary);
        }

        /* Character/Avatar */
        .timeline-character {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 40px;
            transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 5;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .timeline-character .char-body {
            position: relative;
            width: 100%;
            height: 100%;
            animation: characterBounce 0.6s ease-in-out infinite;
        }
        .timeline-character .char-emoji {
            font-size: 32px;
            display: block;
        }
        @keyframes characterBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Legend */
        .timeline-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--color-text-secondary);
            cursor: help;
            position: relative;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .legend-dot.time { background: linear-gradient(90deg, var(--color-primary), #60a5fa); opacity: 0.7; }
        .legend-dot.capacity { background: linear-gradient(90deg, var(--color-success), #4ade80); }

        .legend-item:hover .legend-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        .legend-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: var(--color-bg-base);
            border: 1px solid var(--color-bg-muted);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            font-size: 11px;
            width: 200px;
            opacity: 0;
            transition: all 0.2s;
            pointer-events: none;
            z-index: 10;
            box-shadow: var(--shadow-lg);
            text-align: left;
            margin-bottom: 8px;
        }
        .legend-tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--color-text-primary);
        }

        /* Stats summary */
        .timeline-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-bg-muted);
        }
        .timeline-stat {
            text-align: center;
        }
        .timeline-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
        }
        .timeline-stat-value.good { color: var(--color-success); }
        .timeline-stat-value.warning { color: var(--color-warning); }
        .timeline-stat-label {
            font-size: 11px;
            color: var(--color-text-muted);
        }
    </style>
</head>
<body>
    <!-- DAILY CHECK-IN POPUP (3 Steps) -->
    <div class="energy-popup-overlay" id="dailyPopupOverlay">
        <div class="mission-popup">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-dot active" id="step-dot-1"></div>
                <div class="step-dot" id="step-dot-2"></div>
                <div class="step-dot" id="step-dot-3"></div>
            </div>

            <!-- STEP 1: Energy Check -->
            <div class="mission-step active" id="mission-step-1">
                <div class="energy-popup-title">Comment tu te sens aujourd'hui ?</div>

                <div class="energy-emoji-row">
                    <button class="energy-emoji-btn" onclick="selectEnergyLevel(20)" data-score="20">ðŸ˜«</button>
                    <button class="energy-emoji-btn" onclick="selectEnergyLevel(40)" data-score="40">ðŸ˜”</button>
                    <button class="energy-emoji-btn" onclick="selectEnergyLevel(60)" data-score="60">ðŸ˜</button>
                    <button class="energy-emoji-btn" onclick="selectEnergyLevel(80)" data-score="80">ðŸ™‚</button>
                    <button class="energy-emoji-btn" onclick="selectEnergyLevel(100)" data-score="100">ðŸ˜„</button>
                </div>
                <div class="energy-percent-row">
                    <span>20%</span>
                    <span>40%</span>
                    <span>60%</span>
                    <span>80%</span>
                    <span>100%</span>
                </div>

                <div class="energy-factors-title">Qu'est-ce qui influence ton energie ?</div>
                <div class="energy-factors-grid">
                    <div class="energy-factor-checkbox" onclick="toggleEnergyFactor(this)" data-factor="exams">
                        <span class="energy-factor-icon">ðŸ“š</span>
                        <span>Exams</span>
                    </div>
                    <div class="energy-factor-checkbox" onclick="toggleEnergyFactor(this)" data-factor="malade">
                        <span class="energy-factor-icon">ðŸ¤’</span>
                        <span>Malade</span>
                    </div>
                    <div class="energy-factor-checkbox" onclick="toggleEnergyFactor(this)" data-factor="stress">
                        <span class="energy-factor-icon">ðŸ˜°</span>
                        <span>Stress</span>
                    </div>
                    <div class="energy-factor-checkbox" onclick="toggleEnergyFactor(this)" data-factor="fatigue">
                        <span class="energy-factor-icon">ðŸ˜´</span>
                        <span>Fatigue</span>
                    </div>
                    <div class="energy-factor-checkbox positive" onclick="toggleEnergyFactor(this)" data-factor="en_forme">
                        <span class="energy-factor-icon">ðŸ’ª</span>
                        <span>En forme</span>
                    </div>
                    <div class="energy-factor-checkbox positive" onclick="toggleEnergyFactor(this)" data-factor="amoureux">
                        <span class="energy-factor-icon">ðŸ’•</span>
                        <span>Amoureux</span>
                    </div>
                </div>

                <button class="energy-popup-submit" id="energyPopupSubmit" onclick="goToStep(2)">Suivant</button>
            </div>

            <!-- STEP 2: Yesterday Feedback -->
            <div class="mission-step" id="mission-step-2">
                <div class="energy-popup-title">Hier, comment ca s'est passe ?</div>
                <div class="feedback-section" id="yesterdayFeedback">
                    <p class="feedback-empty">Pas de missions hier. Continue comme ca!</p>
                </div>
                <button class="energy-popup-submit enabled" onclick="goToStep(3)">Suivant</button>
            </div>

            <!-- STEP 3: Today's Missions -->
            <div class="mission-step" id="mission-step-3">
                <div class="energy-popup-title">Tes missions du jour</div>
                <div class="missions-list" id="todayMissions">
                    <!-- Generated dynamically -->
                </div>
                <button class="energy-popup-submit enabled" onclick="completeDailyCheckin()">C'est parti!</button>
            </div>
        </div>
    </div>

    <!-- ACTION HUB MODAL -->
    <div class="action-hub-overlay" id="actionHubOverlay">
        <div class="action-hub" style="position: relative;">
            <button class="action-hub-close" onclick="closeActionHub()">Ã—</button>
            <div class="action-hub-header">
                <div class="action-hub-title">âœ¨ Jour <span id="actionHubDay">1</span> - Tes donnees sont a jour !</div>
                <div class="action-hub-subtitle">Ton check-in quotidien est complete.</div>
            </div>

            <div class="action-hub-progress">
                <div class="action-hub-progress-header">
                    <span class="action-hub-progress-label">ðŸ“Š Progression</span>
                    <span class="action-hub-progress-percent" id="actionHubPercent">0%</span>
                </div>
                <div class="action-hub-progress-bar">
                    <div class="action-hub-progress-fill" id="actionHubProgressFill" style="width: 0%;"></div>
                </div>
                <div class="action-hub-progress-text" id="actionHubProgressText">0â‚¬ / 500â‚¬</div>
            </div>

            <div class="action-hub-question">Qu'est-ce que tu veux faire ?</div>

            <button class="action-hub-main-btn" onclick="handleActionChoice('swipe')">
                ðŸŽ´ Swiper les strategies
                <span class="recommended-tag">Recommande</span>
            </button>

            <div class="action-hub-grid">
                <button class="action-hub-btn" onclick="handleActionChoice('skills')">
                    <span>âž•</span> Ajouter skills
                </button>
                <button class="action-hub-btn" onclick="handleActionChoice('inventory')">
                    <span>ðŸ“¦</span> Ajouter objets
                </button>
                <button class="action-hub-btn" onclick="handleActionChoice('setup')">
                    <span>ðŸŽ¯</span> Modifier objectifs
                </button>
                <button class="action-hub-btn" onclick="handleActionChoice('calendar')">
                    <span>ðŸ“…</span> Voir calendrier
                </button>
            </div>
        </div>
    </div>

    <!-- RECALCUL TOAST -->
    <div class="recalcul-toast" id="recalculToast">
        <span class="recalcul-icon">ðŸ”„</span>
        <div class="recalcul-content">
            <div class="recalcul-title">Plan recalcule!</div>
            <div class="recalcul-details" id="recalculDetails">Reste: 320â‚¬ â€¢ Cible/semaine: 64â‚¬</div>
        </div>
    </div>

    <!-- BADGE UNLOCK OVERLAY -->
    <div class="badge-unlock-overlay" id="badgeUnlockOverlay">
        <div class="badge-unlock-card">
            <div class="badge-unlock-icon" id="badgeUnlockIcon">ðŸ†</div>
            <div class="badge-unlock-title" id="badgeUnlockTitle">Badge Debloque!</div>
            <div class="badge-unlock-message" id="badgeUnlockMessage">Felicitations!</div>
            <button class="badge-unlock-close" onclick="closeBadgeUnlock()">Super!</button>
        </div>
    </div>

    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="logo">Stride</div>

            <!-- Profile Selector -->
            <div class="profile-section">
                <div class="nav-section-title">Profils Demo</div>
                <select class="profile-select" id="profileSelect" onchange="loadProfile(this.value)">
                    <option value="">Selectionner un profil...</option>
                    <option value="new">Nouvel utilisateur</option>
                    <option value="active">Etudiant actif (S3)</option>
                    <option value="comeback">Post-exams (comeback)</option>
                    <option value="energy_debt">Energy debt detecte</option>
                </select>
                <div class="profile-info" id="profileInfo"></div>
            </div>

            <!-- Navigation -->
            <div class="nav-section">
                <div class="nav-section-title">Parcours</div>
                <button class="nav-button active" id="nav-0" onclick="switchCase(0)">
                    <span class="nav-emoji">0.</span>
                    <span class="nav-text">Onboarding</span>
                    <span class="menu-badge warning" id="badge-0" style="display:none">!</span>
                </button>
                <button class="nav-button" id="nav-1" onclick="switchCase(1)">
                    <span class="nav-emoji">1.</span>
                    <span class="nav-text">Mon Plan</span>
                    <span class="menu-badge success" id="badge-1" style="display:none">6</span>
                </button>
                <button class="nav-button" id="nav-2" onclick="switchCase(2)">
                    <span class="nav-emoji">2.</span>
                    <span class="nav-text">Suivi</span>
                    <span class="menu-badge info" id="badge-2" style="display:none">!</span>
                </button>
            </div>

            <!-- Opik Panel -->
            <div class="opik-panel">
                <div class="opik-header">
                    <span>Traces Opik</span>
                    <a href="http://localhost:5173" target="_blank">Dashboard</a>
                </div>
                <div class="opik-trace-list" id="opikTraces"></div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            <div class="header">
                <div>
                    <div class="header-title" id="headerTitle">Stride Demo</div>
                    <div class="header-subtitle">Navigate student life, one smart step at a time</div>
                </div>
                <div class="header-actions">
                    <!-- Notifications Bell -->
                    <div class="notif-bell" onclick="toggleNotifications()">
                        ðŸ””
                        <span class="notif-count hidden" id="notifCount">0</span>
                        <div class="notif-dropdown" id="notifDropdown">
                            <div class="notif-dropdown-header">
                                <span>Notifications</span>
                                <span class="notif-dropdown-clear" onclick="clearNotifications(event)">Tout effacer</span>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notif-empty">Aucune notification</div>
                            </div>
                        </div>
                    </div>
                    <!-- Progress Mini -->
                    <div class="progress-mini" id="progressMini">
                        <span class="progress-mini-icon">ðŸ“Š</span>
                        <span class="progress-mini-percent" id="progressMiniPercent">0%</span>
                        <div class="progress-mini-bar">
                            <div class="progress-mini-fill" id="progressMiniFill" style="width: 0%;"></div>
                        </div>
                        <div class="progress-mini-tooltip">
                            <div class="progress-tooltip-title">ðŸ“Š Progression</div>
                            <div class="progress-tooltip-amount" id="progressTooltipAmount">0â‚¬ / 500â‚¬</div>
                            <div class="progress-tooltip-detail">
                                <span>Ventes</span>
                                <span id="progressTooltipSales">0â‚¬</span>
                            </div>
                            <div class="progress-tooltip-detail">
                                <span>Economies</span>
                                <span id="progressTooltipSavings">0â‚¬</span>
                            </div>
                            <div class="progress-tooltip-detail">
                                <span>Jobs</span>
                                <span id="progressTooltipJobs">0â‚¬</span>
                            </div>
                        </div>
                    </div>
                    <div class="day-simulator">
                        <div class="day-counter">
                            <span class="day-label">JOUR</span>
                            <span class="day-current" id="dayCounter">1</span>
                            <span class="day-separator">/</span>
                            <span class="day-total">56</span>
                        </div>
                        <button class="next-day-btn" id="nextDayBtn" onclick="advanceDay()" disabled title="Complete le profil d'abord">+ Jour</button>
                    </div>
                    <button class="reset-btn" onclick="location.reload()">Reset Demo</button>
                </div>
            </div>

            <div class="content">
                <!-- Interaction Prompt -->
                <div class="interaction-prompt" id="interactionPrompt">
                    <div class="prompt-icon" id="promptIcon">!</div>
                    <div class="prompt-content">
                        <div class="prompt-title" id="promptTitle">Action requise</div>
                        <div class="prompt-text" id="promptText">...</div>
                    </div>
                    <div class="prompt-actions">
                        <button class="primary" onclick="respondToPrompt()">Repondre</button>
                        <button class="secondary" onclick="dismissPrompt()">Plus tard</button>
                    </div>
                </div>

                <!-- CASE 0: ONBOARDING -->
                <div class="case-container active" id="case-0">
                    <div class="case-header">
                        <div class="case-title">#0 Onboarding (Chat Conversationnel)</div>
                        <div class="case-description">Reponds aux questions par texte ou voix. Stride reformule pour confirmer ta comprehension.</div>
                    </div>

                    <div class="chat-container" id="chatContainer">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input-zone">
                            <input type="text" id="chatInput" placeholder="Tape ta reponse..." onkeypress="handleChatKeypress(event)">
                            <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">Mic</button>
                            <button class="send-btn" onclick="sendChatMessage()">Go</button>
                        </div>
                    </div>

                    <div class="onboarding-summary" id="onboardingSummary">
                        <h3>Recapitulatif de ton profil</h3>
                        <div class="summary-grid" id="summaryGrid"></div>
                        <div class="next-steps">
                            <h4>Prochaines etapes</h4>
                            <ol>
                                <li>Voir les strategies recommandees (Skill Arbitrage)</li>
                                <li>Swiper tes preferences (Swipe Scenarios)</li>
                                <li>Configurer le calendrier de suivi</li>
                            </ol>
                        </div>
                        <button class="start-btn" onclick="completeOnboarding()">Commencer mon parcours</button>
                    </div>
                </div>

                <!-- CASE 1: MON PLAN (6 tabs) -->
                <div class="case-container" id="case-1">
                    <div class="case-header">
                        <div class="case-title">#1 Mon Plan - Configure et Optimise</div>
                        <div class="case-description">Definis ton objectif, decouvre les strategies, optimise ton mode de vie et explore les alternatives.</div>
                    </div>

                    <!-- 6 Tabs -->
                    <div class="plan-tabs">
                        <button class="plan-tab active" onclick="switchPlanTab('setup')">ðŸŽ¯ Setup</button>
                        <button class="plan-tab" onclick="switchPlanTab('arbitrage')">ðŸ’¼ Skills</button>
                        <button class="plan-tab" onclick="switchPlanTab('inventory')">ðŸ“¦ A Vendre</button>
                        <button class="plan-tab" onclick="switchPlanTab('lifestyle')">ðŸ§˜ Lifestyle</button>
                        <button class="plan-tab" onclick="switchPlanTab('trade')">ðŸ”„ Trade</button>
                        <button class="plan-tab" onclick="switchPlanTab('swipe')">ðŸŽ´ Swipe</button>
                    </div>

                    <!-- Tab Content: Setup -->
                    <div class="plan-tab-content active" id="tab-setup">
                    <div class="card">
                        <div class="setup-form">
                            <div class="setup-field">
                                <div class="setup-label">
                                    <span class="setup-label-icon">ðŸŽ¯</span>
                                    <span>Objectif</span>
                                </div>
                                <div class="setup-input-row">
                                    <span>Economiser</span>
                                    <input type="number" class="setup-input" id="goalAmount" value="500" />
                                    <span>EUR pour</span>
                                    <input type="text" class="setup-input wide" id="goalPurpose" value="vacances camping" placeholder="Ex: vacances, materiel..." />
                                </div>
                            </div>

                            <div class="setup-field">
                                <div class="setup-label">
                                    <span class="setup-label-icon">ðŸ“…</span>
                                    <span>Echeance</span>
                                </div>
                                <div class="setup-input-row">
                                    <span>Dans</span>
                                    <input type="number" class="setup-input" id="goalWeeks" value="8" />
                                    <span>semaines (soit <strong id="goalDays">56</strong> jours)</span>
                                </div>
                            </div>

                            <div class="setup-field">
                                <div class="setup-label">
                                    <span class="setup-label-icon">âš ï¸</span>
                                    <span>Evenements difficiles prevus</span>
                                </div>
                                <div class="setup-events-list" id="setupEventsList">
                                    <div class="setup-event-item">
                                        <span class="event-icon">ðŸ“š</span>
                                        <span>Semaine 4: Examens partiels</span>
                                    </div>
                                    <div class="setup-event-item">
                                        <span class="event-icon">ðŸ“</span>
                                        <span>Semaine 7: Rendu projet</span>
                                    </div>
                                </div>
                                <button class="add-event-btn" onclick="addSetupEvent()">+ Ajouter un evenement</button>
                            </div>

                            <button class="setup-submit" onclick="completeSetup()">Valider et voir les strategies</button>
                        </div>
                    </div>

                    <div class="disruptive-box">
                        <h4>Why it's important:</h4>
                        <p>- Definir un objectif clair et mesurable<br>- Anticiper les periodes difficiles (exams, projets)<br>- Permettre un retroplanning adapte a ta vie</p>
                    </div>
                    </div><!-- End tab-setup -->

                    <!-- Tab Content: Skill Arbitrage -->
                    <div class="plan-tab-content" id="tab-arbitrage">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-info">
                                <strong>Analyse d'arbitrage</strong>
                                <span class="formula">Score = 30% Rate + 25% Demand + 25% Effort + 20% Rest</span>
                            </div>
                            <button class="add-skill-btn" onclick="openAddSkillChat()">+ Ajouter une skill</button>
                        </div>

                        <!-- Add Skill Chat -->
                        <div class="add-skill-chat" id="addSkillChat">
                            <div class="add-skill-header">
                                <span class="add-skill-emoji">+</span>
                                <span class="add-skill-title">Ajouter une competence</span>
                                <button class="add-skill-close" onclick="closeAddSkillChat()">x</button>
                            </div>
                            <div class="add-skill-messages" id="addSkillMessages">
                                <div class="add-skill-msg bot">Quelle competence veux-tu ajouter?</div>
                            </div>
                            <div class="add-skill-input-zone">
                                <input type="text" id="addSkillInput" placeholder="Ex: React.js, Excel avance..." onkeypress="handleAddSkillKeypress(event)">
                                <button onclick="sendAddSkillMessage()">Go</button>
                            </div>
                        </div>

                        <table class="comparison-table" id="jobsTable">
                            <thead><tr><th>Job</th><th>Rate</th><th>Demand</th><th>Effort</th><th>Rest</th><th>Score</th><th style="text-align:right;">Actions</th></tr></thead>
                            <tbody id="jobsTableBody">
                                <tr id="row-python_dev">
                                    <td>Python Dev</td>
                                    <td><strong id="rate-python_dev">25 EUR/h</strong></td>
                                    <td>5 stars</td>
                                    <td style="color:#ef4444;">Very High</td>
                                    <td style="color:#ef4444;">Low</td>
                                    <td style="color:#ef4444;" id="score-python_dev">6.2/10</td>
                                    <td class="action-cell">
                                        <button class="explain-btn" onclick="toggleExplain('python_dev')" title="Voir le detail">?</button>
                                        <button class="feedback-btn thumbs-up" id="thumbup-python_dev" onclick="validateJob('python_dev')" title="Valider">+</button>
                                        <button class="feedback-btn thumbs-down" id="thumbdown-python_dev" onclick="contestJob('python_dev')" title="Contester">-</button>
                                    </td>
                                </tr>
                                <tr id="explain-row-python_dev" style="display:none;">
                                    <td colspan="7">
                                        <div class="explainability-panel show" id="explain-panel-python_dev"></div>
                                    </td>
                                </tr>
                                <tr id="contest-row-python_dev" style="display:none;">
                                    <td colspan="7">
                                        <div class="contest-chat show" id="contest-chat-python_dev"></div>
                                    </td>
                                </tr>

                                <tr id="row-sql_coaching">
                                    <td>SQL Coaching</td>
                                    <td><strong id="rate-sql_coaching">22 EUR/h</strong></td>
                                    <td>4 stars</td>
                                    <td style="color:#eab308;">Moderate</td>
                                    <td style="color:#22c55e;">High</td>
                                    <td style="color:#22c55e; font-weight:700;" id="score-sql_coaching">8.7/10</td>
                                    <td class="action-cell">
                                        <button class="explain-btn" onclick="toggleExplain('sql_coaching')" title="Voir le detail">?</button>
                                        <button class="feedback-btn thumbs-up" id="thumbup-sql_coaching" onclick="validateJob('sql_coaching')" title="Valider">+</button>
                                        <button class="feedback-btn thumbs-down" id="thumbdown-sql_coaching" onclick="contestJob('sql_coaching')" title="Contester">-</button>
                                    </td>
                                </tr>
                                <tr id="explain-row-sql_coaching" style="display:none;">
                                    <td colspan="7">
                                        <div class="explainability-panel show" id="explain-panel-sql_coaching"></div>
                                    </td>
                                </tr>
                                <tr id="contest-row-sql_coaching" style="display:none;">
                                    <td colspan="7">
                                        <div class="contest-chat show" id="contest-chat-sql_coaching"></div>
                                    </td>
                                </tr>

                                <tr id="row-data_entry">
                                    <td>Data Entry</td>
                                    <td><strong id="rate-data_entry">12 EUR/h</strong></td>
                                    <td>4 stars</td>
                                    <td style="color:#22c55e;">Very Low</td>
                                    <td style="color:#22c55e;">High</td>
                                    <td style="color:#38bdf8;" id="score-data_entry">7.1/10</td>
                                    <td class="action-cell">
                                        <button class="explain-btn" onclick="toggleExplain('data_entry')" title="Voir le detail">?</button>
                                        <button class="feedback-btn thumbs-up" id="thumbup-data_entry" onclick="validateJob('data_entry')" title="Valider">+</button>
                                        <button class="feedback-btn thumbs-down" id="thumbdown-data_entry" onclick="contestJob('data_entry')" title="Contester">-</button>
                                    </td>
                                </tr>
                                <tr id="explain-row-data_entry" style="display:none;">
                                    <td colspan="7">
                                        <div class="explainability-panel show" id="explain-panel-data_entry"></div>
                                    </td>
                                </tr>
                                <tr id="contest-row-data_entry" style="display:none;">
                                    <td colspan="7">
                                        <div class="contest-chat show" id="contest-chat-data_entry"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div style="font-weight:600; margin-bottom:10px;">Recommandation: SQL Coaching (22 EUR/h) - Score 8.7/10</div>
                        <p style="font-size:13px; color:#cbd5e1;">Excellent balance entre taux horaire et effort cognitif. Preserve le temps de repos pour les etudes.</p>
                    </div>

                    <div class="disruptive-box">
                        <h4>Why it's disruptive:</h4>
                        <p>- <strong>Explicabilite</strong>: Clic sur "?" pour voir le detail du calcul<br>- <strong>Human-in-the-loop</strong>: Valide (+) ou conteste (-) chaque recommandation<br>- <strong>Evolutif</strong>: Ajoute des skills pour decouvrir de nouveaux jobs</p>
                    </div>
                    </div><!-- End tab-arbitrage -->

                    <!-- Tab Content: Inventory (A Vendre) -->
                    <div class="plan-tab-content" id="tab-inventory">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-info">
                                <strong>Ton inventaire a vendre</strong>
                                <span class="formula">Prix estimes par categorie et etat</span>
                            </div>
                            <button class="add-skill-btn" onclick="openAddItemChat()">+ Ajouter un objet</button>
                        </div>

                        <!-- Add Item Chat -->
                        <div class="add-item-chat" id="addItemChat">
                            <div class="add-item-header">
                                <span class="add-item-emoji">ðŸ“¦</span>
                                <span class="add-item-title">Ajouter un objet</span>
                                <button class="add-item-close" onclick="closeAddItemChat()">Ã—</button>
                            </div>
                            <div class="add-item-messages" id="addItemMessages">
                                <div class="add-item-msg bot">Qu'est-ce que tu veux vendre? (ex: iPhone, vetements, livres...)</div>
                            </div>
                            <div class="add-item-input-zone">
                                <input type="text" id="addItemInput" placeholder="Ex: Mon vieux iPhone 11" onkeypress="handleAddItemKeypress(event)">
                                <button onclick="sendAddItemMessage()">Go</button>
                            </div>
                        </div>

                        <div class="inventory-grid" id="inventoryGrid">
                            <!-- Items generated dynamically -->
                            <div class="inventory-item" data-id="demo1">
                                <div class="inventory-icon">ðŸ‘•</div>
                                <div class="inventory-name">Lot vetements</div>
                                <div class="inventory-price">~45 EUR</div>
                                <div class="inventory-platform">Vinted</div>
                                <div class="inventory-actions">
                                    <button class="inventory-btn post" onclick="postItem('demo1')">Poster</button>
                                    <button class="inventory-btn remove" onclick="removeItem('demo1')">X</button>
                                </div>
                            </div>
                            <div class="inventory-item posted" data-id="demo2">
                                <div class="inventory-icon">ðŸ“±</div>
                                <div class="inventory-name">iPhone 11</div>
                                <div class="inventory-price">~180 EUR</div>
                                <div class="inventory-platform">Leboncoin</div>
                                <div class="inventory-actions">
                                    <button class="inventory-btn sold" onclick="markSold('demo2')">Vendu!</button>
                                    <button class="inventory-btn remove" onclick="removeItem('demo2')">X</button>
                                </div>
                            </div>
                            <div class="inventory-item" data-id="demo3">
                                <div class="inventory-icon">ðŸ“š</div>
                                <div class="inventory-name">5 livres CS</div>
                                <div class="inventory-price">~40 EUR</div>
                                <div class="inventory-platform">Momox</div>
                                <div class="inventory-actions">
                                    <button class="inventory-btn post" onclick="postItem('demo3')">Poster</button>
                                    <button class="inventory-btn remove" onclick="removeItem('demo3')">X</button>
                                </div>
                            </div>
                        </div>

                        <div class="inventory-total">
                            <span class="inventory-total-label">Potentiel total</span>
                            <span class="inventory-total-value" id="inventoryTotalValue">265 EUR</span>
                        </div>
                    </div>

                    <div class="local-suggestions" id="localSuggestions">
                        <div class="local-suggestions-title">ðŸ“ Suggestions locales (Paris)</div>
                        <div class="local-suggestion-item">â€¢ Marche aux puces Montreuil - samedi 8h-14h</div>
                        <div class="local-suggestion-item">â€¢ Vide-grenier Bastille - dimanche</div>
                        <div class="local-suggestion-item">â€¢ Brocante Belleville - 1er weekend du mois</div>
                    </div>

                    <div class="disruptive-box">
                        <h4>Why it's disruptive:</h4>
                        <p>- <strong>Monetisation immediate</strong>: Tes affaires = argent direct<br>- <strong>Prix estimes</strong>: Pas de recherche necessaire<br>- <strong>Local</strong>: Marches et vide-greniers pres de chez toi</p>
                    </div>
                    </div><!-- End tab-inventory -->

                    <!-- Tab Content: Lifestyle -->
                    <div class="plan-tab-content" id="tab-lifestyle">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <strong>ðŸ§˜ Optimise ton quotidien</strong>
                            <button class="btn-add-small" onclick="openAddLifestyleChat()">+ Ajouter</button>
                        </div>

                        <!-- Chat pour ajouter des elements lifestyle -->
                        <div class="add-item-chat" id="addLifestyleChat">
                            <div class="add-item-header">
                                <span class="add-item-emoji">ðŸ§˜</span>
                                <span class="add-item-title">Ajouter une dÃ©pense</span>
                                <button class="add-item-close" onclick="closeAddLifestyleChat()">Ã—</button>
                            </div>
                            <div class="add-item-messages" id="addLifestyleMessages">
                                <div class="add-item-msg bot">Quelle dÃ©pense rÃ©guliÃ¨re veux-tu ajouter? (ex: pressing, coiffeur, sport...)</div>
                            </div>
                            <div class="add-item-input-zone">
                                <input type="text" id="addLifestyleInput" placeholder="Ex: Pressing 20â‚¬/mois" onkeypress="handleAddLifestyleKeypress(event)">
                                <button onclick="sendAddLifestyleMessage()">Go</button>
                            </div>
                        </div>

                        <!-- Custom lifestyle items (added dynamically) -->
                        <div id="customLifestyleItems"></div>

                        <!-- Logement -->
                        <div class="lifestyle-section">
                            <div class="lifestyle-title">ðŸ  Logement</div>
                            <div class="lifestyle-card">
                                <div class="lifestyle-options" id="lifestyleHousing">
                                    <div class="lifestyle-option selected" onclick="selectLifestyle('housing', 'seul', this)">Seul</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('housing', 'coloc', this)">Coloc</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('housing', 'famille', this)">Famille</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('housing', 'crous', this)">Cite U</div>
                                </div>
                                <div class="lifestyle-current">Loyer actuel: <strong>450â‚¬/mois</strong></div>
                                <div class="lifestyle-tip">ðŸ’¡ Une coloc pourrait economiser ~150â‚¬/mois</div>
                            </div>
                        </div>

                        <!-- Alimentation -->
                        <div class="lifestyle-section">
                            <div class="lifestyle-title">ðŸ½ï¸ Alimentation</div>
                            <div class="lifestyle-card">
                                <div class="lifestyle-options" id="lifestyleFood">
                                    <div class="lifestyle-option selected" onclick="selectLifestyle('food', 'standard', this)">Standard</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('food', 'vegetarien', this)">Vegetarien</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('food', 'vegan', this)">Vegan</div>
                                </div>
                                <div class="lifestyle-current">Budget actuel: <strong>~200â‚¬/mois</strong></div>
                                <div style="margin-top:12px;">
                                    <div class="lifestyle-options" id="lifestyleMealPrep">
                                        <div class="lifestyle-option" onclick="selectLifestyle('mealprep', 'oui', this)">Meal Prep: Oui</div>
                                        <div class="lifestyle-option selected" onclick="selectLifestyle('mealprep', 'non', this)">Meal Prep: Non</div>
                                    </div>
                                </div>
                                <div class="lifestyle-tip">ðŸ’¡ Batch cooking = ~60â‚¬ d'economies/mois</div>
                            </div>
                        </div>

                        <!-- Transport -->
                        <div class="lifestyle-section">
                            <div class="lifestyle-title">ðŸš— Transport</div>
                            <div class="lifestyle-card">
                                <div class="lifestyle-options" id="lifestyleTransport">
                                    <div class="lifestyle-option selected" onclick="selectLifestyle('transport', 'transports', this)">Transports</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('transport', 'velo', this)">Velo</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('transport', 'voiture', this)">Voiture</div>
                                    <div class="lifestyle-option" onclick="selectLifestyle('transport', 'pied', this)">A pied</div>
                                </div>
                                <div class="lifestyle-current">Abonnement: <strong>Navigo 86â‚¬/mois</strong></div>
                                <div class="lifestyle-tip">ðŸ’¡ Velib' = 37â‚¬/an seulement!</div>
                            </div>
                        </div>

                        <!-- Abonnements -->
                        <div class="lifestyle-section">
                            <div class="lifestyle-title">ðŸ“± Abonnements</div>
                            <div class="lifestyle-card">
                                <div class="lifestyle-options" id="lifestyleSubs">
                                    <div class="lifestyle-option selected" onclick="toggleLifestyleSub('netflix', this)">Netflix 13â‚¬</div>
                                    <div class="lifestyle-option selected" onclick="toggleLifestyleSub('spotify', this)">Spotify 10â‚¬</div>
                                    <div class="lifestyle-option" onclick="toggleLifestyleSub('gym', this)">Salle sport 30â‚¬</div>
                                    <div class="lifestyle-option" onclick="toggleLifestyleSub('disney', this)">Disney+ 9â‚¬</div>
                                </div>
                                <div class="lifestyle-tip">ðŸ’¡ Partage familial Netflix = 4â‚¬/mois au lieu de 13â‚¬</div>
                            </div>
                        </div>

                        <div class="lifestyle-summary">
                            <span class="lifestyle-summary-label">Economies potentielles</span>
                            <span class="lifestyle-summary-value" id="lifestyleSavings">~180â‚¬/mois</span>
                        </div>
                    </div>

                    <div class="disruptive-box">
                        <h4>Why it's disruptive:</h4>
                        <p>- <strong>Vision globale</strong>: Optimise logement, food, transport, abos<br>- <strong>Actionnable</strong>: Economies concretes avec tips<br>- <strong>Non-intrusif</strong>: Tu choisis ce que tu veux changer</p>
                    </div>
                    </div><!-- End tab-lifestyle -->

                    <!-- Tab Content: Trade -->
                    <div class="plan-tab-content" id="tab-trade">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-info">
                                <strong>ðŸ”„ Emprunte, troque, economise!</strong>
                                <span class="formula">Reduis ton objectif en evitant les achats</span>
                            </div>
                            <button class="add-skill-btn" onclick="openAddTradeChat()">+ Ajouter un besoin</button>
                        </div>

                        <!-- Add Trade Chat -->
                        <div class="add-trade-chat" id="addTradeChat">
                            <div class="add-trade-header">
                                <span>ðŸ”„</span>
                                <span class="add-trade-title">Ajouter un besoin</span>
                                <button class="add-trade-close" onclick="closeAddTradeChat()">Ã—</button>
                            </div>
                            <div class="add-trade-messages" id="addTradeMessages">
                                <div class="add-trade-msg bot">De quoi as-tu besoin pour ton objectif?</div>
                            </div>
                            <div class="add-trade-input-zone">
                                <input type="text" id="addTradeInput" placeholder="Ex: tente, appareil photo..." onkeypress="handleAddTradeKeypress(event)">
                                <button onclick="sendAddTradeMessage()">Go</button>
                            </div>
                        </div>

                        <div class="trade-goal">
                            <div class="trade-goal-title">ðŸŽ¯ Ton objectif</div>
                            <div class="trade-goal-value">Vacances camping (500â‚¬)</div>
                        </div>

                        <strong style="display:block; margin-bottom:12px;">ðŸ•ï¸ Equipements necessaires</strong>

                        <div class="trade-item" id="trade-tent">
                            <div class="trade-item-info">
                                <div class="trade-item-name">â›º Tente 2 places</div>
                            </div>
                            <div class="trade-item-price">80â‚¬</div>
                            <div class="trade-options">
                                <div class="trade-option buy" onclick="selectTradeOption('tent', 'buy', this)">Acheter</div>
                                <div class="trade-option" onclick="selectTradeOption('tent', 'borrow', this)">Emprunter</div>
                                <div class="trade-option" onclick="selectTradeOption('tent', 'trade', this)">Troquer</div>
                            </div>
                            <div class="trade-tip">ðŸ’¡ 3 amis ont une tente dispo!</div>
                        </div>

                        <div class="trade-item" id="trade-sleeping">
                            <div class="trade-item-info">
                                <div class="trade-item-name">ðŸ›ï¸ Sac de couchage</div>
                            </div>
                            <div class="trade-item-price">40â‚¬</div>
                            <div class="trade-options">
                                <div class="trade-option buy" onclick="selectTradeOption('sleeping', 'buy', this)">Acheter</div>
                                <div class="trade-option" onclick="selectTradeOption('sleeping', 'borrow', this)">Emprunter</div>
                                <div class="trade-option" onclick="selectTradeOption('sleeping', 'trade', this)">Troquer</div>
                            </div>
                            <div class="trade-tip">ðŸ’¡ Decathlon loue pour 5â‚¬/semaine</div>
                        </div>

                        <div class="trade-item" id="trade-stove">
                            <div class="trade-item-info">
                                <div class="trade-item-name">ðŸ”¥ Rechaud camping</div>
                            </div>
                            <div class="trade-item-price">25â‚¬</div>
                            <div class="trade-options">
                                <div class="trade-option buy" onclick="selectTradeOption('stove', 'buy', this)">Acheter</div>
                                <div class="trade-option" onclick="selectTradeOption('stove', 'borrow', this)">Emprunter</div>
                                <div class="trade-option" onclick="selectTradeOption('stove', 'trade', this)">Troquer</div>
                            </div>
                            <div class="trade-tip">ðŸ’¡ Echange contre ton vieux velo?</div>
                        </div>

                        <div class="trade-summary" id="tradeSummary">
                            <div class="trade-summary-row">
                                <span>Budget initial equipements</span>
                                <span>145â‚¬</span>
                            </div>
                            <div class="trade-summary-row">
                                <span>Si tout emprunte/troque</span>
                                <span style="color:#22c55e;">0â‚¬</span>
                            </div>
                            <div class="trade-summary-row trade-summary-total">
                                <span>Economies possibles</span>
                                <span id="tradeSavings">145â‚¬</span>
                            </div>
                        </div>

                        <button class="trade-recalculate-btn" onclick="recalculateWithTrade()">
                            Recalculer mon objectif â†’ 355â‚¬
                        </button>
                    </div>

                    <div class="disruptive-box">
                        <h4>Why it's disruptive:</h4>
                        <p>- <strong>Innovation</strong>: Reduis l'objectif plutot que gagner plus<br>- <strong>Economie collaborative</strong>: Emprunter > Acheter<br>- <strong>Ecologique</strong>: Moins de consommation</p>
                    </div>
                    </div><!-- End tab-trade -->

                    <!-- Tab Content: Swipe Scenarios -->
                    <div class="plan-tab-content" id="tab-swipe">

                    <!-- PRE-SWIPE: Roll the Dice -->
                    <div class="roll-dice-container" id="rollDiceContainer">
                        <div class="roll-dice-box">
                            <div class="roll-dice-title">ðŸŽ² PrÃªt Ã  dÃ©couvrir tes options?</div>
                            <div class="roll-dice-description">
                                Stride va analyser ton profil, tes skills, ton inventaire et ton lifestyle pour te proposer des scÃ©narios personnalisÃ©s.
                            </div>
                            <div class="roll-dice-summary" id="rollDiceSummary">
                                <div class="summary-item">
                                    <span class="summary-icon">ðŸ’¼</span>
                                    <span class="summary-label">Skills</span>
                                    <span class="summary-value" id="summarySkills">3 compÃ©tences</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-icon">ðŸ“¦</span>
                                    <span class="summary-label">Objets Ã  vendre</span>
                                    <span class="summary-value" id="summaryItems">4 objets</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-icon">ðŸ§˜</span>
                                    <span class="summary-label">Ã‰conomies lifestyle</span>
                                    <span class="summary-value" id="summaryLifestyle">~180â‚¬/mois</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-icon">ðŸ”„</span>
                                    <span class="summary-label">Trades possibles</span>
                                    <span class="summary-value" id="summaryTrades">3 items</span>
                                </div>
                            </div>
                            <button class="roll-dice-btn" onclick="rollTheDice()">
                                <span class="dice-emoji">ðŸŽ²</span>
                                <span>Roll the Dice!</span>
                            </button>
                            <div class="roll-dice-warning">
                                âš ï¸ Une fois lancÃ©, les autres onglets seront figÃ©s pendant le swipe.
                            </div>
                        </div>
                    </div>

                    <!-- SWIPE INTERFACE (hidden until roll) -->
                    <div class="swipe-container" id="swipeContainer" style="display: none;">
                        <div class="swipe-locked-banner" id="swipeLockedBanner">
                            ðŸ”’ Mode Swipe actif - Les autres onglets sont figÃ©s
                            <button onclick="cancelSwipeSession()">Annuler</button>
                        </div>
                        <div class="swipe-card" id="swipeCard">
                            <div class="swipe-emoji">ðŸ’¼</div>
                            <div class="swipe-title">Freelance Dev</div>
                            <div class="swipe-value">+120 EUR/mois</div>
                            <div class="swipe-description">Rate: 25 EUR/h<br>Effort: High<br>Time: 10h/week</div>
                            <div class="swipe-controls">
                                <button class="swipe-btn no" onclick="swipeNo()">X</button>
                                <button class="swipe-btn yes" onclick="swipeYes()">OK</button>
                            </div>
                        </div>
                        <div class="swipe-counter">Scenario <span id="currentScenario">1</span> / <span id="totalScenarios">4</span></div>
                        <div class="swipe-selected" id="swipeSelected">
                            <div style="font-weight:600; margin-bottom:8px;">Tes sÃ©lections</div>
                            <div id="selectedList"></div>
                            <div id="learnedPrefs" style="margin-top:10px; padding:8px; background:#1e293b; border-radius:8px; font-size:12px;"></div>
                        </div>
                    </div>

                    <div class="disruptive-box">
                        <h4>Why it's disruptive:</h4>
                        <p>- <strong>Roll the Dice</strong>: Compile ton profil en scÃ©narios<br>- Addictive UX like Tinder<br>- Stride learns your preferences<br>- After swipes, missions ajoutÃ©es au Suivi</p>
                    </div>
                    </div><!-- End tab-swipe -->
                </div>

                <!-- CASE 2: SUIVI (Calendar + Track fusionnes) -->
                <div class="case-container" id="case-2">
                    <div class="case-header">
                        <div class="case-title">#2 Suivi - Ton Tableau de Bord</div>
                        <div class="case-description">Retroplan, suivi energie, historique et achievements - tout au meme endroit.</div>
                    </div>

                    <!-- TIMELINE HERO -->
                    <div class="timeline-hero">
                        <div class="timeline-title">
                            <span>ðŸ—ºï¸</span>
                            <span>Ton parcours vers l'objectif</span>
                        </div>

                        <!-- Timeline 1: TEMPS -->
                        <div class="timeline-row">
                            <div class="timeline-row-label">
                                <span class="timeline-row-icon">â°</span>
                                <span>Temps</span>
                            </div>
                            <div class="timeline-track-wrapper">
                                <div class="timeline-track">
                                    <div class="timeline-progress time" id="timelineTimeProgress" style="width: 50%;"></div>
                                </div>
                                <!-- Week markers -->
                                <div class="timeline-week-markers">
                                    <div class="week-marker" style="left: 12.5%;">S1</div>
                                    <div class="week-marker" style="left: 25%;">S2</div>
                                    <div class="week-marker" style="left: 37.5%;">S3</div>
                                    <div class="week-marker current" style="left: 50%;">S4</div>
                                    <div class="week-marker" style="left: 62.5%;">S5</div>
                                    <div class="week-marker" style="left: 75%;">S6</div>
                                    <div class="week-marker" style="left: 87.5%;">S7</div>
                                    <div class="week-marker goal" style="left: 100%;">ðŸŽ¯</div>
                                </div>
                            </div>
                            <div class="timeline-row-value" id="timelineTimeValue">S4/8</div>
                        </div>

                        <!-- Timeline 2: CHARGE DE TRAVAIL -->
                        <div class="timeline-row">
                            <div class="timeline-row-label">
                                <span class="timeline-row-icon">ðŸ“Š</span>
                                <span>Charge</span>
                            </div>
                            <div class="timeline-track-wrapper">
                                <div class="timeline-track">
                                    <!-- Difficulty zones (exams, projects, etc.) -->
                                    <div class="difficulty-zone high" style="left: 0%; width: 25%;" title="Exams S1-S2">
                                        <span class="zone-label">ðŸ“š Exams</span>
                                    </div>
                                    <div class="difficulty-zone low" style="left: 25%; width: 25%;">
                                        <span class="zone-label">ðŸ˜Œ Cool</span>
                                    </div>
                                    <div class="difficulty-zone medium" style="left: 50%; width: 12.5%;" title="Projet S5">
                                        <span class="zone-label">ðŸ’» Projet</span>
                                    </div>
                                    <div class="difficulty-zone low" style="left: 62.5%; width: 37.5%;">
                                        <span class="zone-label">ðŸ–ï¸ Vacances</span>
                                    </div>
                                    <!-- Current position indicator -->
                                    <div class="timeline-progress capacity" id="timelineCapacityProgress" style="width: 50%;"></div>
                                </div>
                                <!-- Character on this track -->
                                <div class="timeline-character" id="timelineCharacter" style="left: 48%;">
                                    <div class="char-body">
                                        <span class="char-emoji">ðŸƒ</span>
                                    </div>
                                </div>
                            </div>
                            <div class="timeline-row-value">
                                <span class="capacity-indicator medium" id="currentCapacity">65%</span>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="timeline-legend">
                            <div class="legend-item">
                                <div class="legend-dot high"></div>
                                <span>PÃ©riode difficile</span>
                                <div class="legend-tooltip">
                                    <div class="legend-tooltip-title">ðŸ“š Charge Ã©levÃ©e</div>
                                    <div>Exams, deadlines, projets... Cibles rÃ©duites automatiquement.</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot medium"></div>
                                <span>ModÃ©rÃ©e</span>
                                <div class="legend-tooltip">
                                    <div class="legend-tooltip-title">ðŸ’» Charge moyenne</div>
                                    <div>Quelques obligations mais gÃ©rable. Cibles normales.</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot low"></div>
                                <span>Tranquille</span>
                                <div class="legend-tooltip">
                                    <div class="legend-tooltip-title">ðŸ˜Œ PÃ©riode cool</div>
                                    <div>Vacances, temps libre... IdÃ©al pour rattraper!</div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats summary -->
                        <div class="timeline-stats">
                            <div class="timeline-stat">
                                <div class="timeline-stat-value" id="timelineEarned">175â‚¬</div>
                                <div class="timeline-stat-label">GagnÃ©</div>
                            </div>
                            <div class="timeline-stat">
                                <div class="timeline-stat-value" id="timelineRemaining">325â‚¬</div>
                                <div class="timeline-stat-label">Restant</div>
                            </div>
                            <div class="timeline-stat">
                                <div class="timeline-stat-value" id="timelineWeeksLeft">4 sem</div>
                                <div class="timeline-stat-label">Avant deadline</div>
                            </div>
                            <div class="timeline-stat">
                                <div class="timeline-stat-value good" id="timelineStatus">En avance</div>
                                <div class="timeline-stat-label">Status</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 1: Retroplan (ex-Calendar) -->
                    <div class="suivi-section">
                        <div class="suivi-section-title">ðŸ“… Retroplan</div>

                        <div class="crunch-alert">
                            <div class="crunch-alert-title">Comeback Window Detected!</div>
                            <div class="crunch-alert-text">Tu avais 50% de ta cible S1-S4. Ton energie est a 90% S5. Plan rattrapage disponible!</div>
                        </div>

                        <div class="crunch-stats">
                            <div class="stat-box"><div class="stat-value">126 EUR</div><div class="stat-label">Deficit</div></div>
                            <div class="stat-box"><div class="stat-value">3 sem</div><div class="stat-label">Catch-up</div></div>
                            <div class="stat-box"><div class="stat-value">85%</div><div class="stat-label">Faisable</div></div>
                        </div>

                        <div class="card" style="margin-top:16px;">
                            <div class="comeback-plan"><div class="comeback-plan-title">Plan Rattrapage Agressif</div></div>
                            <table style="width:100%; margin-top:12px; font-size:13px;">
                                <tr style="border-bottom:1px solid #334155;"><td style="padding:8px 0; font-weight:600;">Semaine</td><td style="text-align:right; font-weight:600;">Cible</td><td style="text-align:right; font-weight:600;">Strategie</td></tr>
                                <tr style="border-bottom:1px solid #334155;"><td style="padding:8px 0;">S5 (90% energie)</td><td style="text-align:right; color:#22c55e;">50 EUR</td><td style="text-align:right;">SQL Coaching (4h)</td></tr>
                                <tr style="border-bottom:1px solid #334155;"><td style="padding:8px 0;">S6 (85% energie)</td><td style="text-align:right; color:#22c55e;">45 EUR</td><td style="text-align:right;">+ vendre 2 items</td></tr>
                                <tr><td style="padding:8px 0;">S7 (80% energie)</td><td style="text-align:right; color:#22c55e;">31 EUR</td><td style="text-align:right;">Tutoring (2h)</td></tr>
                            </table>
                            <div class="achievement-badge">ðŸ† Badge "Comeback King" unlocked!</div>
                        </div>
                    </div>

                    <!-- Section 2: Suivi Energie (ex-Track top) -->
                    <div class="suivi-section">
                        <div class="suivi-section-title">ðŸ“Š Suivi Energie</div>

                        <div class="energy-warning">
                            <div class="warning-title">Energy Debt Detected!</div>
                            <div class="warning-text">Ton energie est a 32% depuis 3 semaines. Cible S4 reduite: 10 EUR (vs 63 EUR).</div>
                        </div>

                        <div style="margin:16px 0;">
                            <div style="font-weight:600; margin-bottom:10px;">Energy History</div>
                            <div class="energy-week"><div class="energy-week-label">S1</div><div class="energy-bar-container"><div class="energy-bar" style="width:35%;"></div></div><div class="energy-week-value">35%</div></div>
                            <div class="energy-week"><div class="energy-week-label">S2</div><div class="energy-bar-container"><div class="energy-bar" style="width:30%;"></div></div><div class="energy-week-value">30%</div></div>
                            <div class="energy-week"><div class="energy-week-label">S3</div><div class="energy-bar-container"><div class="energy-bar" style="width:32%;"></div></div><div class="energy-week-value">32%</div></div>
                            <div class="energy-week"><div class="energy-week-label">S4 (Today)</div><div class="energy-bar-container"><div class="energy-bar" style="width:65%;"></div></div><div class="energy-week-value">65%</div></div>
                        </div>

                        <div class="action-plan">
                            <div class="action-title">Recovery Plan Activated</div>
                            <div class="action-item"><div class="action-bullet">1.</div><div>S4 target: 10 EUR (vs 63 EUR)</div></div>
                            <div class="action-item"><div class="action-bullet">2.</div><div>Focus on rest & studies</div></div>
                            <div class="action-item"><div class="action-bullet">3.</div><div>S5-S7: progressive catch-up</div></div>
                        </div>

                        <div class="card" style="margin-top:16px;">
                            <div style="display:flex; align-items:center; gap:12px; padding:12px; background:linear-gradient(135deg, #22c55e, #16a34a); border-radius:8px;">
                                <div style="font-size:32px;">ðŸ’š</div>
                                <div><div style="font-weight:700;">Self Care Champion - Unlocked!</div><div style="font-size:12px; color:rgba(255,255,255,0.9);">You listened to your body.</div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Historique + Badges (ex-Track bottom) -->
                    <div class="suivi-section">
                        <div class="suivi-section-title">ðŸ“‹ Historique & Badges</div>

                        <!-- Missions from Swipe (dynamically filled) -->
                        <div class="swipe-missions-section" id="swipeMissionsSection" style="display:none;">
                            <div class="swipe-missions-header">
                                <span>ðŸŽ´ Missions du Swipe</span>
                                <span class="swipe-missions-count" id="swipeMissionsCount">0</span>
                            </div>
                            <div class="swipe-missions-list" id="swipeMissionsList">
                                <!-- Filled dynamically -->
                            </div>
                        </div>

                        <!-- Missions History -->
                        <div class="missions-history" style="margin-top:0;">
                            <div class="history-header">
                                <h4>Historique Missions</h4>
                                <div class="history-stats">
                                    <div class="history-stat">
                                        <div class="history-stat-value" id="missionsCompleted">5</div>
                                        <div class="history-stat-label">Completees</div>
                                    </div>
                                    <div class="history-stat">
                                        <div class="history-stat-value" id="missionsEarnings">145 EUR</div>
                                        <div class="history-stat-label">Gagnes</div>
                                    </div>
                                </div>
                            </div>
                            <div class="history-list" id="missionsHistoryList">
                                <div class="history-item pending" data-id="m1">
                                    <span class="history-item-icon">ðŸ“¦</span>
                                    <span class="history-item-text">Jour 3 - Vendre iPhone</span>
                                    <span class="history-item-result">En attente</span>
                                    <div class="history-item-actions">
                                        <button class="mission-btn validate" onclick="validateMission('m1', 180)">âœ“</button>
                                        <button class="mission-btn delete" onclick="deleteMission('m1')">Ã—</button>
                                    </div>
                                </div>
                                <div class="history-item completed" data-id="m2">
                                    <span class="history-item-icon">ðŸ±</span>
                                    <span class="history-item-text">Jour 2 - Meal prep</span>
                                    <span class="history-item-result earned">OK</span>
                                    <div class="history-item-actions">
                                        <button class="mission-btn delete" onclick="deleteMission('m2')">Ã—</button>
                                    </div>
                                </div>
                                <div class="history-item pending" data-id="m3">
                                    <span class="history-item-icon">ðŸ“ž</span>
                                    <span class="history-item-text">Jour 2 - Contacter ecole</span>
                                    <span class="history-item-result">En cours</span>
                                    <div class="history-item-actions">
                                        <button class="mission-btn validate" onclick="validateMission('m3', 0)">âœ“</button>
                                        <button class="mission-btn delete" onclick="deleteMission('m3')">Ã—</button>
                                    </div>
                                </div>
                                <div class="history-item completed" data-id="m4">
                                    <span class="history-item-icon">ðŸ‘•</span>
                                    <span class="history-item-text">Jour 1 - Poster vetements</span>
                                    <span class="history-item-result earned">+35â‚¬</span>
                                    <div class="history-item-actions">
                                        <button class="mission-btn delete" onclick="deleteMission('m4')">Ã—</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Badges Achievements -->
                        <div class="badges-section" id="badgesSection" style="margin-top:16px;">
                            <div class="badges-title">
                                <span>ðŸ†</span> Tes Achievements
                            </div>
                            <div class="badges-grid">
                                <div class="badges-column">
                                    <h5>Montant</h5>
                                    <div class="badge-item locked" id="badge-amount33">
                                        <span class="badge-icon">ðŸ¥‰</span>
                                        <div class="badge-info">
                                            <div class="badge-name">Premier Palier</div>
                                            <div class="badge-desc">33% de l'objectif (166â‚¬)</div>
                                        </div>
                                        <span class="badge-check" style="display:none;">âœ“</span>
                                    </div>
                                    <div class="badge-item locked" id="badge-amount66">
                                        <span class="badge-icon">ðŸ¥ˆ</span>
                                        <div class="badge-info">
                                            <div class="badge-name">Deuxieme Palier</div>
                                            <div class="badge-desc">66% de l'objectif (333â‚¬)</div>
                                        </div>
                                        <span class="badge-check" style="display:none;">âœ“</span>
                                    </div>
                                    <div class="badge-item locked" id="badge-amount100">
                                        <span class="badge-icon">ðŸ¥‡</span>
                                        <div class="badge-info">
                                            <div class="badge-name">Objectif Atteint</div>
                                            <div class="badge-desc">100% de l'objectif (500â‚¬)</div>
                                        </div>
                                        <span class="badge-check" style="display:none;">âœ“</span>
                                    </div>
                                </div>
                                <div class="badges-column">
                                    <h5>Temps (pondere)</h5>
                                    <div class="badge-item locked" id="badge-time33">
                                        <span class="badge-icon">â±ï¸</span>
                                        <div class="badge-info">
                                            <div class="badge-name">Premier Sprint</div>
                                            <div class="badge-desc">33% du temps effectif</div>
                                        </div>
                                        <span class="badge-check" style="display:none;">âœ“</span>
                                    </div>
                                    <div class="badge-item locked" id="badge-time66">
                                        <span class="badge-icon">â³</span>
                                        <div class="badge-info">
                                            <div class="badge-name">Mi-Parcours</div>
                                            <div class="badge-desc">66% du temps effectif</div>
                                        </div>
                                        <span class="badge-check" style="display:none;">âœ“</span>
                                    </div>
                                    <div class="badge-item locked" id="badge-time100">
                                        <span class="badge-icon">ðŸ</span>
                                        <div class="badge-info">
                                            <div class="badge-name">Ligne d'Arrivee</div>
                                            <div class="badge-desc">100% du temps effectif</div>
                                        </div>
                                        <span class="badge-check" style="display:none;">âœ“</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="disruptive-box">
                        <h4>Why it's disruptive:</h4>
                        <p>- <strong>Vue unifiee</strong>: Calendar + Track au meme endroit<br>- <strong>Comeback detection</strong>: rattrapage automatique apres exams<br>- <strong>Energy debt</strong>: protege du burnout<br>- <strong>Badges ponderes</strong>: tient compte de la charge</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast-container">
        <div class="toast success" id="toast">
            <span class="toast-icon">OK</span>
            <span class="toast-message" id="toastMessage">Action completed!</span>
            <button class="toast-close" onclick="hideToast()">x</button>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        let currentCase = 0;
        let currentScenarioIndex = 0;
        let selectedScenarios = [];
        let chatStep = 0;
        let userAnswers = {};
        let currentProfile = null;

        // Day Simulation State
        const daySimState = {
            currentDay: 1,
            totalDays: 56,
            todayEnergyChecked: false,
            energyHistory: [], // [{day, score, factors}]
            onboardingComplete: false,
            setupComplete: false,
            selectedEnergyScore: null,
            selectedEnergyFactors: [],
            // New for geoloc/inventory/missions
            userCity: null,
            userInventory: [], // [{id, category, name, estimatedPrice, status, soldPrice}]
            missions: [], // [{id, type, day, status, data, earnedAmount}]
            soldTotal: 0,
            currentPopupStep: 1,
            // New for recalcul + progression + badges
            economiesTotal: 0,       // EUR saved (meal prep, etc.)
            jobsTotal: 0,            // EUR from jobs
            goalAmount: 500,         // Initial goal
            // Weekly capacity weights (exams = lower capacity)
            weeklyCapacity: [1, 1, 1, 0.2, 0.8, 1, 0.6, 1], // S1-S8, S4=exams, S7=project
            // Badges unlocked
            badges: {
                amount33: false,
                amount66: false,
                amount100: false,
                time33: false,
                time66: false,
                time100: false
            }
        };

        // ========== CITY DATA (Geoloc) ==========
        const cityData = {
            paris: {
                name: "Paris",
                suggestions: {
                    vente: ["Marche aux puces Montreuil - samedi 8h-14h", "Vide-grenier Bastille - dimanche", "Brocante Belleville - 1er weekend"],
                    musicien: ["Ecole de musique du 11e - 25 EUR/h", "Bars jazz Oberkampf - 80 EUR/soiree"],
                    dev: ["Meetup Paris.js - networking", "Station F - missions freelance"]
                }
            },
            lyon: {
                name: "Lyon",
                suggestions: {
                    vente: ["Puces du Canal - dimanche matin", "Brocante Croix-Rousse - samedi"],
                    musicien: ["Conservatoire Lyon 3e - 22 EUR/h"],
                    dev: ["Lyon Tech Hub - networking", "H7 coworking - missions"]
                }
            },
            marseille: {
                name: "Marseille",
                suggestions: {
                    vente: ["Marche aux puces Arnavaux - dimanche", "Brocante Noailles - samedi"],
                    musicien: ["Ecole IMFP - 20 EUR/h", "Bars Cours Julien - 60 EUR/soiree"],
                    dev: ["French Tech Aix-Marseille", "The Camp - coworking"]
                }
            },
            toulouse: {
                name: "Toulouse",
                suggestions: {
                    vente: ["Marche Saint-Sernin - weekend", "Puces de l'Hers - dimanche"],
                    dev: ["Toulouse Tech - meetups"]
                }
            },
            bordeaux: {
                name: "Bordeaux",
                suggestions: {
                    vente: ["Puces de Saint-Michel - dimanche", "Brocante Chartrons - samedi"],
                    dev: ["Bordeaux Tech Hub"]
                }
            }
        };

        // ========== INVENTORY CATEGORIES ==========
        const inventoryCategories = {
            vetements: { icon: "ðŸ‘•", name: "Vetements", avgPrice: 15, platforms: ["Vinted", "Vestiaire Collective"] },
            electronique: { icon: "ðŸ“±", name: "Electronique", avgPrice: 80, platforms: ["Leboncoin", "Back Market"] },
            livres: { icon: "ðŸ“š", name: "Livres", avgPrice: 8, platforms: ["Momox", "Gibert"] },
            instruments: { icon: "ðŸŽ¸", name: "Instruments", avgPrice: 120, platforms: ["Leboncoin", "Audiofanzine"] },
            meubles: { icon: "ðŸª‘", name: "Meubles", avgPrice: 45, platforms: ["Leboncoin", "FB Marketplace"] },
            jeux: { icon: "ðŸŽ®", name: "Jeux video", avgPrice: 25, platforms: ["Leboncoin", "CeX"] }
        };

        // ========== MISSION TYPES ==========
        const missionTypes = {
            sell_item: { icon: "ðŸ“¦", title: "Vendre un objet", cardClass: "priority" },
            meal_prep: { icon: "ðŸ±", title: "Meal prep", cardClass: "food" },
            batch_cook: { icon: "ðŸ¥˜", title: "Cuisiner en batch", cardClass: "food" },
            contact_lead: { icon: "ðŸ“ž", title: "Contacter prospect", cardClass: "" },
            local_event: { icon: "ðŸ“", title: "Evenement local", cardClass: "local" }
        };

        // ========== PROFILES ==========
        const profiles = {
            new: {
                name: "Nouvel utilisateur",
                description: "Profil vide - Onboarding non fait",
                onboarding_complete: false,
                notifications: [
                    { id: 1, icon: "Wave", text: "Bienvenue! Complete ton profil", time: "Now", target: 0, type: "warning" }
                ],
                badges: { 0: { show: true, type: "warning", text: "!" } },
                traces: [
                    { name: "session_start", duration: "12ms" },
                    { name: "onboarding_init", duration: "8ms" }
                ],
                startScreen: 0
            },
            active: {
                name: "Etudiant actif (S3)",
                description: "Semaine 3/8 - 45% progress - Energy 75%",
                onboarding_complete: true,
                notifications: [
                    { id: 1, icon: "Target", text: "45% de ton objectif atteint!", time: "2h", target: 1, type: "info" },
                    { id: 2, icon: "Lightning", text: "Energy check-in hebdo", time: "Now", target: 2, type: "warning" }
                ],
                badges: {
                    1: { show: true, type: "info", text: "1" },
                    4: { show: true, type: "warning", text: "!" }
                },
                traces: [
                    { name: "budget_analysis", duration: "67ms" },
                    { name: "skill_matching", duration: "89ms" },
                    { name: "preference_update", duration: "45ms" }
                ],
                startScreen: 1
            },
            comeback: {
                name: "Post-exams (comeback)",
                description: "S5 - Energy 90% - Deficit 126 EUR - Comeback detecte!",
                onboarding_complete: true,
                notifications: [
                    { id: 1, icon: "Fire", text: "Comeback window detecte!", time: "2h", target: 1, type: "info" },
                    { id: 2, icon: "Document", text: "Nouveau plan disponible", time: "1h", target: 1, type: "success" }
                ],
                badges: {
                    1: { show: true, type: "info", text: "2" }
                },
                traces: [
                    { name: "energy_trend_analysis", duration: "45ms" },
                    { name: "comeback_detection", duration: "23ms" },
                    { name: "catchup_plan_generation", duration: "156ms" },
                    { name: "guardian_validation", duration: "342ms" }
                ],
                startScreen: 1,
                prompt: { icon: "Fire", title: "Comeback Window!", text: "Tu es pret pour rattraper ton retard?" }
            },
            energy_debt: {
                name: "Energy debt detecte",
                description: "S4 - Energy 32% - 3 semaines low - Target reduit",
                onboarding_complete: true,
                notifications: [
                    { id: 1, icon: "Warning", text: "Energy debt accumule", time: "Now", target: 2, type: "warning" },
                    { id: 2, icon: "Trophy", text: "Badge Self Care debloque!", time: "1h", target: 2, type: "success" }
                ],
                badges: {
                    4: { show: true, type: "warning", text: "2" }
                },
                traces: [
                    { name: "energy_aggregation", duration: "34ms" },
                    { name: "debt_detection", duration: "23ms" },
                    { name: "target_reduction", duration: "18ms" },
                    { name: "achievement_unlock", duration: "12ms" }
                ],
                startScreen: 4,
                prompt: { icon: "Lightning", title: "Energy Check-in", text: "Comment te sens-tu cette semaine?" }
            }
        };

        // ========== CHAT QUESTIONS ==========
        const chatQuestions = [
            { q: "Quel est ton niveau d'etudes?", field: "level", reformulate: v => `Niveau: ${v}` },
            { q: "Quels sont tes revenus mensuels?", field: "income", reformulate: v => `Revenus: ${v}` },
            { q: "Quelles sont tes depenses principales?", field: "expenses", reformulate: v => `Depenses: ${v}` },
            { q: "Quelles sont tes competences?", field: "skills", reformulate: v => `Skills: ${v}` },
            { q: "Quel est ton objectif financier?", field: "goal", reformulate: v => `Objectif: ${v}` },
            { q: "Quelle est ton echeance?", field: "deadline", reformulate: v => `Echeance: ${v}` },
            { q: "Y a-t-il des periodes difficiles prevues (exams, etc)?", field: "difficult", reformulate: v => `Periodes difficiles: ${v}` },
            { q: "Dans quelle ville es-tu?", field: "city", reformulate: v => `Ville: ${v}`, type: "dropdown" },
            { q: "Tu as des trucs a vendre? (selectionne ce qui t'interesse)", field: "inventory", reformulate: v => `A vendre: ${v}`, type: "chips" }
        ];

        const defaultAnswers = {
            level: "L2 Informatique",
            income: "800 EUR/mois",
            expenses: "750 EUR (loyer 450, courses 150, transport 50, loisirs 100)",
            skills: "Python, SQL, Anglais B2",
            goal: "Economiser 500 EUR pour les vacances",
            deadline: "8 semaines",
            difficult: "Examens semaine 4",
            city: "Paris",
            inventory: "Vetements, Electronique, Livres"
        };

        const scenarios = [
            { emoji: "Briefcase", title: "Freelance Dev", value: "+120 EUR/mois", details: "Rate: 25 EUR/h\nEffort: High\nTime: 10h/week" },
            { emoji: "Book", title: "Tutoring Math", value: "+80 EUR/mois", details: "Rate: 20 EUR/h\nEffort: Moderate\nTime: 6h/week" },
            { emoji: "Package", title: "Sell 3 Items", value: "+80 EUR one-time", details: "Effort: Low\nTime: 2h\nOccasional" },
            { emoji: "Pen", title: "SQL Coaching", value: "+90 EUR/mois", details: "Rate: 22 EUR/h\nEffort: Moderate\nTime: 6h/week" }
        ];

        // ========== INIT ==========
        function init() {
            addChatMessage("Bienvenue sur Stride! Je vais te poser quelques questions pour personnaliser ton experience.", "bot");
            setTimeout(() => askNextQuestion(), 800);
        }

        // ========== PROFILE MANAGEMENT ==========
        function loadProfile(profileId) {
            if (!profileId) return;
            currentProfile = profiles[profileId];
            if (!currentProfile) return;

            // Update profile info
            const info = document.getElementById("profileInfo");
            info.textContent = currentProfile.description;
            info.classList.add("show");

            // Reset all badges
            for (let i = 0; i <= 4; i++) {
                document.getElementById(`badge-${i}`).style.display = "none";
            }

            // Set badges from profile
            if (currentProfile.badges) {
                Object.entries(currentProfile.badges).forEach(([idx, badge]) => {
                    if (badge.show) {
                        const el = document.getElementById(`badge-${idx}`);
                        el.style.display = "inline";
                        el.textContent = badge.text;
                        el.className = `menu-badge ${badge.type}`;
                        if (badge.type === "warning") el.classList.add("pulse");
                    }
                });
            }

            // Update notifications
            updateNotifications(currentProfile.notifications || []);

            // Update Opik traces
            updateOpikTraces(currentProfile.traces || []);

            // Switch to start screen
            switchCase(currentProfile.startScreen);

            // Show prompt if exists
            if (currentProfile.prompt) {
                showPrompt(currentProfile.prompt.icon, currentProfile.prompt.title, currentProfile.prompt.text);
            } else {
                dismissPrompt();
            }

            // Handle onboarding state
            if (!currentProfile.onboarding_complete) {
                document.getElementById("chatMessages").innerHTML = "";
                chatStep = 0;
                userAnswers = {};
                document.getElementById("onboardingSummary").classList.remove("show");
                init();
            }

            // Update progression display
            updateProgressDisplay();
            renderBadges();

            showToast(`Profil "${currentProfile.name}" charge!`);
        }

        // Current notifications state
        let currentNotifications = [];

        function updateNotifications(notifications) {
            currentNotifications = notifications;
            const list = document.getElementById("notificationList");
            const count = document.getElementById("notifCount");

            if (notifications.length > 0) {
                count.textContent = notifications.length;
                count.classList.remove('hidden');
                list.innerHTML = notifications.map(n => `
                    <div class="notification-item unread" onclick="handleNotification(${n.target})">
                        <span class="notif-icon">${n.icon}</span>
                        <div class="notif-content">
                            <div class="notif-text">${n.text}</div>
                            <div class="notif-time">${n.time}</div>
                        </div>
                    </div>
                `).join("");
            } else {
                count.classList.add('hidden');
                list.innerHTML = '<div class="notif-empty">Aucune notification</div>';
            }
        }

        function addNotification(icon, text, time, target, type) {
            currentNotifications.unshift({ icon, text, time, target, type, id: Date.now() });
            updateNotifications(currentNotifications);
        }

        function updateOpikTraces(traces) {
            const container = document.getElementById("opikTraces");
            container.innerHTML = traces.map(t => `
                <div class="trace-item">
                    <span class="trace-name">${t.name}</span>
                    <span class="trace-duration">${t.duration}</span>
                </div>
            `).join("");
        }

        function handleNotification(target) {
            switchCase(target);
        }

        // ========== NAVIGATION ==========
        function switchCase(caseNum) {
            currentCase = caseNum;
            document.querySelectorAll(".case-container").forEach(el => el.classList.remove("active"));
            document.getElementById(`case-${caseNum}`).classList.add("active");

            document.querySelectorAll(".nav-button").forEach(el => el.classList.remove("active"));
            document.getElementById(`nav-${caseNum}`).classList.add("active");

            const titles = ["Onboarding", "Mon Plan", "Suivi"];
            document.getElementById("headerTitle").textContent = titles[caseNum];
        }

        // ========== CHAT SYSTEM ==========
        function addChatMessage(text, type, showConfirmation = false) {
            const messages = document.getElementById("chatMessages");
            const msg = document.createElement("div");
            msg.className = `chat-message ${type}`;

            if (showConfirmation) {
                msg.className = "chat-message confirmation";
                msg.innerHTML = `
                    <div>OK ${text}</div>
                    <div class="confirmation-buttons">
                        <button class="confirm-yes" onclick="confirmAnswer()">Oui</button>
                        <button class="confirm-no" onclick="modifyAnswer()">Modifier</button>
                    </div>
                `;
            } else {
                msg.textContent = text;
            }

            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function askNextQuestion() {
            if (chatStep >= chatQuestions.length) {
                showOnboardingSummary();
                return;
            }
            addChatMessage(chatQuestions[chatStep].q, "bot");
        }

        function sendChatMessage() {
            const input = document.getElementById("chatInput");
            const text = input.value.trim();
            if (!text) return;

            addChatMessage(text, "user");
            input.value = "";

            const field = chatQuestions[chatStep].field;
            userAnswers[field] = text;

            setTimeout(() => {
                const reformulated = chatQuestions[chatStep].reformulate(text);
                addChatMessage(reformulated, "bot", true);
            }, 500);
        }

        function handleChatKeypress(e) {
            if (e.key === "Enter") sendChatMessage();
        }

        function confirmAnswer() {
            chatStep++;
            setTimeout(() => askNextQuestion(), 300);
        }

        function modifyAnswer() {
            addChatMessage("D'accord, reformule ta reponse.", "bot");
        }

        function toggleVoice() {
            const btn = document.getElementById("voiceBtn");
            if (btn.classList.contains("recording")) {
                btn.classList.remove("recording");
                // Simulate voice transcription
                const field = chatQuestions[chatStep].field;
                const answer = defaultAnswers[field];
                document.getElementById("chatInput").value = answer;
                setTimeout(() => sendChatMessage(), 300);
            } else {
                btn.classList.add("recording");
                showToast("Enregistrement...");
                setTimeout(() => {
                    if (btn.classList.contains("recording")) {
                        toggleVoice();
                    }
                }, 2000);
            }
        }

        function showOnboardingSummary() {
            addChatMessage("Parfait! Voici le recapitulatif de ton profil.", "bot");

            const grid = document.getElementById("summaryGrid");
            grid.innerHTML = Object.entries(userAnswers).map(([k, v]) => `
                <div class="summary-item">
                    <div class="summary-label">${k}</div>
                    <div class="summary-value">${v}</div>
                </div>
            `).join("");

            setTimeout(() => {
                document.getElementById("onboardingSummary").classList.add("show");
            }, 500);
        }

        function completeOnboarding() {
            // Hide onboarding badge
            document.getElementById("badge-0").style.display = "none";

            // Add badges to other screens
            document.getElementById("badge-1").style.display = "inline";
            document.getElementById("badge-2").style.display = "inline";

            // Save city to state
            if (userAnswers.city) {
                daySimState.userCity = userAnswers.city.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                updateLocalSuggestions();
                updateOpikTraces([{ name: 'geo_city_selected', duration: '23ms' }, { name: `city_${daySimState.userCity}`, duration: '8ms' }]);
            }

            // Mark onboarding complete
            daySimState.onboardingComplete = true;
            updateNextDayButton();

            // Update notifications
            updateNotifications([
                { id: 1, icon: "Briefcase", text: "Nouveau job matche: SQL Coaching", time: "Now", target: 1, type: "success" },
                { id: 2, icon: "Cards", text: "Swipe tes preferences", time: "Now", target: 1, type: "info" },
                { id: 3, icon: "Package", text: "Ton inventaire est pret!", time: "Now", target: 1, type: "success" }
            ]);

            // Update traces
            updateOpikTraces([
                { name: "profile_creation", duration: "45ms" },
                { name: "budget_analysis", duration: "67ms" },
                { name: "skill_extraction", duration: "89ms" },
                { name: "job_matching", duration: "112ms" },
                { name: "inventory_init", duration: "34ms" }
            ]);

            showToast("Profil cree! Bienvenue sur Stride");
            switchCase(1); // Go to Mon Plan
        }

        // ========== PROMPTS ==========
        function showPrompt(icon, title, text) {
            document.getElementById("promptIcon").textContent = icon;
            document.getElementById("promptTitle").textContent = title;
            document.getElementById("promptText").textContent = text;
            document.getElementById("interactionPrompt").classList.add("show");
        }

        function respondToPrompt() {
            dismissPrompt();
            showToast("Reponse enregistree!");
        }

        function dismissPrompt() {
            document.getElementById("interactionPrompt").classList.remove("show");
        }

        // ========== ROLL THE DICE ==========
        let swipeSessionActive = false;
        let compiledScenarios = [];

        function rollTheDice() {
            // Compile data from all tabs
            compileScenarios();

            // Freeze other tabs
            freezeTabs(true);

            // Hide roll dice, show swipe
            document.getElementById('rollDiceContainer').style.display = 'none';
            document.getElementById('swipeContainer').style.display = 'flex';

            // Reset swipe state
            currentScenarioIndex = 0;
            selectedScenarios = [];
            scenarios = compiledScenarios;
            swipeSessionActive = true;

            // Update UI
            document.getElementById('totalScenarios').textContent = scenarios.length;
            document.getElementById('currentScenario').textContent = '1';
            updateScenarioCard();

            showToast('ðŸŽ² ScÃ©narios compilÃ©s! Swipe pour choisir.');
            updateOpikTraces([
                { name: 'roll_the_dice', duration: '250ms' },
                { name: 'scenarios_compiled', duration: '180ms', input: scenarios.length + ' scenarios' }
            ]);
        }

        function compileScenarios() {
            // Compile scenarios based on all tabs data
            compiledScenarios = [];

            // From Skills (Arbitrage tab)
            compiledScenarios.push({
                emoji: 'ðŸ’»',
                title: 'SQL Coaching',
                value: '+88â‚¬/mois',
                details: 'Rate: 22â‚¬/h\nEffort: ModÃ©rÃ©\nTime: 4h/semaine\nScore: 8.7/10',
                type: 'skill',
                source: 'arbitrage'
            });

            compiledScenarios.push({
                emoji: 'ðŸ',
                title: 'Python Freelance',
                value: '+100â‚¬/mois',
                details: 'Rate: 25â‚¬/h\nEffort: Ã‰levÃ©\nTime: 4h/semaine\nScore: 6.2/10',
                type: 'skill',
                source: 'arbitrage'
            });

            // From Inventory (items to sell)
            const inventoryItems = document.querySelectorAll('#inventoryGrid .inventory-item');
            inventoryItems.forEach((item, i) => {
                if (i < 2) { // Limit to 2 items for demo
                    const name = item.querySelector('.inventory-name')?.textContent || 'Objet';
                    const price = item.querySelector('.inventory-price')?.textContent || '50â‚¬';
                    compiledScenarios.push({
                        emoji: 'ðŸ“¦',
                        title: `Vendre: ${name}`,
                        value: price,
                        details: `Plateforme: Leboncoin\nEffort: Faible\nTemps: 1-2h total`,
                        type: 'sell',
                        source: 'inventory'
                    });
                }
            });

            // From Lifestyle (savings)
            const lifestyleSavings = document.getElementById('lifestyleSavings')?.textContent || '~180â‚¬/mois';
            compiledScenarios.push({
                emoji: 'ðŸ§˜',
                title: 'Optimiser Lifestyle',
                value: lifestyleSavings + ' Ã©conomisÃ©',
                details: 'Coloc, meal prep, vÃ©lo...\nEffort: Changement d\'habitudes\nDurÃ©e: Permanent',
                type: 'lifestyle',
                source: 'lifestyle'
            });

            // From Trade
            compiledScenarios.push({
                emoji: 'ðŸ”„',
                title: 'Emprunter Ã©quipement',
                value: '-145â‚¬ sur objectif',
                details: 'Tente + sac couchage + rÃ©chaud\nEmprunt Ã  des amis\nRÃ©duit le budget nÃ©cessaire',
                type: 'trade',
                source: 'trade'
            });

            // Update summary before roll
            document.getElementById('summarySkills').textContent = '2 jobs suggÃ©rÃ©s';
            document.getElementById('summaryItems').textContent = inventoryItems.length + ' objets';
            document.getElementById('summaryLifestyle').textContent = lifestyleSavings;
            document.getElementById('summaryTrades').textContent = '3 Ã©quipements';
        }

        function freezeTabs(freeze) {
            const tabsToFreeze = ['setup', 'arbitrage', 'inventory', 'lifestyle', 'trade'];
            tabsToFreeze.forEach(tab => {
                const tabBtn = document.querySelector(`.plan-tab[onclick*="${tab}"]`);
                if (tabBtn) {
                    if (freeze) tabBtn.classList.add('frozen');
                    else tabBtn.classList.remove('frozen');
                }
            });

            // Freeze onboarding nav
            const onboardingNav = document.getElementById('nav-0');
            if (onboardingNav) {
                if (freeze) onboardingNav.classList.add('frozen');
                else onboardingNav.classList.remove('frozen');
            }
        }

        function cancelSwipeSession() {
            swipeSessionActive = false;
            freezeTabs(false);

            // Show roll dice, hide swipe
            document.getElementById('rollDiceContainer').style.display = 'flex';
            document.getElementById('swipeContainer').style.display = 'none';

            showToast('Session swipe annulÃ©e');
            updateOpikTraces([{ name: 'swipe_session_cancelled', duration: '10ms' }]);
        }

        // ========== SWIPE ==========
        function swipeNo() { nextScenario(); }

        function swipeYes() {
            const scenario = scenarios[currentScenarioIndex];
            selectedScenarios.push(scenario.title);

            // Add to missions in Suivi
            addMissionFromSwipe(scenario);

            updateSelectedList();
            nextScenario();
        }

        function addMissionFromSwipe(scenario) {
            const typeIcons = { skill: 'ðŸ’¼', sell: 'ðŸ“¦', lifestyle: 'ðŸ§˜', trade: 'ðŸ”„' };
            const mission = {
                id: Date.now(),
                icon: typeIcons[scenario.type] || 'ðŸ“‹',
                title: scenario.title,
                value: scenario.value,
                status: 'pending',
                source: 'swipe'
            };
            daySimState.swipeMissions = daySimState.swipeMissions || [];
            daySimState.swipeMissions.push(mission);
        }

        function nextScenario() {
            if (currentScenarioIndex < scenarios.length - 1) {
                currentScenarioIndex++;
                updateScenarioCard();
                document.getElementById("currentScenario").textContent = currentScenarioIndex + 1;
            } else {
                showSwipeResults();
            }
        }

        function updateScenarioCard() {
            const s = scenarios[currentScenarioIndex];
            const card = document.getElementById("swipeCard");
            card.innerHTML = `
                <div class="swipe-emoji">${s.emoji}</div>
                <div class="swipe-title">${s.title}</div>
                <div class="swipe-value">${s.value}</div>
                <div class="swipe-description">${s.details.replace(/\n/g, "<br>")}</div>
                <div class="swipe-controls">
                    <button class="swipe-btn no" onclick="swipeNo()">X</button>
                    <button class="swipe-btn yes" onclick="swipeYes()">OK</button>
                </div>
            `;
        }

        function updateSelectedList() {
            document.getElementById("selectedList").innerHTML = selectedScenarios.map(s => `<div>+ ${s}</div>`).join("");
        }

        function showSwipeResults() {
            // Unfreeze tabs
            freezeTabs(false);
            swipeSessionActive = false;

            document.getElementById("swipeSelected").classList.add("show");
            document.getElementById("learnedPrefs").innerHTML = `
                <div style="background: linear-gradient(135deg, #1e293b, #334155); padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #60a5fa;">ðŸ§  Stride apprend de tes choix</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px;">FlexibilitÃ© horaire</span>
                            <span style="color: #22c55e; font-weight: 600;">+20% â†‘</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px;">SensibilitÃ© effort</span>
                            <span style="color: #22c55e; font-weight: 600;">+15% â†‘</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px;">PrioritÃ© taux horaire</span>
                            <span style="color: #ef4444; font-weight: 600;">-10% â†“</span>
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #475569; font-size: 11px; color: #94a3b8;">
                        Tu prÃ©fÃ¨res la flexibilitÃ© au taux horaire - Stride ajuste ses recommandations!
                    </div>
                </div>
                <strong style="color: #22c55e;">${selectedScenarios.length} missions ajoutÃ©es au Suivi!</strong>
            `;

            // Render missions in Suivi
            renderSwipeMissions();

            addNotification('âœ…', `${selectedScenarios.length} missions ajoutÃ©es!`, 'Now', 2, 'success');

            updateOpikTraces([
                { name: "swipe_session", duration: "3.2s" },
                { name: "preference_learning", duration: "67ms" },
                { name: "missions_added", duration: "45ms", input: selectedScenarios.length }
            ]);
        }

        // ========== ENERGY ==========
        function selectEnergy(el) {
            document.querySelectorAll(".energy-item").forEach(e => e.classList.remove("selected"));
            el.classList.add("selected");
            showToast("Energy check-in enregistre!");
        }

        // ========== SKILL ARBITRAGE - EXPLAINABILITY ==========
        const jobScoreDetails = {
            python_dev: {
                name: "Python Dev",
                rate: { value: "25 EUR/h", raw: 8.3, weight: 30, contrib: 2.49 },
                demand: { value: "5 stars", raw: 10.0, weight: 25, contrib: 2.50 },
                effort: { value: "Very High", raw: 3.0, weight: 25, contrib: 0.75 },
                rest: { value: "Low", raw: 2.0, weight: 20, contrib: 0.40 },
                total: 6.14,
                normalized: 6.2
            },
            sql_coaching: {
                name: "SQL Coaching",
                rate: { value: "22 EUR/h", raw: 7.3, weight: 30, contrib: 2.19 },
                demand: { value: "4 stars", raw: 8.0, weight: 25, contrib: 2.00 },
                effort: { value: "Moderate", raw: 8.5, weight: 25, contrib: 2.13 },
                rest: { value: "High", raw: 9.0, weight: 20, contrib: 1.80 },
                total: 8.12,
                normalized: 8.7
            },
            data_entry: {
                name: "Data Entry",
                rate: { value: "12 EUR/h", raw: 4.0, weight: 30, contrib: 1.20 },
                demand: { value: "4 stars", raw: 8.0, weight: 25, contrib: 2.00 },
                effort: { value: "Very Low", raw: 9.5, weight: 25, contrib: 2.38 },
                rest: { value: "High", raw: 9.0, weight: 20, contrib: 1.80 },
                total: 7.38,
                normalized: 7.1
            }
        };

        const newSkillJobs = {
            react: [
                { name: "Frontend Dev", rate: "28 EUR/h", score: 7.4 },
                { name: "React Tutoring", rate: "24 EUR/h", score: 8.2 }
            ],
            excel: [
                { name: "Data Analyst", rate: "20 EUR/h", score: 7.8 },
                { name: "Excel Training", rate: "18 EUR/h", score: 8.5 }
            ],
            javascript: [
                { name: "JS Developer", rate: "26 EUR/h", score: 7.6 },
                { name: "Web Tutoring", rate: "22 EUR/h", score: 8.1 }
            ]
        };

        let openExplainPanel = null;
        let openContestChat = null;

        function toggleExplain(jobId) {
            const row = document.getElementById(`explain-row-${jobId}`);
            const panel = document.getElementById(`explain-panel-${jobId}`);

            // Close other panels
            if (openExplainPanel && openExplainPanel !== jobId) {
                document.getElementById(`explain-row-${openExplainPanel}`).style.display = 'none';
            }
            if (openContestChat) {
                document.getElementById(`contest-row-${openContestChat}`).style.display = 'none';
                openContestChat = null;
            }

            if (row.style.display === 'none') {
                // Generate panel content
                const job = jobScoreDetails[jobId];
                panel.innerHTML = `
                    <div class="explain-header">
                        <span class="explain-title">Detail du score: ${job.name}</span>
                        <button class="explain-close" onclick="toggleExplain('${jobId}')">x</button>
                    </div>
                    <div class="explain-row">
                        <span class="explain-criterion">Rate (${job.rate.value})</span>
                        <span class="explain-raw">${job.rate.raw}/10</span>
                        <span class="explain-weight">x ${job.rate.weight}%</span>
                        <span class="explain-contrib">=${job.rate.contrib.toFixed(2)}</span>
                    </div>
                    <div class="explain-row">
                        <span class="explain-criterion">Demand (${job.demand.value})</span>
                        <span class="explain-raw">${job.demand.raw}/10</span>
                        <span class="explain-weight">x ${job.demand.weight}%</span>
                        <span class="explain-contrib">=${job.demand.contrib.toFixed(2)}</span>
                    </div>
                    <div class="explain-row">
                        <span class="explain-criterion">Effort (${job.effort.value})</span>
                        <span class="explain-raw">${job.effort.raw}/10</span>
                        <span class="explain-weight">x ${job.effort.weight}%</span>
                        <span class="explain-contrib">=${job.effort.contrib.toFixed(2)}</span>
                    </div>
                    <div class="explain-row">
                        <span class="explain-criterion">Rest (${job.rest.value})</span>
                        <span class="explain-raw">${job.rest.raw}/10</span>
                        <span class="explain-weight">x ${job.rest.weight}%</span>
                        <span class="explain-contrib">=${job.rest.contrib.toFixed(2)}</span>
                    </div>
                    <div class="explain-total">
                        <span>Total</span>
                        <span class="explain-score">${job.total.toFixed(2)} -> ${job.normalized}/10</span>
                    </div>
                    <span class="trace-link" onclick="showTraceFromExplain('${jobId}')">Voir trace Opik: multi_criteria_scoring</span>
                `;
                row.style.display = 'table-row';
                openExplainPanel = jobId;

                // Add trace
                addSkillArbitrageTrace('explainability_view', { job: jobId });
            } else {
                row.style.display = 'none';
                openExplainPanel = null;
            }
        }

        function showTraceFromExplain(jobId) {
            updateOpikTraces([
                { name: 'skill_extraction', duration: '67ms' },
                { name: 'graph_job_matching', duration: '89ms' },
                { name: 'multi_criteria_scoring', duration: '112ms' },
                { name: `score_${jobId}`, duration: '23ms' }
            ]);
            showToast('Traces Opik mises a jour');
        }

        // ========== SKILL ARBITRAGE - FEEDBACK ==========
        function validateJob(jobId) {
            const btn = document.getElementById(`thumbup-${jobId}`);
            btn.classList.add('validated');
            showToast(`Feedback positif pour ${jobScoreDetails[jobId].name} enregistre!`);
            addSkillArbitrageTrace('feedback_positive', { job: jobId });
        }

        function contestJob(jobId) {
            const row = document.getElementById(`contest-row-${jobId}`);
            const chat = document.getElementById(`contest-chat-${jobId}`);

            // Close other panels
            if (openExplainPanel) {
                document.getElementById(`explain-row-${openExplainPanel}`).style.display = 'none';
                openExplainPanel = null;
            }
            if (openContestChat && openContestChat !== jobId) {
                document.getElementById(`contest-row-${openContestChat}`).style.display = 'none';
            }

            if (row.style.display === 'none') {
                const job = jobScoreDetails[jobId];
                chat.innerHTML = `
                    <div class="contest-header">
                        <span class="contest-emoji">!</span>
                        <span class="contest-title">Contester "${job.name}"</span>
                        <button class="contest-close" onclick="closeContestJob('${jobId}')">x</button>
                    </div>
                    <div class="contest-messages" id="contest-messages-${jobId}">
                        <div class="contest-msg bot">Qu'est-ce qui ne va pas avec cette evaluation?</div>
                    </div>
                    <div class="contest-input-zone">
                        <input type="text" id="contest-input-${jobId}" placeholder="Ex: Le taux est faux, c'est 30 EUR/h..." onkeypress="handleContestKeypress(event, '${jobId}')">
                        <button onclick="sendContestMessage('${jobId}')">Go</button>
                    </div>
                `;
                row.style.display = 'table-row';
                openContestChat = jobId;
                document.getElementById(`thumbdown-${jobId}`).classList.add('contested');
                addSkillArbitrageTrace('feedback_negative', { job: jobId });
            } else {
                closeContestJob(jobId);
            }
        }

        function closeContestJob(jobId) {
            document.getElementById(`contest-row-${jobId}`).style.display = 'none';
            openContestChat = null;
        }

        function handleContestKeypress(event, jobId) {
            if (event.key === 'Enter') sendContestMessage(jobId);
        }

        function sendContestMessage(jobId) {
            const input = document.getElementById(`contest-input-${jobId}`);
            const text = input.value.trim();
            if (!text) return;

            const messages = document.getElementById(`contest-messages-${jobId}`);
            messages.innerHTML += `<div class="contest-msg user">${text}</div>`;
            input.value = '';

            // Simulate AI response
            setTimeout(() => {
                const job = jobScoreDetails[jobId];
                let response = '';
                let newScore = job.normalized;

                if (text.match(/taux|rate|eur|euro|â‚¬/i)) {
                    const match = text.match(/(\d+)/);
                    const newRate = match ? match[1] : '30';
                    newScore = (job.normalized + 1.5).toFixed(1);
                    response = `
                        <div class="contest-msg result">
                            <div>OK Taux mis a jour: ${newRate} EUR/h</div>
                            <div style="margin-top:6px; font-size:12px;">Nouveau score: <strong>${newScore}/10</strong> (etait ${job.normalized}/10)</div>
                            <div class="contest-actions">
                                <button class="apply" onclick="applyContestCorrection('${jobId}', ${newScore}, '${newRate} EUR/h')">Appliquer</button>
                                <button class="cancel" onclick="closeContestJob('${jobId}')">Annuler</button>
                            </div>
                        </div>
                    `;
                } else if (text.match(/effort|fatigue|facile|difficile/i)) {
                    newScore = (job.normalized + 0.8).toFixed(1);
                    response = `
                        <div class="contest-msg result">
                            <div>OK Effort reclassifie</div>
                            <div style="margin-top:6px; font-size:12px;">Nouveau score: <strong>${newScore}/10</strong> (etait ${job.normalized}/10)</div>
                            <div class="contest-actions">
                                <button class="apply" onclick="applyContestCorrection('${jobId}', ${newScore})">Appliquer</button>
                                <button class="cancel" onclick="closeContestJob('${jobId}')">Annuler</button>
                            </div>
                        </div>
                    `;
                } else {
                    response = `
                        <div class="contest-msg bot">Je prends note de ton feedback. Un expert verifiera cette evaluation.</div>
                    `;
                }

                messages.innerHTML += response;
                messages.scrollTop = messages.scrollHeight;
            }, 600);
        }

        function applyContestCorrection(jobId, newScore, newRate) {
            document.getElementById(`score-${jobId}`).textContent = `${newScore}/10`;
            if (newRate) {
                document.getElementById(`rate-${jobId}`).textContent = newRate;
            }
            jobScoreDetails[jobId].normalized = parseFloat(newScore);
            closeContestJob(jobId);
            showToast('Correction appliquee!');
            addSkillArbitrageTrace('score_correction', { job: jobId, new_score: newScore });
        }

        // ========== SKILL ARBITRAGE - ADD SKILL ==========
        function openAddSkillChat() {
            document.getElementById('addSkillChat').classList.add('show');
            document.getElementById('addSkillMessages').innerHTML = '<div class="add-skill-msg bot">Quelle competence veux-tu ajouter?</div>';
        }

        function closeAddSkillChat() {
            document.getElementById('addSkillChat').classList.remove('show');
        }

        function handleAddSkillKeypress(event) {
            if (event.key === 'Enter') sendAddSkillMessage();
        }

        function sendAddSkillMessage() {
            const input = document.getElementById('addSkillInput');
            const text = input.value.trim();
            if (!text) return;

            const messages = document.getElementById('addSkillMessages');
            messages.innerHTML += `<div class="add-skill-msg user">${text}</div>`;
            input.value = '';

            // Detect skill
            setTimeout(() => {
                let skillKey = 'react'; // default
                if (text.match(/excel/i)) skillKey = 'excel';
                else if (text.match(/javascript|js/i)) skillKey = 'javascript';
                else if (text.match(/react/i)) skillKey = 'react';

                const matchedJobs = newSkillJobs[skillKey] || newSkillJobs.react;
                const skillName = text.split(' ')[0];

                let jobsHtml = matchedJobs.map(j => `
                    <div class="new-job-row">
                        <span>${j.name}</span>
                        <span>${j.rate}</span>
                        <span style="color:#22c55e; font-weight:600;">${j.score}/10</span>
                    </div>
                `).join('');

                messages.innerHTML += `
                    <div class="add-skill-msg bot">
                        OK ${skillName} ajoute a ton profil!
                        <div class="new-jobs-preview">
                            <div class="new-jobs-preview-title">Nouveaux jobs matches: ${matchedJobs.length}</div>
                            ${jobsHtml}
                        </div>
                        <div class="contest-actions">
                            <button class="apply" onclick="addNewJobsToTable('${skillKey}')">Voir details</button>
                            <button class="cancel" onclick="closeAddSkillChat()">Fermer</button>
                        </div>
                    </div>
                `;
                messages.scrollTop = messages.scrollHeight;

                addSkillArbitrageTrace('skill_addition', { skill: skillName, matched_jobs: matchedJobs.length });
            }, 600);
        }

        function addNewJobsToTable(skillKey) {
            const jobs = newSkillJobs[skillKey];
            const tbody = document.getElementById('jobsTableBody');

            jobs.forEach((job, idx) => {
                const jobId = `new_${skillKey}_${idx}`;
                const tr = document.createElement('tr');
                tr.id = `row-${jobId}`;
                tr.innerHTML = `
                    <td style="color:#22c55e;">${job.name} (NEW)</td>
                    <td><strong>${job.rate}</strong></td>
                    <td>4 stars</td>
                    <td style="color:#eab308;">Moderate</td>
                    <td style="color:#22c55e;">High</td>
                    <td style="color:#22c55e; font-weight:700;">${job.score}/10</td>
                    <td class="action-cell">
                        <button class="explain-btn" title="Voir le detail">?</button>
                        <button class="feedback-btn thumbs-up" title="Valider">+</button>
                        <button class="feedback-btn thumbs-down" title="Contester">-</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            closeAddSkillChat();
            showToast(`${jobs.length} nouveaux jobs ajoutes!`);
        }

        function addSkillArbitrageTrace(action, data) {
            const currentTraces = Array.from(document.querySelectorAll('.trace-item')).map(el => ({
                name: el.querySelector('.trace-name').textContent,
                duration: el.querySelector('.trace-duration').textContent
            }));

            const newTrace = {
                name: action,
                duration: `${Math.floor(Math.random() * 40 + 10)}ms`
            };

            updateOpikTraces([...currentTraces.slice(-3), newTrace]);
        }

        // ========== TOAST ==========
        function showToast(message) {
            document.getElementById("toastMessage").textContent = message;
            document.getElementById("toast").classList.add("show");
            setTimeout(hideToast, 3000);
        }

        function hideToast() {
            document.getElementById("toast").classList.remove("show");
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notifDropdown');
            dropdown.classList.toggle('show');
        }

        function clearNotifications(event) {
            event.stopPropagation();
            currentNotifications = [];
            updateNotifications([]);
            showToast('Notifications effacees');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const bell = document.querySelector('.notif-bell');
            const dropdown = document.getElementById('notifDropdown');
            if (bell && dropdown && !bell.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // ========== DAILY CHECK-IN POPUP (3 Steps) ==========
        function showDailyPopup() {
            daySimState.selectedEnergyScore = null;
            daySimState.selectedEnergyFactors = [];
            daySimState.currentPopupStep = 1;
            // Reset UI
            document.querySelectorAll('.energy-emoji-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.energy-factor-checkbox').forEach(cb => cb.classList.remove('selected'));
            document.getElementById('energyPopupSubmit').classList.remove('enabled');
            // Reset steps
            document.querySelectorAll('.mission-step').forEach(s => s.classList.remove('active'));
            document.getElementById('mission-step-1').classList.add('active');
            document.querySelectorAll('.step-dot').forEach((d, i) => {
                d.classList.remove('active', 'completed');
                if (i === 0) d.classList.add('active');
            });
            // Show popup
            document.getElementById('dailyPopupOverlay').classList.add('show');
        }

        // Alias for compatibility
        function showEnergyCheckPopup() { showDailyPopup(); }

        function selectEnergyLevel(score) {
            daySimState.selectedEnergyScore = score;
            document.querySelectorAll('.energy-emoji-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.score) === score);
            });
            updateEnergySubmitButton();
        }

        function toggleEnergyFactor(el) {
            const factor = el.dataset.factor;
            el.classList.toggle('selected');
            if (el.classList.contains('selected')) {
                if (!daySimState.selectedEnergyFactors.includes(factor)) {
                    daySimState.selectedEnergyFactors.push(factor);
                }
            } else {
                daySimState.selectedEnergyFactors = daySimState.selectedEnergyFactors.filter(f => f !== factor);
            }
        }

        function updateEnergySubmitButton() {
            const btn = document.getElementById('energyPopupSubmit');
            if (daySimState.selectedEnergyScore !== null) {
                btn.classList.add('enabled');
            } else {
                btn.classList.remove('enabled');
            }
        }

        function goToStep(stepNum) {
            // Validate step 1 before moving
            if (stepNum === 2 && daySimState.selectedEnergyScore === null) {
                showToast('Selectionne ton niveau d\'energie');
                return;
            }
            // Save energy to history when leaving step 1
            if (stepNum === 2 && daySimState.currentPopupStep === 1) {
                daySimState.energyHistory.push({
                    day: daySimState.currentDay,
                    score: daySimState.selectedEnergyScore,
                    factors: [...daySimState.selectedEnergyFactors]
                });
            }
            daySimState.currentPopupStep = stepNum;
            // Update dots
            document.querySelectorAll('.step-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < stepNum - 1) dot.classList.add('completed');
                if (i === stepNum - 1) dot.classList.add('active');
            });
            // Update steps visibility
            document.querySelectorAll('.mission-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`mission-step-${stepNum}`).classList.add('active');
            // Render content
            if (stepNum === 2) renderYesterdayFeedback();
            if (stepNum === 3) renderTodayMissions();
        }

        function renderYesterdayFeedback() {
            const container = document.getElementById('yesterdayFeedback');
            const yesterday = daySimState.currentDay - 1;
            const pendingMissions = daySimState.missions.filter(m => m.day === yesterday && m.status === 'pending');
            if (pendingMissions.length === 0) {
                container.innerHTML = '<p class="feedback-empty">Pas de missions hier. Continue comme ca!</p>';
                return;
            }
            container.innerHTML = pendingMissions.map(mission => {
                const type = missionTypes[mission.type];
                return `
                    <div class="feedback-task" id="feedback-${mission.id}">
                        <div class="feedback-task-icon">${type.icon}</div>
                        <div class="feedback-task-text">${type.title}${mission.data.desc ? ': ' + mission.data.desc : ''}</div>
                        <div class="feedback-btns">
                            <button class="feedback-btn success" onclick="markMissionDone('${mission.id}')">Reussi</button>
                            <button class="feedback-btn pending" onclick="markMissionPending('${mission.id}')">En cours</button>
                        </div>
                    </div>
                    ${mission.type === 'sell_item' ? `
                        <div class="sale-amount-input" id="amount-${mission.id}">
                            <span>Vendu pour</span>
                            <input type="number" id="amount-input-${mission.id}" placeholder="${mission.data.price || 50}" value="${mission.data.price || 50}">
                            <span>EUR</span>
                            <button class="feedback-btn success" onclick="confirmSale('${mission.id}')">OK</button>
                        </div>
                    ` : ''}
                `;
            }).join('');
        }

        function markMissionDone(missionId) {
            const mission = daySimState.missions.find(m => m.id === missionId);
            if (!mission) return;
            if (mission.type === 'sell_item') {
                const amountEl = document.getElementById(`amount-${missionId}`);
                if (amountEl) amountEl.classList.add('show');
            } else {
                mission.status = 'completed';
                const el = document.getElementById(`feedback-${missionId}`);
                if (el) el.style.opacity = '0.5';

                // Add economies for food missions
                if (mission.type === 'meal_prep' || mission.type === 'batch_cook') {
                    const savings = mission.type === 'meal_prep' ? 30 : 15;
                    daySimState.economiesTotal += savings;
                    mission.earnedAmount = savings;
                    updateProgressDisplay();
                    checkBadges();
                    showToast(`${missionTypes[mission.type].title} complete! +${savings}â‚¬ d'economies`);
                } else {
                    showToast(`${missionTypes[mission.type].title} complete!`);
                }
            }
        }

        function confirmSale(missionId) {
            const mission = daySimState.missions.find(m => m.id === missionId);
            if (!mission) return;
            const amountInput = document.getElementById(`amount-input-${missionId}`);
            const amount = amountInput ? parseInt(amountInput.value) || 50 : 50;

            // Save old remaining for recalcul toast
            const oldRemaining = recalculatePlan().remaining;

            mission.status = 'completed';
            mission.earnedAmount = amount;
            daySimState.soldTotal += amount;
            const el = document.getElementById(`feedback-${missionId}`);
            if (el) el.style.opacity = '0.5';

            // Update progression and show recalcul
            updateProgressDisplay();
            showRecalculToast(oldRemaining);
            checkBadges();

            showToast(`Vendu pour ${amount}â‚¬!`);
            updateOpikTraces([{ name: 'mission_sale_confirmed', duration: '23ms' }, { name: `earned_${amount}EUR`, duration: '8ms' }]);
        }

        function markMissionPending(missionId) {
            const mission = daySimState.missions.find(m => m.id === missionId);
            if (!mission) return;
            mission.day = daySimState.currentDay; // Move to today
            const el = document.getElementById(`feedback-${missionId}`);
            if (el) el.innerHTML = `<span style="color:var(--color-warning);">Reporte a aujourd'hui</span>`;
        }

        function generateDailyMissions() {
            const today = daySimState.currentDay;
            const energy = daySimState.selectedEnergyScore || 60;
            const newMissions = [];
            const isSunday = today % 7 === 0;
            // Mission 1: Meal prep or batch cook
            if (energy >= 50) {
                newMissions.push({
                    id: `mission_${Date.now()}_food`,
                    type: isSunday ? 'meal_prep' : 'batch_cook',
                    day: today,
                    status: 'pending',
                    data: { desc: isSunday ? 'Preparer les repas de la semaine' : 'Cuisiner pour 4 jours', reward: '~30 EUR economies' }
                });
            }
            // Mission 2: Local event if city is set
            if (daySimState.userCity && cityData[daySimState.userCity]) {
                const venteItems = cityData[daySimState.userCity].suggestions.vente || [];
                if (venteItems.length > 0) {
                    const randomVente = venteItems[Math.floor(Math.random() * venteItems.length)];
                    newMissions.push({
                        id: `mission_${Date.now()}_local`,
                        type: 'local_event',
                        day: today,
                        status: 'pending',
                        data: { desc: randomVente, reward: '' }
                    });
                }
            }
            // Mission 3: Contact lead if skills exist
            if (userAnswers.skills && energy >= 60) {
                newMissions.push({
                    id: `mission_${Date.now()}_contact`,
                    type: 'contact_lead',
                    day: today,
                    status: 'pending',
                    data: { desc: 'Contacter ecole ou entreprise locale', reward: '20-40 EUR/h potentiel' }
                });
            }
            // Add to state and return max 3
            const toAdd = newMissions.slice(0, 3);
            daySimState.missions.push(...toAdd);
            return toAdd;
        }

        function renderTodayMissions() {
            const container = document.getElementById('todayMissions');
            const todayMissions = generateDailyMissions();
            if (todayMissions.length === 0) {
                container.innerHTML = '<p class="feedback-empty">Pas de missions pour aujourd\'hui. Repose-toi!</p>';
                return;
            }
            container.innerHTML = todayMissions.map(mission => {
                const type = missionTypes[mission.type];
                return `
                    <div class="mission-card ${type.cardClass}">
                        <div class="mission-icon">${type.icon}</div>
                        <div class="mission-info">
                            <div class="mission-title">${type.title}</div>
                            <div class="mission-desc">${mission.data.desc || ''}</div>
                        </div>
                        <div class="mission-reward">${mission.data.reward || ''}</div>
                    </div>
                `;
            }).join('');
        }

        function completeDailyCheckin() {
            daySimState.todayEnergyChecked = true;
            document.getElementById('dailyPopupOverlay').classList.remove('show');
            updateNextDayButton();
            updateMissionsHistory();
            // Check triggers
            checkEnergyTriggers();
            // Check badges
            checkBadges();
            // Update progression display
            updateProgressDisplay();
            // Opik trace
            updateOpikTraces([
                { name: 'daily_checkin_complete', duration: '34ms' },
                { name: `day_${daySimState.currentDay}_energy_${daySimState.selectedEnergyScore}`, duration: '12ms' }
            ]);
            // Show Action Hub instead of toast
            setTimeout(() => showActionHub(), 300);
        }

        function updateMissionsHistory() {
            const completed = daySimState.missions.filter(m => m.status === 'completed');
            const earnings = completed.filter(m => m.earnedAmount).reduce((sum, m) => sum + m.earnedAmount, 0);
            const completedEl = document.getElementById('missionsCompleted');
            const earningsEl = document.getElementById('missionsEarnings');
            if (completedEl) completedEl.textContent = completed.length;
            if (earningsEl) earningsEl.textContent = `${earnings} EUR`;
        }

        // ========== MISSION MANAGEMENT ==========
        function validateMission(id, amount) {
            const item = document.querySelector(`.history-item[data-id="${id}"]`);
            if (!item) return;

            // Update UI
            item.classList.remove('pending');
            item.classList.add('completed');

            const result = item.querySelector('.history-item-result');
            if (result) {
                result.classList.add('earned');
                result.textContent = amount > 0 ? `+${amount}â‚¬` : 'OK';
            }

            // Remove validate button, keep delete
            const validateBtn = item.querySelector('.mission-btn.validate');
            if (validateBtn) validateBtn.remove();

            // Add to earnings
            if (amount > 0) {
                daySimState.soldTotal += amount;
            }

            updateProgressDisplay();
            showToast(`Mission validÃ©e! ${amount > 0 ? '+' + amount + 'â‚¬' : ''}`);
            updateOpikTraces([{ name: 'mission_validated', duration: '15ms', input: id }]);
        }

        function deleteMission(id) {
            const item = document.querySelector(`.history-item[data-id="${id}"]`);
            if (!item) return;

            item.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => item.remove(), 300);

            showToast('Mission supprimÃ©e');
            updateOpikTraces([{ name: 'mission_deleted', duration: '10ms', input: id }]);
        }

        function renderSwipeMissions() {
            const missions = daySimState.swipeMissions || [];
            const section = document.getElementById('swipeMissionsSection');
            const list = document.getElementById('swipeMissionsList');
            const count = document.getElementById('swipeMissionsCount');

            if (missions.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            count.textContent = missions.length;

            // Calculate progress
            const completed = missions.filter(m => m.status === 'completed').length;
            const total = missions.length;
            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

            // Calculate earned amount from completed missions
            let earnedAmount = 0;
            missions.filter(m => m.status === 'completed').forEach(m => {
                const match = m.value.match(/\+?(\d+)/);
                if (match) earnedAmount += parseInt(match[1]);
            });

            // Progress bar HTML
            const progressBarHtml = `
                <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #94a3b8;">Progression missions</span>
                        <span style="font-size: 12px; font-weight: 600; color: #22c55e;">${completed}/${total} = +${earnedAmount}â‚¬</span>
                    </div>
                    <div style="height: 8px; background: #334155; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${progressPercent}%; background: linear-gradient(90deg, #22c55e, #16a34a); transition: width 0.3s ease;"></div>
                    </div>
                    <div style="margin-top: 6px; font-size: 11px; color: #64748b; text-align: center;">
                        Target: 500â‚¬ | Restant: ${Math.max(0, 500 - earnedAmount)}â‚¬
                    </div>
                </div>
            `;

            list.innerHTML = progressBarHtml + missions.map(m => `
                <div class="swipe-mission-item ${m.status === 'completed' ? 'completed' : ''}" data-id="${m.id}">
                    <span class="swipe-mission-icon">${m.icon}</span>
                    <div class="swipe-mission-info">
                        <div class="swipe-mission-title">${m.title}</div>
                        <div class="swipe-mission-value">${m.value}</div>
                    </div>
                    <div class="history-item-actions">
                        ${m.status !== 'completed' ? `
                            <button class="mission-btn validate" onclick="validateSwipeMission(${m.id})">âœ“</button>
                        ` : ''}
                        <button class="mission-btn delete" onclick="deleteSwipeMission(${m.id})">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        function validateSwipeMission(id) {
            const missions = daySimState.swipeMissions || [];
            const mission = missions.find(m => m.id === id);
            if (!mission) return;

            mission.status = 'completed';

            // Parse value and add to earnings
            const valueMatch = mission.value.match(/\+?(\d+)/);
            let amount = 0;
            if (valueMatch) {
                amount = parseInt(valueMatch[1]);
                daySimState.jobsTotal += amount;
            }

            // Calculate total progress for toast
            const completed = missions.filter(m => m.status === 'completed').length;
            const total = missions.length;
            let totalEarned = 0;
            missions.filter(m => m.status === 'completed').forEach(m => {
                const match = m.value.match(/\+?(\d+)/);
                if (match) totalEarned += parseInt(match[1]);
            });

            renderSwipeMissions();
            updateProgressDisplay();
            showToast(`âœ… Mission validÃ©e! ${completed}/${total} missions = +${totalEarned}â‚¬ sur 500â‚¬`);
            updateOpikTraces([{ name: 'swipe_mission_validated', duration: '20ms', input: mission.title }]);
        }

        function deleteSwipeMission(id) {
            daySimState.swipeMissions = (daySimState.swipeMissions || []).filter(m => m.id !== id);
            renderSwipeMissions();
            showToast('Mission supprimÃ©e');
        }

        function checkEnergyTriggers() {
            const history = daySimState.energyHistory;
            if (history.length < 3) return;
            // Energy Debt: 3 consecutive days < 40%
            const lastThree = history.slice(-3);
            const allLow = lastThree.every(h => h.score < 40);
            if (allLow) {
                addNotification('âš ï¸', 'Energy Debt detecte! Prends soin de toi.', 'Now', 2, 'warning');
                showToast('âš ï¸ Energy Debt: Cible reduite automatiquement');
            }
            // Comeback Mode: energy > 70% after 3+ days < 40%
            if (history.length >= 4) {
                const prevThree = history.slice(-4, -1);
                const current = history[history.length - 1];
                const wasLow = prevThree.every(h => h.score < 40);
                if (wasLow && current.score > 70) {
                    addNotification('ðŸ”¥', 'Comeback Mode active! Tu es pret!', 'Now', 2, 'success');
                    showToast('ðŸ”¥ Comeback Mode: Plan de rattrapage disponible!');
                }
            }
        }

        // ========== RECALCUL & PROGRESSION ==========
        function recalculatePlan() {
            const goal = daySimState.goalAmount;
            const earned = daySimState.soldTotal + daySimState.economiesTotal + daySimState.jobsTotal;
            const remaining = Math.max(0, goal - earned);
            const daysLeft = daySimState.totalDays - daySimState.currentDay;
            const weeksLeft = Math.ceil(daysLeft / 7);
            const newWeeklyTarget = weeksLeft > 0 ? Math.ceil(remaining / weeksLeft) : 0;
            const progress = Math.round((earned / goal) * 100);

            return {
                goal,
                earned,
                remaining,
                weeksLeft,
                newWeeklyTarget,
                progress: Math.min(100, progress)
            };
        }

        function updateProgressDisplay() {
            const plan = recalculatePlan();

            // Update header mini progress
            const miniPercent = document.getElementById('progressMiniPercent');
            const miniFill = document.getElementById('progressMiniFill');
            const tooltipAmount = document.getElementById('progressTooltipAmount');
            const tooltipSales = document.getElementById('progressTooltipSales');
            const tooltipSavings = document.getElementById('progressTooltipSavings');
            const tooltipJobs = document.getElementById('progressTooltipJobs');

            if (miniPercent) miniPercent.textContent = `${plan.progress}%`;
            if (miniFill) miniFill.style.width = `${plan.progress}%`;
            if (tooltipAmount) tooltipAmount.textContent = `${plan.earned}â‚¬ / ${plan.goal}â‚¬`;
            if (tooltipSales) tooltipSales.textContent = `${daySimState.soldTotal}â‚¬`;
            if (tooltipSavings) tooltipSavings.textContent = `${daySimState.economiesTotal}â‚¬`;
            if (tooltipJobs) tooltipJobs.textContent = `${daySimState.jobsTotal}â‚¬`;

            // Update timeline hero
            updateTimeline();
        }

        // ========== TIMELINE HERO ==========
        // Difficulty zones definition (based on Setup events)
        const difficultyZones = [
            { start: 0, end: 25, level: 'high', label: 'ðŸ“š Exams' },      // S1-S2
            { start: 25, end: 50, level: 'low', label: 'ðŸ˜Œ Cool' },       // S3-S4
            { start: 50, end: 62.5, level: 'medium', label: 'ðŸ’» Projet' }, // S5
            { start: 62.5, end: 100, level: 'low', label: 'ðŸ–ï¸ Vacances' } // S6-S8
        ];

        function getCurrentDifficultyZone(timePercent) {
            for (const zone of difficultyZones) {
                if (timePercent >= zone.start && timePercent < zone.end) {
                    return zone;
                }
            }
            return difficultyZones[difficultyZones.length - 1];
        }

        function updateTimeline() {
            const plan = recalculatePlan();
            const totalDays = 56; // 8 semaines
            const totalWeeks = 8;
            const currentDay = daySimState.currentDay;
            const currentWeek = Math.ceil(currentDay / 7);

            // Calculate time percentage
            const timePercent = Math.min(100, (currentDay / totalDays) * 100);

            // Update time progress bar
            const timeProgress = document.getElementById('timelineTimeProgress');
            if (timeProgress) timeProgress.style.width = `${timePercent}%`;

            // Update time value label
            const timeValue = document.getElementById('timelineTimeValue');
            if (timeValue) timeValue.textContent = `S${currentWeek}/${totalWeeks}`;

            // Update week markers - highlight current
            document.querySelectorAll('.week-marker').forEach(marker => {
                marker.classList.remove('current');
            });
            const currentMarker = document.querySelector(`.week-marker:nth-child(${currentWeek})`);
            if (currentMarker) currentMarker.classList.add('current');

            // Update capacity progress (shows position on difficulty track)
            const capacityProgress = document.getElementById('timelineCapacityProgress');
            if (capacityProgress) capacityProgress.style.width = `${timePercent}%`;

            // Update character position (follows time, not money)
            const character = document.getElementById('timelineCharacter');
            if (character) {
                const charPosition = Math.max(0, Math.min(95, timePercent - 2));
                character.style.left = `${charPosition}%`;

                // Change emoji based on current zone difficulty
                const currentZone = getCurrentDifficultyZone(timePercent);
                const charEmoji = character.querySelector('.char-emoji');
                if (charEmoji) {
                    if (plan.progress >= 100) {
                        charEmoji.textContent = 'ðŸ†';
                    } else if (currentZone.level === 'high') {
                        charEmoji.textContent = 'ðŸ˜“'; // Struggling in difficult period
                    } else if (currentZone.level === 'medium') {
                        charEmoji.textContent = 'ðŸš¶'; // Walking in medium period
                    } else {
                        charEmoji.textContent = 'ðŸƒ'; // Running in easy period
                    }
                }
            }

            // Update current capacity indicator
            const currentCapacity = document.getElementById('currentCapacity');
            const currentZone = getCurrentDifficultyZone(timePercent);
            if (currentCapacity) {
                // Calculate available capacity based on zone
                let capacity = 100;
                if (currentZone.level === 'high') capacity = 40;
                else if (currentZone.level === 'medium') capacity = 65;
                else capacity = 90;

                currentCapacity.textContent = `${capacity}%`;
                currentCapacity.className = `capacity-indicator ${currentZone.level}`;
            }

            // Update stats
            const timelineEarned = document.getElementById('timelineEarned');
            const timelineRemaining = document.getElementById('timelineRemaining');
            const timelineWeeksLeft = document.getElementById('timelineWeeksLeft');
            const timelineStatus = document.getElementById('timelineStatus');

            if (timelineEarned) timelineEarned.textContent = `${plan.earned}â‚¬`;
            if (timelineRemaining) timelineRemaining.textContent = `${plan.remaining}â‚¬`;

            // Calculate weeks left
            const daysLeft = totalDays - currentDay;
            const weeksLeft = Math.ceil(daysLeft / 7);
            if (timelineWeeksLeft) timelineWeeksLeft.textContent = `${weeksLeft} sem`;

            // Calculate status (comparing progress vs time)
            if (timelineStatus) {
                const expectedProgress = timePercent; // Should have earned this % of goal by now
                const actualProgress = plan.progress;
                const diff = actualProgress - expectedProgress;

                if (diff >= 10) {
                    timelineStatus.textContent = 'En avance ðŸš€';
                    timelineStatus.className = 'timeline-stat-value good';
                } else if (diff >= -10) {
                    timelineStatus.textContent = 'Ã€ l\'heure âœ“';
                    timelineStatus.className = 'timeline-stat-value';
                } else {
                    timelineStatus.textContent = 'En retard âš ï¸';
                    timelineStatus.className = 'timeline-stat-value warning';
                }
            }

            // Add Opik trace for timeline update
            updateOpikTraces([{ name: 'timeline_updated', duration: '8ms' }]);
        }

        function showRecalculToast(oldRemaining) {
            const plan = recalculatePlan();
            const details = document.getElementById('recalculDetails');
            if (details) {
                details.textContent = `Reste: ${plan.remaining}â‚¬ (vs ${oldRemaining}â‚¬) â€¢ Cible/semaine: ${plan.newWeeklyTarget}â‚¬`;
            }
            const toast = document.getElementById('recalculToast');
            if (toast) {
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 4000);
            }
            updateOpikTraces([
                { name: 'plan_recalculated', duration: '89ms' },
                { name: `progress_${plan.progress}%`, duration: '12ms' }
            ]);
        }

        // ========== ACTION HUB ==========
        function showActionHub() {
            const plan = recalculatePlan();

            // Update action hub content
            const hubDay = document.getElementById('actionHubDay');
            const hubPercent = document.getElementById('actionHubPercent');
            const hubFill = document.getElementById('actionHubProgressFill');
            const hubText = document.getElementById('actionHubProgressText');

            if (hubDay) hubDay.textContent = daySimState.currentDay;
            if (hubPercent) hubPercent.textContent = `${plan.progress}%`;
            if (hubFill) hubFill.style.width = `${plan.progress}%`;
            if (hubText) {
                let extra = '';
                if (daySimState.soldTotal > 0) extra = ` (+${daySimState.soldTotal}â‚¬ de ventes!)`;
                hubText.textContent = `${plan.earned}â‚¬ / ${plan.goal}â‚¬${extra}`;
            }

            document.getElementById('actionHubOverlay').classList.add('show');

            updateOpikTraces([
                { name: 'action_hub_shown', duration: '23ms' }
            ]);
        }

        function closeActionHub() {
            document.getElementById('actionHubOverlay').classList.remove('show');
        }

        function handleActionChoice(action) {
            closeActionHub();

            updateOpikTraces([
                { name: `action_hub_choice_${action}`, duration: '15ms' }
            ]);

            switch(action) {
                case 'swipe':
                    switchCase(1); // Mon Plan
                    setTimeout(() => switchPlanTab('swipe'), 100);
                    break;
                case 'skills':
                    switchCase(1); // Mon Plan
                    setTimeout(() => {
                        switchPlanTab('arbitrage');
                    }, 100);
                    break;
                case 'inventory':
                    switchCase(1); // Mon Plan
                    setTimeout(() => switchPlanTab('inventory'), 100);
                    break;
                case 'setup':
                    switchCase(1); // Mon Plan
                    setTimeout(() => switchPlanTab('setup'), 100);
                    break;
                case 'calendar':
                    switchCase(2); // Go to Suivi
                    break;
            }

            showToast(`Navigation vers: ${action}`);
            addNotification('ðŸŽ¯', `Action choisie: ${action}`, 'Now', 2, 'info');
        }

        // ========== BADGES SYSTEM ==========
        const badgesConfig = {
            amount33: { icon: 'ðŸ¥‰', title: 'Premier Palier', message: 'Premier tiers! 166â‚¬ recoltes!' },
            amount66: { icon: 'ðŸ¥ˆ', title: 'Deuxieme Palier', message: 'Deux tiers! 333â‚¬ recoltes!' },
            amount100: { icon: 'ðŸ¥‡', title: 'Objectif Atteint', message: 'Bravo! Objectif de 500â‚¬ atteint!' },
            time33: { icon: 'â±ï¸', title: 'Premier Sprint', message: 'Premier sprint termine!' },
            time66: { icon: 'â³', title: 'Mi-Parcours', message: 'Mi-parcours atteint!' },
            time100: { icon: 'ðŸ', title: 'Ligne d\'Arrivee', message: 'Tu as tenu jusqu\'au bout!' }
        };

        function calculateEffectiveTime() {
            const weeklyCapacity = daySimState.weeklyCapacity;
            const totalWeight = weeklyCapacity.reduce((a, b) => a + b, 0);

            const currentWeek = Math.ceil(daySimState.currentDay / 7);
            const passedWeight = weeklyCapacity.slice(0, currentWeek).reduce((a, b) => a + b, 0);

            const effectiveProgress = passedWeight / totalWeight;

            return {
                effectiveProgress,
                totalWeight,
                passedWeight,
                tier1: totalWeight / 3,
                tier2: (totalWeight / 3) * 2,
                currentWeek
            };
        }

        function checkBadges() {
            const plan = recalculatePlan();
            const timeInfo = calculateEffectiveTime();
            const badgesToUnlock = [];

            // Check amount badges
            if (!daySimState.badges.amount33 && plan.progress >= 33) {
                daySimState.badges.amount33 = true;
                badgesToUnlock.push('amount33');
            }
            if (!daySimState.badges.amount66 && plan.progress >= 66) {
                daySimState.badges.amount66 = true;
                badgesToUnlock.push('amount66');
            }
            if (!daySimState.badges.amount100 && plan.progress >= 100) {
                daySimState.badges.amount100 = true;
                badgesToUnlock.push('amount100');
            }

            // Check time badges (based on effective time)
            const effectivePercent = timeInfo.effectiveProgress * 100;
            if (!daySimState.badges.time33 && effectivePercent >= 33) {
                daySimState.badges.time33 = true;
                badgesToUnlock.push('time33');
            }
            if (!daySimState.badges.time66 && effectivePercent >= 66) {
                daySimState.badges.time66 = true;
                badgesToUnlock.push('time66');
            }
            if (!daySimState.badges.time100 && effectivePercent >= 100) {
                daySimState.badges.time100 = true;
                badgesToUnlock.push('time100');
            }

            // Update badge display in Track
            renderBadges();

            // Show unlock animation for new badges
            if (badgesToUnlock.length > 0) {
                badgesToUnlock.forEach((badge, idx) => {
                    setTimeout(() => showBadgeUnlock(badge), idx * 2000);
                });
            }
        }

        function renderBadges() {
            // Update each badge element
            Object.keys(daySimState.badges).forEach(badgeId => {
                const el = document.getElementById(`badge-${badgeId}`);
                if (el) {
                    if (daySimState.badges[badgeId]) {
                        el.classList.remove('locked');
                        el.classList.add('unlocked');
                        const check = el.querySelector('.badge-check');
                        if (check) check.style.display = 'block';
                    }
                }
            });
        }

        function showBadgeUnlock(badgeId) {
            const config = badgesConfig[badgeId];
            if (!config) return;

            const overlay = document.getElementById('badgeUnlockOverlay');
            const icon = document.getElementById('badgeUnlockIcon');
            const title = document.getElementById('badgeUnlockTitle');
            const message = document.getElementById('badgeUnlockMessage');

            if (icon) icon.textContent = config.icon;
            if (title) title.textContent = config.title;
            if (message) message.textContent = config.message;

            overlay.classList.add('show');

            updateOpikTraces([
                { name: `badge_unlocked_${badgeId}`, duration: '34ms' }
            ]);

            addNotification('ðŸ†', `Badge debloque: ${config.title}`, 'Now', 2, 'success');
        }

        function closeBadgeUnlock() {
            document.getElementById('badgeUnlockOverlay').classList.remove('show');
        }

        // ========== DAY SIMULATOR ==========
        function canAdvanceDay() {
            const blockers = [];
            if (!daySimState.onboardingComplete) blockers.push("Complete ton profil d'abord");
            if (!daySimState.todayEnergyChecked) blockers.push("Fais ton check-in energie");
            return { canAdvance: blockers.length === 0, blockers };
        }

        function updateNextDayButton() {
            const btn = document.getElementById('nextDayBtn');
            const { canAdvance, blockers } = canAdvanceDay();
            btn.disabled = !canAdvance;
            btn.title = canAdvance ? 'Passer au jour suivant' : blockers.join(' | ');
        }

        function advanceDay() {
            const { canAdvance, blockers } = canAdvanceDay();
            if (!canAdvance) {
                showToast(blockers[0]);
                return;
            }

            // Reset for new day
            daySimState.todayEnergyChecked = false;
            daySimState.currentDay++;

            // Update display
            document.getElementById('dayCounter').textContent = daySimState.currentDay;

            // Add Opik trace
            updateOpikTraces([
                { name: 'day_advance', duration: '18ms' },
                { name: `day_${daySimState.currentDay}_start`, duration: '8ms' }
            ]);

            // Show energy popup for new day
            showEnergyCheckPopup();
        }

        // ========== PLAN TABS ==========
        function switchPlanTab(tab) {
            const tabs = ['setup', 'arbitrage', 'inventory', 'lifestyle', 'trade', 'swipe'];

            // Update tab buttons
            document.querySelectorAll('.plan-tab').forEach((t, i) => {
                t.classList.toggle('active', tabs[i] === tab);
            });

            // Update tab content
            tabs.forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (el) el.classList.toggle('active', t === tab);
            });

            // Add trace
            updateOpikTraces([{ name: `tab_switch_${tab}`, duration: '5ms' }]);
        }

        // ========== INVENTORY FUNCTIONS ==========
        function postItem(itemId) {
            const itemEl = document.querySelector(`.inventory-item[data-id="${itemId}"]`);
            if (itemEl) {
                itemEl.classList.add('posted');
                itemEl.querySelector('.inventory-btn.post').outerHTML = '<button class="inventory-btn sold" onclick="markSold(\'' + itemId + '\')">Vendu!</button>';
            }
            showToast('Annonce postee!');
            updateOpikTraces([{ name: 'inventory_item_posted', duration: '18ms' }]);
            // Add mission for tomorrow to check sale
            daySimState.missions.push({
                id: `mission_${Date.now()}_sell`,
                type: 'sell_item',
                day: daySimState.currentDay + 1,
                status: 'pending',
                data: { desc: 'Verifier annonce', price: 50 }
            });
        }

        function markSold(itemId) {
            const itemEl = document.querySelector(`.inventory-item[data-id="${itemId}"]`);
            const priceEl = itemEl ? itemEl.querySelector('.inventory-price') : null;
            const saleAmount = priceEl ? parseInt(priceEl.textContent.replace(/[^0-9]/g, '')) || 50 : 50;

            // Save old remaining for recalcul toast
            const oldRemaining = recalculatePlan().remaining;

            if (itemEl) {
                itemEl.classList.remove('posted');
                itemEl.classList.add('sold');
                itemEl.querySelector('.inventory-actions').innerHTML = '<span style="color:var(--color-success);font-weight:600;">Vendu!</span>';
            }
            daySimState.soldTotal += saleAmount;

            // Update progression and show recalcul
            updateProgressDisplay();
            showRecalculToast(oldRemaining);
            checkBadges();

            showToast(`Item vendu! +${saleAmount}â‚¬`);
            updateOpikTraces([
                { name: 'inventory_item_sold', duration: '23ms' },
                { name: `sold_${saleAmount}EUR`, duration: '8ms' }
            ]);
            updateInventoryTotal();
        }

        function removeItem(itemId) {
            const itemEl = document.querySelector(`.inventory-item[data-id="${itemId}"]`);
            if (itemEl) itemEl.remove();
            showToast('Item retire');
            updateInventoryTotal();
        }

        function updateInventoryTotal() {
            const items = document.querySelectorAll('.inventory-item:not(.sold)');
            let total = 0;
            items.forEach(item => {
                const priceEl = item.querySelector('.inventory-price');
                if (priceEl) {
                    const price = parseInt(priceEl.textContent.replace(/[^0-9]/g, '')) || 0;
                    total += price;
                }
            });
            const el = document.getElementById('inventoryTotalValue');
            if (el) el.textContent = `${total} EUR (${daySimState.soldTotal} EUR vendus)`;
        }

        // ========== ADD ITEM CHAT ==========
        let addItemStep = 0;
        let addItemData = { name: '', category: '', condition: '', price: 0 };

        function openAddItemChat() {
            addItemStep = 0;
            addItemData = { name: '', category: '', condition: '', price: 0 };
            document.getElementById('addItemChat').classList.add('show');
            document.getElementById('addItemMessages').innerHTML = `
                <div class="add-item-msg bot">Qu'est-ce que tu veux vendre? (ex: iPhone, vetements, livres...)</div>
            `;
            document.getElementById('addItemInput').value = '';
            document.getElementById('addItemInput').focus();
            updateOpikTraces([{ name: 'add_item_chat_opened', duration: '5ms' }]);
        }

        function closeAddItemChat() {
            document.getElementById('addItemChat').classList.remove('show');
        }

        function handleAddItemKeypress(e) {
            if (e.key === 'Enter') sendAddItemMessage();
        }

        function sendAddItemMessage() {
            const input = document.getElementById('addItemInput');
            const messages = document.getElementById('addItemMessages');
            const value = input.value.trim();
            if (!value) return;

            // Add user message
            messages.innerHTML += `<div class="add-item-msg user">${value}</div>`;
            input.value = '';

            if (addItemStep === 0) {
                // Step 1: Got item name
                addItemData.name = value;
                addItemStep = 1;
                messages.innerHTML += `
                    <div class="add-item-msg bot">C'est quel type?</div>
                    <div class="add-item-chips">
                        <div class="add-item-chip" onclick="selectItemCategory('electronique')">ðŸ“± Electronique</div>
                        <div class="add-item-chip" onclick="selectItemCategory('vetements')">ðŸ‘• Vetements</div>
                        <div class="add-item-chip" onclick="selectItemCategory('livres')">ðŸ“š Livres</div>
                        <div class="add-item-chip" onclick="selectItemCategory('autre')">ðŸ“¦ Autre</div>
                    </div>
                `;
            }
            messages.scrollTop = messages.scrollHeight;
        }

        function selectItemCategory(category) {
            addItemData.category = category;
            addItemStep = 2;
            const messages = document.getElementById('addItemMessages');
            const categoryLabels = { electronique: 'ðŸ“± Electronique', vetements: 'ðŸ‘• Vetements', livres: 'ðŸ“š Livres', autre: 'ðŸ“¦ Autre' };
            messages.innerHTML += `<div class="add-item-msg user">${categoryLabels[category]}</div>`;
            messages.innerHTML += `
                <div class="add-item-msg bot">Etat de l'objet?</div>
                <div class="add-item-chips">
                    <div class="add-item-chip" onclick="selectItemCondition('neuf')">âœ¨ Neuf</div>
                    <div class="add-item-chip" onclick="selectItemCondition('bon')">ðŸ‘ Bon etat</div>
                    <div class="add-item-chip" onclick="selectItemCondition('correct')">ðŸ‘Œ Correct</div>
                    <div class="add-item-chip" onclick="selectItemCondition('reparer')">ðŸ”§ A reparer</div>
                </div>
            `;
            messages.scrollTop = messages.scrollHeight;
        }

        function selectItemCondition(condition) {
            addItemData.condition = condition;
            addItemStep = 3;
            const messages = document.getElementById('addItemMessages');
            const conditionLabels = { neuf: 'âœ¨ Neuf', bon: 'ðŸ‘ Bon etat', correct: 'ðŸ‘Œ Correct', reparer: 'ðŸ”§ A reparer' };
            messages.innerHTML += `<div class="add-item-msg user">${conditionLabels[condition]}</div>`;

            // Calculate estimated price
            const basePrices = { electronique: 100, vetements: 30, livres: 15, autre: 25 };
            const conditionMult = { neuf: 1.5, bon: 1.0, correct: 0.6, reparer: 0.3 };
            addItemData.price = Math.round(basePrices[addItemData.category] * conditionMult[condition]);

            const platforms = { electronique: 'Leboncoin', vetements: 'Vinted', livres: 'Momox', autre: 'Leboncoin' };

            messages.innerHTML += `
                <div class="add-item-msg bot result">
                    Prix estime: <strong>~${addItemData.price} EUR</strong> sur ${platforms[addItemData.category]}
                </div>
                <div class="add-item-chips">
                    <div class="add-item-chip" onclick="confirmAddItem()" style="background:var(--color-success); color:white;">âœ“ Ajouter</div>
                    <div class="add-item-chip" onclick="closeAddItemChat()">âœ• Annuler</div>
                </div>
            `;
            messages.scrollTop = messages.scrollHeight;
        }

        function confirmAddItem() {
            const icons = { electronique: 'ðŸ“±', vetements: 'ðŸ‘•', livres: 'ðŸ“š', autre: 'ðŸ“¦' };
            const platforms = { electronique: 'Leboncoin', vetements: 'Vinted', livres: 'Momox', autre: 'Leboncoin' };
            const grid = document.getElementById('inventoryGrid');

            const newItem = document.createElement('div');
            newItem.className = 'inventory-item';
            newItem.dataset.id = `item-${Date.now()}`;
            newItem.innerHTML = `
                <div class="inventory-icon">${icons[addItemData.category]}</div>
                <div class="inventory-name">${addItemData.name}</div>
                <div class="inventory-price">~${addItemData.price} EUR</div>
                <div class="inventory-platform">${platforms[addItemData.category]}</div>
                <div class="inventory-actions">
                    <button class="inventory-btn post" onclick="postItem('${newItem.dataset.id}')">Poster</button>
                    <button class="inventory-btn remove" onclick="removeItem('${newItem.dataset.id}')">X</button>
                </div>
            `;

            grid.appendChild(newItem);
            newItem.style.animation = 'slideDown 0.3s ease';

            closeAddItemChat();
            showToast(`${addItemData.name} ajoute! (~${addItemData.price} EUR)`);
            updateOpikTraces([{ name: 'item_added_via_chat', duration: '150ms', input: addItemData.name }]);
        }

        // ========== ADD LIFESTYLE CHAT ==========
        let addLifestyleStep = 0;
        let addLifestyleData = { name: '', category: '', amount: 0, frequency: 'month' };
        let customLifestyleItems = [];

        function openAddLifestyleChat() {
            addLifestyleStep = 0;
            addLifestyleData = { name: '', category: '', amount: 0, frequency: 'month' };
            document.getElementById('addLifestyleChat').classList.add('show');
            document.getElementById('addLifestyleMessages').innerHTML = `
                <div class="add-item-msg bot">Quelle dÃ©pense rÃ©guliÃ¨re veux-tu ajouter? (ex: pressing, coiffeur, sport...)</div>
            `;
            document.getElementById('addLifestyleInput').value = '';
            document.getElementById('addLifestyleInput').focus();
            updateOpikTraces([{ name: 'add_lifestyle_chat_opened', duration: '5ms' }]);
        }

        function closeAddLifestyleChat() {
            document.getElementById('addLifestyleChat').classList.remove('show');
        }

        function handleAddLifestyleKeypress(e) {
            if (e.key === 'Enter') sendAddLifestyleMessage();
        }

        function sendAddLifestyleMessage() {
            const input = document.getElementById('addLifestyleInput');
            const messages = document.getElementById('addLifestyleMessages');
            const value = input.value.trim();
            if (!value) return;

            messages.innerHTML += `<div class="add-item-msg user">${value}</div>`;
            input.value = '';

            if (addLifestyleStep === 0) {
                addLifestyleData.name = value;
                addLifestyleStep = 1;
                messages.innerHTML += `
                    <div class="add-item-msg bot">C'est quel type de dÃ©pense?</div>
                    <div class="add-item-chips">
                        <div class="add-item-chip" onclick="selectLifestyleCategory('sante')">ðŸ’Š SantÃ©</div>
                        <div class="add-item-chip" onclick="selectLifestyleCategory('loisirs')">ðŸŽ® Loisirs</div>
                        <div class="add-item-chip" onclick="selectLifestyleCategory('soins')">ðŸ’‡ Soins/BeautÃ©</div>
                        <div class="add-item-chip" onclick="selectLifestyleCategory('autre')">ðŸ“¦ Autre</div>
                    </div>
                `;
            }
            messages.scrollTop = messages.scrollHeight;
        }

        function selectLifestyleCategory(category) {
            addLifestyleData.category = category;
            addLifestyleStep = 2;
            const messages = document.getElementById('addLifestyleMessages');
            const labels = { sante: 'ðŸ’Š SantÃ©', loisirs: 'ðŸŽ® Loisirs', soins: 'ðŸ’‡ Soins/BeautÃ©', autre: 'ðŸ“¦ Autre' };
            messages.innerHTML += `<div class="add-item-msg user">${labels[category]}</div>`;
            messages.innerHTML += `
                <div class="add-item-msg bot">Combien Ã§a te coÃ»te par mois?</div>
                <div class="add-item-chips">
                    <div class="add-item-chip" onclick="selectLifestyleAmount(10)">~10â‚¬</div>
                    <div class="add-item-chip" onclick="selectLifestyleAmount(20)">~20â‚¬</div>
                    <div class="add-item-chip" onclick="selectLifestyleAmount(30)">~30â‚¬</div>
                    <div class="add-item-chip" onclick="selectLifestyleAmount(50)">~50â‚¬</div>
                </div>
            `;
            messages.scrollTop = messages.scrollHeight;
        }

        function selectLifestyleAmount(amount) {
            addLifestyleData.amount = amount;
            addLifestyleStep = 3;
            const messages = document.getElementById('addLifestyleMessages');
            messages.innerHTML += `<div class="add-item-msg user">~${amount}â‚¬/mois</div>`;
            messages.innerHTML += `
                <div class="add-item-msg bot">Tu peux rÃ©duire ou supprimer cette dÃ©pense?</div>
                <div class="add-item-chips">
                    <div class="add-item-chip" onclick="selectLifestyleOptimizable('oui', 50)">âœ‚ï¸ RÃ©duire de 50%</div>
                    <div class="add-item-chip" onclick="selectLifestyleOptimizable('oui', 100)">ðŸš« Supprimer</div>
                    <div class="add-item-chip" onclick="selectLifestyleOptimizable('non', 0)">ðŸ”’ Non nÃ©gociable</div>
                </div>
            `;
            messages.scrollTop = messages.scrollHeight;
        }

        function selectLifestyleOptimizable(canOptimize, reduction) {
            addLifestyleData.reduction = reduction;
            const messages = document.getElementById('addLifestyleMessages');
            const savings = Math.round(addLifestyleData.amount * reduction / 100);

            if (reduction > 0) {
                messages.innerHTML += `<div class="add-item-msg user">${reduction === 100 ? 'ðŸš« Supprimer' : 'âœ‚ï¸ RÃ©duire de 50%'}</div>`;
                messages.innerHTML += `
                    <div class="add-item-msg bot result">
                        Ã‰conomie potentielle: <strong>${savings}â‚¬/mois</strong>
                    </div>
                `;
            } else {
                messages.innerHTML += `<div class="add-item-msg user">ðŸ”’ Non nÃ©gociable</div>`;
                messages.innerHTML += `
                    <div class="add-item-msg bot result">
                        OK, on garde cette dÃ©pense dans ton budget.
                    </div>
                `;
            }

            messages.innerHTML += `
                <div class="add-item-chips">
                    <div class="add-item-chip" onclick="confirmAddLifestyle()" style="background:var(--color-success); color:white;">âœ“ Ajouter</div>
                    <div class="add-item-chip" onclick="closeAddLifestyleChat()">âœ• Annuler</div>
                </div>
            `;
            messages.scrollTop = messages.scrollHeight;
        }

        function confirmAddLifestyle() {
            const icons = { sante: 'ðŸ’Š', loisirs: 'ðŸŽ®', soins: 'ðŸ’‡', autre: 'ðŸ“¦' };
            const savings = Math.round(addLifestyleData.amount * addLifestyleData.reduction / 100);

            customLifestyleItems.push({
                id: Date.now(),
                name: addLifestyleData.name,
                category: addLifestyleData.category,
                amount: addLifestyleData.amount,
                savings: savings
            });

            renderCustomLifestyleItems();
            closeAddLifestyleChat();
            updateLifestyleSavings();
            showToast(`${addLifestyleData.name} ajoutÃ©! (${savings > 0 ? '+' + savings + 'â‚¬ Ã©conomies' : 'fixe'})`);
            updateOpikTraces([{ name: 'lifestyle_item_added', duration: '120ms', input: addLifestyleData.name }]);
        }

        function renderCustomLifestyleItems() {
            const container = document.getElementById('customLifestyleItems');
            if (customLifestyleItems.length === 0) {
                container.innerHTML = '';
                return;
            }

            const icons = { sante: 'ðŸ’Š', loisirs: 'ðŸŽ®', soins: 'ðŸ’‡', autre: 'ðŸ“¦' };
            container.innerHTML = `
                <div class="lifestyle-section">
                    <div class="lifestyle-title">âœ¨ Mes dÃ©penses ajoutÃ©es</div>
                    <div class="lifestyle-card">
                        ${customLifestyleItems.map(item => `
                            <div class="custom-lifestyle-item">
                                <span class="custom-item-icon">${icons[item.category]}</span>
                                <span class="custom-item-name">${item.name}</span>
                                <span class="custom-item-amount">${item.amount}â‚¬/mois</span>
                                ${item.savings > 0 ? `<span class="custom-item-savings">-${item.savings}â‚¬</span>` : '<span class="custom-item-fixed">fixe</span>'}
                                <button class="custom-item-remove" onclick="removeCustomLifestyle(${item.id})">Ã—</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function removeCustomLifestyle(id) {
            customLifestyleItems = customLifestyleItems.filter(item => item.id !== id);
            renderCustomLifestyleItems();
            updateLifestyleSavings();
            showToast('DÃ©pense supprimÃ©e');
        }

        // ========== LIFESTYLE FUNCTIONS ==========
        const lifestyleState = {
            housing: 'seul',
            food: 'standard',
            mealprep: 'non',
            transport: 'transports',
            subs: ['netflix', 'spotify']
        };

        function selectLifestyle(category, value, el) {
            lifestyleState[category] = value;
            // Update UI
            el.parentElement.querySelectorAll('.lifestyle-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            updateLifestyleSavings();
            updateOpikTraces([{ name: `lifestyle_${category}_changed`, duration: '10ms', input: value }]);
        }

        function toggleLifestyleSub(sub, el) {
            const idx = lifestyleState.subs.indexOf(sub);
            if (idx > -1) {
                lifestyleState.subs.splice(idx, 1);
                el.classList.remove('selected');
            } else {
                lifestyleState.subs.push(sub);
                el.classList.add('selected');
            }
            updateLifestyleSavings();
            updateOpikTraces([{ name: 'lifestyle_sub_toggled', duration: '10ms', input: sub }]);
        }

        function updateLifestyleSavings() {
            let savings = 0;
            // Housing savings
            if (lifestyleState.housing === 'coloc') savings += 150;
            if (lifestyleState.housing === 'crous') savings += 200;
            if (lifestyleState.housing === 'famille') savings += 450;
            // Food savings
            if (lifestyleState.mealprep === 'oui') savings += 60;
            if (lifestyleState.food === 'vegetarien') savings += 30;
            if (lifestyleState.food === 'vegan') savings += 50;
            // Transport savings
            if (lifestyleState.transport === 'velo') savings += 80;
            if (lifestyleState.transport === 'pied') savings += 86;
            // Subs savings (for removed subs)
            const subPrices = { netflix: 9, spotify: 4, gym: 30, disney: 9 };
            if (!lifestyleState.subs.includes('netflix')) savings += subPrices.netflix;
            if (!lifestyleState.subs.includes('spotify')) savings += subPrices.spotify;

            // Custom lifestyle items savings
            const customSavings = customLifestyleItems.reduce((sum, item) => sum + item.savings, 0);
            savings += customSavings;

            document.getElementById('lifestyleSavings').textContent = `~${savings}â‚¬/mois`;
        }

        // ========== TRADE FUNCTIONS ==========
        const tradeState = {
            tent: 'buy',
            sleeping: 'buy',
            stove: 'buy'
        };

        function openAddTradeChat() {
            document.getElementById('addTradeChat').classList.add('show');
            document.getElementById('addTradeMessages').innerHTML = `
                <div class="add-trade-msg bot">De quoi as-tu besoin pour ton objectif?</div>
            `;
            document.getElementById('addTradeInput').value = '';
            document.getElementById('addTradeInput').focus();
            updateOpikTraces([{ name: 'add_trade_chat_opened', duration: '5ms' }]);
        }

        function closeAddTradeChat() {
            document.getElementById('addTradeChat').classList.remove('show');
        }

        function handleAddTradeKeypress(e) {
            if (e.key === 'Enter') sendAddTradeMessage();
        }

        function sendAddTradeMessage() {
            const input = document.getElementById('addTradeInput');
            const messages = document.getElementById('addTradeMessages');
            const value = input.value.trim();
            if (!value) return;

            messages.innerHTML += `<div class="add-trade-msg user">${value}</div>`;
            input.value = '';

            // Simulate AI response
            setTimeout(() => {
                messages.innerHTML += `
                    <div class="add-trade-msg bot">
                        "${value}" ajoute! Prix estime: ~50â‚¬.<br>
                        Tu peux choisir: Acheter, Emprunter ou Troquer.
                    </div>
                `;
                messages.scrollTop = messages.scrollHeight;
                showToast(`${value} ajoute aux besoins!`);
            }, 500);

            updateOpikTraces([{ name: 'trade_need_added', duration: '100ms', input: value }]);
        }

        function selectTradeOption(item, option, el) {
            tradeState[item] = option;
            // Update UI
            el.parentElement.querySelectorAll('.trade-option').forEach(opt => {
                opt.classList.remove('selected', 'buy');
            });
            el.classList.add('selected');
            if (option === 'buy') el.classList.add('buy');

            updateTradeSavings();
            updateOpikTraces([{ name: `trade_${item}_option`, duration: '10ms', input: option }]);
        }

        function updateTradeSavings() {
            const prices = { tent: 80, sleeping: 40, stove: 25 };
            let totalBuy = 0;
            Object.keys(tradeState).forEach(item => {
                if (tradeState[item] === 'buy') totalBuy += prices[item];
            });
            const savings = 145 - totalBuy;
            const newGoal = 500 - savings;
            document.getElementById('tradeSavings').textContent = `${savings}â‚¬`;
            document.querySelector('.trade-recalculate-btn').textContent = `Recalculer mon objectif â†’ ${newGoal}â‚¬`;
        }

        function recalculateWithTrade() {
            const prices = { tent: 80, sleeping: 40, stove: 25 };
            let savings = 0;
            Object.keys(tradeState).forEach(item => {
                if (tradeState[item] !== 'buy') savings += prices[item];
            });

            if (savings > 0) {
                const newGoal = 500 - savings;
                daySimState.goalAmount = newGoal;
                document.getElementById('goalAmount').value = newGoal;
                showToast(`Objectif recalcule: ${newGoal}â‚¬ (economie de ${savings}â‚¬ en equipements!)`);
                updateOpikTraces([{ name: 'goal_recalculated_trade', duration: '50ms', input: `${savings}â‚¬ saved` }]);
            } else {
                showToast('Aucune economie - tous les items sont en "Acheter"');
            }
        }

        function updateLocalSuggestions() {
            const city = daySimState.userCity;
            const container = document.getElementById('localSuggestions');
            if (!city || !cityData[city] || !container) return;
            const suggestions = cityData[city].suggestions.vente || [];
            container.innerHTML = `
                <div class="local-suggestions-title">ðŸ“ Suggestions locales (${cityData[city].name})</div>
                ${suggestions.map(s => `<div class="local-suggestion-item">â€¢ ${s}</div>`).join('')}
            `;
        }

        // ========== SETUP ==========
        function addSetupEvent() {
            const list = document.getElementById('setupEventsList');
            const week = Math.floor(Math.random() * 8) + 1;
            const events = ['Examen', 'Projet', 'Stage', 'Entretien'];
            const event = events[Math.floor(Math.random() * events.length)];
            const item = document.createElement('div');
            item.className = 'setup-event-item';
            item.innerHTML = `<span class="event-icon">ðŸ“‹</span><span>Semaine ${week}: ${event}</span>`;
            list.appendChild(item);
            showToast('Evenement ajoute');
        }

        function completeSetup() {
            daySimState.setupComplete = true;
            showToast('Objectif configure! Decouvre les strategies.');
            switchPlanTab('arbitrage'); // Switch to Skills tab

            // Add Opik trace
            updateOpikTraces([
                { name: 'setup_complete', duration: '34ms' },
                { name: 'goal_configured', duration: '12ms' }
            ]);

            addNotification('ðŸŽ¯', 'Objectif defini! Explore les onglets.', 'Now', 1, 'success');
        }

        // ========== START ==========
        function initDaySimulator() {
            // Show energy popup on first load
            setTimeout(() => {
                showEnergyCheckPopup();
            }, 500);
        }

        init();
        initDaySimulator();
        updateProgressDisplay();
        renderBadges();
    </script>
</body>
</html>
